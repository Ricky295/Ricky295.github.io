<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Inventory Timer</title>
    <style>
        @font-face {
            font-family: 'Minecraft';
            src: url('https://fonts.cdnfonts.com/s/14896/Minecraft.woff') format('woff');
        }

        :root {
            --mc-bg: #c6c6c6;
            --mc-border-light: #ffffff;
            --mc-border-dark: #555555;
            --mc-slot-bg: #8b8b8b;
            --mc-slot-border-dark: #373737;
            --mc-slot-border-light: #ffffff;
            --mc-button-bg: #aaaaaa;
            --base-unit: min(8.5vw, 8.5vh);
            --slot-size: calc(var(--base-unit) * 1.1);
            --border-width: calc(var(--base-unit) * 0.12);
            --mc-rarity-yellow: #ffff55;
            --mc-lore-purple: #aa00aa;
            --mc-lore-blue: #5555ff;
            --mc-lore-gray: #aaaaaa;
        }

        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Minecraft', sans-serif;
            image-rendering: pixelated;
            user-select: none;
            overflow: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M2,2 L2,22 L8,16 L14,28 L18,26 L12,14 L22,14 Z" fill="white" stroke="black" stroke-width="2"/></svg>'), auto;
        }

        #damage-vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 150px rgba(255, 0, 0, 0);
            pointer-events: none;
            z-index: 5000;
            transition: box-shadow 0.3s;
        }
        .taking-damage { animation: pulse-damage 0.5s infinite alternate; }
        @keyframes pulse-damage {
            from { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.4); }
            to   { box-shadow: inset 0 0 200px rgba(255, 0, 0, 0.8); }
        }

        /* ‚îÄ‚îÄ Notification toast ‚îÄ‚îÄ */
        #notif-toast {
            position: fixed;
            top: 18px; right: 18px;
            background: rgba(16,0,16,0.97);
            border: calc(var(--base-unit)*0.08) solid #280659;
            box-shadow: inset 0 0 15px #5511aa, 0 0 20px rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 16px;
            font-size: calc(var(--base-unit)*0.28);
            z-index: 9000;
            display: none;
            flex-direction: column;
            gap: 4px;
            min-width: 200px;
            max-width: 300px;
            animation: slide-in 0.3s ease;
        }
        #notif-toast.show { display: flex; }
        @keyframes slide-in {
            from { transform: translateX(120%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        .toast-title { color: #ffff55; font-size: 1.1em; }
        .toast-body  { color: #aaaaaa; }

        /* ‚îÄ‚îÄ Notification permission banner ‚îÄ‚îÄ */
        #perm-banner {
            position: fixed;
            bottom: 14px; left: 50%; transform: translateX(-50%);
            background: #404040;
            border: 2px solid #000;
            color: #fff;
            font-family: 'Minecraft', sans-serif;
            font-size: calc(var(--base-unit)*0.27);
            padding: 8px 16px;
            display: flex; align-items: center; gap: 12px;
            z-index: 8000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
        }
        #perm-banner button {
            background: #5a9e3a; color: #fff; border: 2px solid #000;
            font-family: 'Minecraft', sans-serif;
            padding: 4px 10px; cursor: pointer; font-size: 0.9em;
        }
        #perm-banner button:hover { background: #6dbf45; }
        #perm-dismiss { background: #666 !important; }

        #setup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .setup-menu {
            background-color: var(--mc-bg);
            border: var(--border-width) solid var(--mc-border-dark);
            border-top-color: var(--mc-border-light);
            border-left-color: var(--mc-border-light);
            padding: calc(var(--base-unit)*0.6);
            display: flex; flex-direction: column;
            gap: calc(var(--base-unit)*0.3);
            text-align: center;
            min-width: calc(var(--base-unit)*6);
        }
        .input-group { display: flex; flex-direction: column; gap: calc(var(--base-unit)*0.2); margin-bottom: calc(var(--base-unit)*0.2); }
        .row { display: flex; gap: calc(var(--base-unit)*0.1); justify-content: center; align-items: center; }
        input, select {
            font-family: 'Minecraft', sans-serif;
            background: #000; color: #fff;
            border: calc(var(--base-unit)*0.05) solid #fff;
            padding: calc(var(--base-unit)*0.1);
            font-size: calc(var(--base-unit)*0.35); outline: none;
        }
        input[type="number"]        { width: calc(var(--base-unit)*1.2); text-align: center; }
        input[type="datetime-local"] { font-size: calc(var(--base-unit)*0.25); }
        input[type="text"]          { width: calc(var(--base-unit)*4); }
        button {
            font-family: 'Minecraft', sans-serif;
            background-color: var(--mc-button-bg);
            border: calc(var(--base-unit)*0.05) solid #000;
            color: #333;
            padding: calc(var(--base-unit)*0.1) calc(var(--base-unit)*0.4);
            font-size: calc(var(--base-unit)*0.3);
            cursor: pointer;
            box-shadow: inset calc(var(--base-unit)*-0.05) calc(var(--base-unit)*-0.05) #555,
                        inset calc(var(--base-unit)*0.05)  calc(var(--base-unit)*0.05)  #eee;
        }
        button:hover { background-color: #bbbbbb; color: #000; }

        .inventory-gui {
            background-color: var(--mc-bg);
            border: var(--border-width) solid var(--mc-border-dark);
            border-top-color: var(--mc-border-light);
            border-left-color: var(--mc-border-light);
            padding: calc(var(--base-unit)*0.4);
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            gap: calc(var(--base-unit)*0.3);
            position: relative;
        }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .label { color: #404040; font-size: calc(var(--base-unit)*0.4); margin-bottom: calc(var(--base-unit)*0.05); letter-spacing: 1px; }
        .utility-bar { display: flex; gap: 10px; position: absolute; top: -50px; right: 0; }
        .trash-slot {
            width: var(--slot-size); height: var(--slot-size);
            background-color: #555;
            border: calc(var(--base-unit)*0.05) solid #000;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }
        .trash-slot:hover { background-color: #772222; }
        .grid { display: grid; gap: calc(var(--base-unit)*0.08); }
        .inventory-grid { grid-template-columns: repeat(9,1fr); grid-template-rows: repeat(3,1fr); }
        .hotbar-grid    { grid-template-columns: repeat(9,1fr); margin-top: calc(var(--base-unit)*0.2); }
        .slot {
            width: var(--slot-size); height: var(--slot-size);
            background-color: var(--mc-slot-bg);
            border: var(--border-width) solid var(--mc-slot-border-dark);
            border-right-color: var(--mc-slot-border-light);
            border-bottom-color: var(--mc-slot-border-light);
            box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
        }
        .slot:hover { background-color: rgba(255,255,255,0.2); outline: var(--border-width) solid white; z-index: 10; }
        .tooltip {
            position: absolute;
            background: rgba(16,0,16,0.95);
            border: calc(var(--base-unit)*0.08) solid #280659;
            color: white;
            padding: calc(var(--base-unit)*0.2) calc(var(--base-unit)*0.3);
            font-size: calc(var(--base-unit)*0.28);
            pointer-events: none; display: none; z-index: 100;
            white-space: nowrap;
            box-shadow: inset 0 0 15px #5511aa;
            text-align: left;
        }
        .slot:hover .tooltip, .trash-slot:hover .tooltip { display: block; bottom: 120%; left: 50%; transform: translateX(-50%); }
        .item {
            width: 75%; height: 75%;
            display: flex; justify-content: center; align-items: center;
            font-size: calc(var(--base-unit)*0.65);
            pointer-events: none; position: relative; overflow: hidden;
        }
        .glint::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(135deg, rgba(255,255,255,0) 30%, rgba(128,0,128,0.4) 50%, rgba(255,255,255,0) 70%);
            background-size: 200% 200%;
            animation: glint-anim 2s infinite linear;
            pointer-events: none;
        }
        @keyframes glint-anim {
            0%   { transform: translate(-25%,-25%) rotate(0deg); }
            100% { transform: translate(25%, 25%) rotate(0deg); }
        }
        .durability-container {
            position: absolute;
            bottom: calc(var(--base-unit)*0.08); left: 15%;
            width: 70%; height: calc(var(--base-unit)*0.08);
            background: #000; border: 1px solid #000;
            pointer-events: none;
        }
        .durability-bar { height: 100%; width: 100%; }
        .count {
            position: absolute;
            bottom: calc(var(--base-unit)*0.02); right: calc(var(--base-unit)*0.02);
            color: white; font-size: calc(var(--base-unit)*0.3);
            text-shadow: calc(var(--base-unit)*0.06) calc(var(--base-unit)*0.06) #3f3f3f;
            pointer-events: none; z-index: 5;
        }
        #cursor-item {
            position: fixed; pointer-events: none; z-index: 3000; display: none;
            width: var(--slot-size); height: var(--slot-size);
            justify-content: center; align-items: center;
            transform: translate(-50%,-50%);
        }
        .tt-title       { color: white; display: block; margin-bottom: 4px; font-size: 1.1em; }
        .tt-custom-name { color: var(--mc-rarity-yellow); font-style: italic; }
        .tt-lore-purple { color: var(--mc-lore-purple); display: block; }
        .tt-lore-blue   { color: var(--mc-lore-blue);   display: block; }
        .tt-lore-gray   { color: var(--mc-lore-gray);   display: block; margin-top: 4px; }
        .tt-red         { color: #ff5555; }
        .tt-green       { color: #55ff55; }
    </style>
</head>
<body>

<div id="damage-vignette"></div>
<div id="notif-toast"><span class="toast-title" id="toast-title"></span><span class="toast-body" id="toast-body"></span></div>
<div id="perm-banner" style="display:none">
    <span>üîî Enable notifications to be alerted when timers finish ‚Äî even in other tabs.</span>
    <button id="perm-allow">Enable</button>
    <button id="perm-dismiss">Dismiss</button>
</div>

<div id="setup-overlay">
    <div class="setup-menu">
        <div class="label" style="color:#000">Crafting Table</div>
        <div class="input-group">
            <div class="row"><input type="text" id="in-name" placeholder="Name your item..." maxlength="24"></div>
            <div class="row">
                <div class="label" style="font-size:0.25em">Type:</div>
                <select id="in-type">
                    <option value="countdown">Countdown</option>
                    <option value="hourglass">Hourglass</option>
                    <option value="stopwatch">Stopwatch</option>
                    <option value="calendar">Calendar</option>
                </select>
            </div>
            <div id="duration-inputs" class="row">
                <input type="number" id="in-val" value="5" min="1">
                <select id="in-unit">
                    <option value="60" selected>Minutes</option>
                    <option value="1">Seconds</option>
                    <option value="3600">Hours</option>
                    <option value="86400">Days</option>
                </select>
            </div>
            <div id="date-inputs" class="row" style="display:none">
                <input type="datetime-local" id="in-date">
            </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;">
            <button id="add-btn">CRAFT</button>
            <button id="cancel-btn" style="background:#e57373">CANCEL</button>
        </div>
    </div>
</div>

<div class="inventory-gui" id="gui">
    <div class="utility-bar">
        <button onclick="exportData()">EXPORT</button>
        <button onclick="importData()">IMPORT</button>
    </div>
    <div class="header">
        <div class="label">Inventory</div>
        <div class="trash-slot" id="trash-slot">
            <div class="item">üåã</div>
            <div class="tooltip">
                <span class="tt-title tt-red">Destroy Item</span>
                <span class="tt-lore-gray">Shift-click an item here</span>
                <span class="tt-lore-gray">to delete it.</span>
            </div>
        </div>
    </div>
    <div class="grid inventory-grid" id="inventory"></div>
    <div class="label" style="margin-top:calc(var(--base-unit)*0.1)">Hotbar</div>
    <div class="grid hotbar-grid" id="hotbar"></div>
</div>

<div id="cursor-item"></div>

<script>
    const inventory    = document.getElementById('inventory');
    const hotbar       = document.getElementById('hotbar');
    const trashSlot    = document.getElementById('trash-slot');
    const cursorItem   = document.getElementById('cursor-item');
    const setupOverlay = document.getElementById('setup-overlay');
    const inType       = document.getElementById('in-type');
    const durationInputs = document.getElementById('duration-inputs');
    const dateInputs   = document.getElementById('date-inputs');
    const vignette     = document.getElementById('damage-vignette');
    const permBanner   = document.getElementById('perm-banner');
    const toast        = document.getElementById('notif-toast');
    const toastTitle   = document.getElementById('toast-title');
    const toastBody    = document.getElementById('toast-body');

    // ‚îÄ‚îÄ Notification state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Track which timer UIDs have already fired a notification so we don't spam
    const notifiedUids = new Set(JSON.parse(sessionStorage.getItem('mc_notified') || '[]'));
    let toastTimeout = null;

    function saveNotified() {
        sessionStorage.setItem('mc_notified', JSON.stringify([...notifiedUids]));
    }

    // Show in-page toast (fallback / supplement)
    function showToast(title, body) {
        toastTitle.textContent = title;
        toastBody.textContent  = body;
        toast.classList.add('show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.remove('show'), 6000);
    }

    // Fire a browser push notification (and a toast for good measure)
    function fireNotification(timer, uid) {
        if (notifiedUids.has(uid)) return;
        notifiedUids.add(uid);
        saveNotified();

        const label = timer.customName || itemNames[timer.type];
        const title = `‚è∞ ${label} finished!`;
        const body  = `Your ${itemNames[timer.type].toLowerCase()} has expired.`;

        showToast(title, body);

        if (Notification.permission === 'granted') {
            new Notification(title, {
                body,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><text y="28" font-size="28">‚è∞</text></svg>',
                tag: uid,   // prevents duplicate OS-level toasts for the same timer
                requireInteraction: false
            });
        }

        // Flash the page title
        flashTitle(label);
    }

    // Flash document title so the tab blinks even when minimised
    let titleFlashInterval = null;
    const originalTitle = document.title;
    function flashTitle(label) {
        clearInterval(titleFlashInterval);
        let on = true;
        titleFlashInterval = setInterval(() => {
            document.title = on ? `‚è∞ ${label} done!` : originalTitle;
            on = !on;
        }, 800);
        // Stop after 15 s or when user focuses tab
        const stop = () => { clearInterval(titleFlashInterval); document.title = originalTitle; };
        setTimeout(stop, 15000);
        window.addEventListener('focus', stop, { once: true });
    }

    // ‚îÄ‚îÄ Permission banner logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function checkPermBanner() {
        if (Notification.permission === 'default' &&
            !sessionStorage.getItem('mc_perm_dismissed')) {
            permBanner.style.display = 'flex';
        }
    }

    document.getElementById('perm-allow').addEventListener('click', async () => {
        permBanner.style.display = 'none';
        const result = await Notification.requestPermission();
        if (result === 'granted') showToast('Notifications enabled ‚úî', 'You will be alerted when timers finish.');
    });

    document.getElementById('perm-dismiss').addEventListener('click', () => {
        permBanner.style.display = 'none';
        sessionStorage.setItem('mc_perm_dismissed', '1');
    });

    // ‚îÄ‚îÄ App state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let state = {
        heldItem: null,
        timers: JSON.parse(localStorage.getItem('mc_timers')) || {},
        lastTick: Date.now()
    };

    const icons     = { countdown:'‚åõ', hourglass:'‚è≥', stopwatch:'‚è±', calendar:'üìÖ' };
    const itemNames = { countdown:'Countdown', hourglass:'Hourglass', stopwatch:'Stopwatch', calendar:'Calendar' };

    inType.addEventListener('change', () => {
        durationInputs.style.display = (inType.value === 'calendar' || inType.value === 'stopwatch') ? 'none' : 'flex';
        dateInputs.style.display     = (inType.value === 'calendar') ? 'flex' : 'none';
    });

    const formatTime = (totalSeconds, detailed=false) => {
        const absSec = Math.abs(totalSeconds);
        const d = Math.floor(absSec/86400);
        const h = Math.floor((absSec%86400)/3600);
        const m = Math.floor((absSec%3600)/60);
        const s = Math.floor(absSec%60);
        if (!detailed) {
            if (d>0) return d+"d";
            if (h>0) return h+"h";
            if (m>0) return m.toString();
            return s+"s";
        }
        let parts = [];
        if (d>0) parts.push(`${d}d`);
        if (h>0||d>0) parts.push(`${h}h`);
        parts.push(`${m}m`); parts.push(`${s}s`);
        return (totalSeconds<0?"-":"")+parts.join(" ");
    };

    const formatDate = ts => new Date(ts).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});

    const playSound = type => {
        try {
            const ctx  = new (window.AudioContext||window.webkitAudioContext)();
            const osc  = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            if (type==='click') {
                osc.type='square'; osc.frequency.setValueAtTime(150,ctx.currentTime);
                gain.gain.setValueAtTime(0.05,ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.1);
                osc.start(); osc.stop(ctx.currentTime+0.1);
            } else if (type==='burn') {
                osc.type='sawtooth'; osc.frequency.setValueAtTime(100,ctx.currentTime);
                gain.gain.setValueAtTime(0.1,ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.5);
                osc.start(); osc.stop(ctx.currentTime+0.5);
            }
        } catch(e) {}
    };

    function updateSlotUI(uid) {
        const slot  = document.getElementById(uid);
        const timer = state.timers[uid];
        if (!timer) { slot.innerHTML=''; return; }

        const countDisplay = formatTime(timer.totalSeconds, false);
        const isRunning    = timer.running || timer.type==='calendar';
        const remainStr    = formatTime(timer.totalSeconds, true);

        let pct = 1;
        if (timer.initialSeconds>0) pct = timer.totalSeconds/timer.initialSeconds;
        if (timer.type==='stopwatch') pct = 1;
        const hue      = Math.max(0, Math.min(120, pct*120));
        const barWidth = Math.max(0, Math.min(100, pct*100));

        let firstLore='', secondLore='';
        if (timer.type==='hourglass') {
            firstLore  = `Total time: ${formatTime(timer.initialSeconds,true)}`;
            secondLore = `Time remaining: ${remainStr}`;
        } else if (timer.type==='countdown') {
            firstLore  = `End date: ${formatDate(timer.startTime+(timer.initialSeconds*1000))}`;
            secondLore = `Time remaining: ${remainStr}`;
        } else if (timer.type==='stopwatch') {
            firstLore  = `Time elapsed: ${remainStr}`;
            secondLore = `Lap: 0s`;
        } else if (timer.type==='calendar') {
            firstLore  = `Target: ${formatDate(timer.targetDate)}`;
            secondLore = `Difference: ${remainStr}`;
        }

        // Notification status badge in tooltip
        const notifGranted = Notification.permission==='granted';
        const notifLine    = notifGranted
            ? `<span class="tt-lore-gray tt-green">üîî Notifications ON</span>`
            : `<span class="tt-lore-gray tt-red">üîï Notifications OFF</span>`;

        slot.innerHTML = `
            <div class="item ${isRunning?'glint':''}">${icons[timer.type]}</div>
            <div class="count">${countDisplay}</div>
            ${timer.type!=='stopwatch'&&timer.type!=='calendar'?`
            <div class="durability-container">
                <div class="durability-bar" style="width:${barWidth}%;background:hsl(${hue},100%,45%)"></div>
            </div>`:''}
            <div class="tooltip">
                <span class="tt-title">${timer.customName?`<span class="tt-custom-name">${timer.customName}</span>`:itemNames[timer.type]}</span>
                <span class="tt-lore-purple">${firstLore}</span>
                <span class="tt-lore-blue">${secondLore}</span>
                ${notifLine}
                <span class="tt-lore-gray">${timer.running?'Click to pause':'Click to start'}</span>
            </div>
        `;
    }

    function handleSlotClick(uid, event) {
        if (event.button!==0) return;
        if (!state.heldItem) {
            if (state.timers[uid]) {
                if (event.shiftKey) {
                    playSound('click');
                    state.heldItem = state.timers[uid];
                    delete state.timers[uid];
                    updateSlotUI(uid); showCursorItem();
                } else {
                    playSound('click');
                    const timer = state.timers[uid];
                    if (timer.type==='hourglass') {
                        if (timer.totalSeconds===timer.initialSeconds&&!timer.running) timer.running=true;
                        else { timer.totalSeconds=Math.max(0,timer.initialSeconds-timer.totalSeconds); timer.running=true; }
                    } else if (timer.type!=='calendar') {
                        if (timer.type==='countdown'&&!timer.running)
                            timer.startTime=Date.now()-((timer.initialSeconds-timer.totalSeconds)*1000);
                        timer.running=!timer.running;
                    }
                    // If user restarts a finished timer, clear the fired-notification record
                    if (timer.running) notifiedUids.delete(uid), saveNotified();
                }
            } else {
                playSound('click');
                state.targetSlotId = uid;
                document.getElementById('in-name').value='';
                setupOverlay.style.display='flex';
            }
        } else {
            playSound('click');
            state.timers[uid] = state.heldItem;
            state.heldItem    = null;
            hideCursorItem(); updateSlotUI(uid);
        }
        save();
    }

    trashSlot.addEventListener('mousedown', () => {
        if (state.heldItem) { playSound('burn'); state.heldItem=null; hideCursorItem(); save(); }
    });

    document.getElementById('add-btn').addEventListener('click', () => {
        const type = inType.value;
        const uid  = state.targetSlotId;
        const customName = document.getElementById('in-name').value;
        let secs=0, initial=0;
        if (type==='calendar') {
            const dateVal = document.getElementById('in-date').value;
            secs = dateVal?(new Date(dateVal).getTime()-Date.now())/1000:0;
            initial=secs;
        } else if (type==='stopwatch') { secs=0; initial=0; }
        else {
            const val = parseInt(document.getElementById('in-val').value)||0;
            secs  = val*parseInt(document.getElementById('in-unit').value);
            initial=secs;
        }
        state.timers[uid] = {
            type, customName, totalSeconds:secs, initialSeconds:initial,
            running:false, startTime:Date.now(),
            targetDate: type==='calendar'?new Date(document.getElementById('in-date').value).getTime():null
        };
        // Clear any stale notification record for this slot
        notifiedUids.delete(uid); saveNotified();
        setupOverlay.style.display='none';
        updateSlotUI(uid); save();
    });

    function save() { localStorage.setItem('mc_timers', JSON.stringify(state.timers)); }
    function showCursorItem() {
        cursorItem.style.display='flex';
        cursorItem.innerHTML=`<div class="item glint">${icons[state.heldItem.type]}</div><div class="count">${formatTime(state.heldItem.totalSeconds)}</div>`;
    }
    function hideCursorItem() { cursorItem.style.display='none'; }

    document.getElementById('cancel-btn').addEventListener('click', ()=>setupOverlay.style.display='none');
    document.addEventListener('mousemove', e => {
        if (state.heldItem) { cursorItem.style.left=e.clientX+'px'; cursorItem.style.top=e.clientY+'px'; }
    });

    function exportData() {
        const blob = new Blob([JSON.stringify(state.timers)],{type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href=url; a.download='mc_inventory_timers.json'; a.click();
    }
    function importData() {
        const input = document.createElement('input');
        input.type='file';
        input.onchange = e => {
            const reader=new FileReader();
            reader.onload=re=>{ state.timers=JSON.parse(re.target.result); location.reload(); };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }

    function tick() {
        const now      = Date.now();
        const delta    = (now-state.lastTick)/1000;
        state.lastTick = now;
        let hasAlert   = false;

        for (const uid in state.timers) {
            const timer = state.timers[uid];
            if (timer.type==='calendar') {
                timer.totalSeconds=(timer.targetDate-now)/1000;
                // Fire when calendar crosses zero (past due)
                if (timer.totalSeconds<=0) {
                    fireNotification(timer, uid);
                    hasAlert=true;
                }
            } else if (timer.running) {
                if (timer.type==='stopwatch') {
                    timer.totalSeconds+=delta;
                } else {
                    timer.totalSeconds=Math.max(0,timer.totalSeconds-delta);
                    if (timer.totalSeconds<=0) {
                        timer.totalSeconds=0; timer.running=false;
                        fireNotification(timer, uid);
                    }
                }
            }
            if ((timer.type==='countdown'||timer.type==='hourglass') && timer.totalSeconds===0 && timer.initialSeconds>0) hasAlert=true;
            if (timer.type==='calendar' && timer.totalSeconds<=0) hasAlert=true;
            updateSlotUI(uid);
        }

        vignette.classList.toggle('taking-damage', hasAlert);
        save();
        requestAnimationFrame(tick);
    }

    function createSlot(id, gridType) {
        const slot = document.createElement('div');
        const uid  = gridType+'-'+id;
        slot.className='slot'; slot.id=uid;
        slot.addEventListener('mousedown', e=>handleSlotClick(uid,e));
        slot.addEventListener('contextmenu', e=>{
            e.preventDefault();
            const t=state.timers[uid];
            if(t){ playSound('click'); t.totalSeconds=t.initialSeconds; t.running=false; notifiedUids.delete(uid); saveNotified(); updateSlotUI(uid); save(); }
        });
        return slot;
    }

    for (let i=0;i<27;i++) inventory.appendChild(createSlot(i,'inv'));
    for (let i=0;i<9; i++) hotbar.appendChild(createSlot(i,'hotbar'));
    Object.keys(state.timers).forEach(uid=>updateSlotUI(uid));

    // Show permission banner after a short delay
    setTimeout(checkPermBanner, 1500);

    requestAnimationFrame(tick);
</script>
</body>
</html>
