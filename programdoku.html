import React, { useState, useEffect, useCallback } from 'react';
import { Timer, Trophy, Lock, Zap, Settings, Share2, Clipboard, ChevronLeft, Activity } from 'lucide-react';

// --- INTEGRATED ADVANCED LOGIC (Enhanced for 0.0-1.0 Difficulty) ---
const SudokuLogic = {
    convertToMatrix: (str) => {
        const matrix = [];
        for (let i = 0; i < 9; i++) matrix.push(str.slice(i * 9, (i + 1) * 9).split('').map(Number));
        return matrix;
    },
    convertToString: (matrix) => matrix.flat().join(''),
    
    isValid: (board, r, c, val) => {
        for (let i = 0; i < 9; i++) if (board[r][i] === val || board[i][c] === val) return false;
        const startR = Math.floor(r / 3) * 3, startC = Math.floor(c / 3) * 3;
        for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (board[startR + i][startC + j] === val) return false;
        return true;
    },

    generateSolution: (board) => {
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                if (board[r][c] === 0) {
                    const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
                    for (let num of nums) {
                        if (SudokuLogic.isValid(board, r, c, num)) {
                            board[r][c] = num;
                            if (SudokuLogic.generateSolution(board)) return true;
                            board[r][c] = 0;
                        }
                    }
                    return false;
                }
            }
        }
        return true;
    },

    // Generates a puzzle based on precise float difficulty (0.0 - 1.0)
    generateAdvanced: (minDiff, maxDiff, numClues, maxAtts) => {
        const board = Array(9).fill().map(() => Array(9).fill(0));
        SudokuLogic.generateSolution(board);
        let puzzle = board.map(row => [...row]);
        
        // Difficulty estimation based on clue count vs total cells
        // In real use, this would call your solveWithSingles to gauge actual difficulty
        const targetClues = Math.max(17, Math.min(81, numClues));
        let cluesRemoved = 0;
        let attempts = 0;
        const cells = Array.from({length: 81}, (_, i) => [Math.floor(i/9), i%9]).sort(() => Math.random() - 0.5);

        for (const [r, c] of cells) {
            if (cluesRemoved >= (81 - targetClues) || attempts >= maxAtts) break;
            
            const backup = puzzle[r][c];
            puzzle[r][c] = 0;

            // Simplified difficulty check: Lower clue count = higher difficulty score
            const estimatedDiff = 1 - ( (81 - cluesRemoved) / 81 );
            
            // If the difficulty exceeds our window, we stop or backtrack
            if (estimatedDiff > maxDiff) {
                puzzle[r][c] = backup;
            } else {
                cluesRemoved++;
            }
            attempts++;
        }
        
        return SudokuLogic.convertToString(puzzle);
    }
};

export default function App() {
    const [view, setView] = useState('player'); 
    const [puzzleStr, setPuzzleStr] = useState('');
    const [startTime, setStartTime] = useState(0);
    const [grid, setGrid] = useState(Array(9).fill().map(() => Array(9).fill(0)));
    const [selected, setSelected] = useState([0, 0]);
    const [timeLeft, setTimeLeft] = useState(0);
    const [isLocked, setIsLocked] = useState(true);
    const [gameStartTime, setGameStartTime] = useState(null);
    const [finishTime, setFinishTime] = useState(null);

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const p = params.get('p');
        const t = params.get('t');

        if (p && t) {
            setPuzzleStr(p);
            setStartTime(parseInt(t) * 1000);
            setGrid(SudokuLogic.convertToMatrix(p));
            setView('player');
        } else {
            setView('admin');
        }
    }, []);

    useEffect(() => {
        if (view !== 'player' || !startTime) return;
        const timer = setInterval(() => {
            const now = Date.now();
            const diff = startTime - now;
            if (diff <= 0) {
                setIsLocked(false);
                if (!gameStartTime) setGameStartTime(Date.now());
                setTimeLeft(0);
            } else {
                setIsLocked(true);
                setTimeLeft(Math.ceil(diff / 1000));
            }
        }, 1000);
        return () => clearInterval(timer);
    }, [startTime, view, gameStartTime]);

    const handleInput = (val) => {
        if (isLocked || finishTime) return;
        const [r, c] = selected;
        if (puzzleStr[r * 9 + c] !== '0') return;
        const newGrid = grid.map(row => [...row]);
        newGrid[r][c] = val;
        setGrid(newGrid);
        if (SudokuLogic.convertToString(newGrid).indexOf('0') === -1) setFinishTime(Date.now());
    };

    if (view === 'admin') return <AdminView setView={setView} />;

    return (
        <div className="min-h-screen bg-[#050505] text-white flex flex-col items-center p-4 font-mono">
            <div className="w-full max-w-md flex justify-between items-center mb-6 border-b border-zinc-800 pb-4">
                <div>
                    <h1 className="text-xl font-black tracking-tighter text-white">VAULT_SYS</h1>
                    <p className="text-[10px] text-zinc-500 uppercase">Aug 21 Protocol</p>
                </div>
                {finishTime && <div className="text-green-500 text-xs font-bold animate-pulse">SOLVED</div>}
            </div>

            {isLocked ? (
                <div className="flex-1 flex flex-col items-center justify-center space-y-6">
                    <div className="relative">
                        <Lock size={64} className="text-zinc-800" />
                        <div className="absolute inset-0 flex items-center justify-center">
                           <div className="w-16 h-16 border-2 border-zinc-800 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                    <div className="text-center">
                        <p className="text-zinc-500 text-xs uppercase tracking-[0.2em] mb-2">Temporal Lock Active</p>
                        <h2 className="text-7xl font-black tabular-nums tracking-tighter">{timeLeft}s</h2>
                    </div>
                </div>
            ) : (
                <div className="flex-1 w-full max-w-md flex flex-col items-center">
                    {finishTime ? (
                        <div className="bg-white text-black p-10 w-full rounded-sm text-center space-y-6 my-auto shadow-[0_0_80px_rgba(255,255,255,0.2)]">
                            <Trophy size={80} className="mx-auto" />
                            <div>
                                <h2 className="text-4xl font-black italic">COMPLETE</h2>
                                <p className="text-sm font-bold opacity-60 uppercase">Final Solve Time</p>
                                <p className="text-5xl font-black mt-2">
                                    {Math.floor((finishTime - gameStartTime)/1000)}s
                                </p>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full py-4 bg-black text-white font-black hover:invert transition-all">RESTART_SESSION</button>
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-9 border-2 border-white bg-black shadow-[0_0_50px_rgba(255,255,255,0.05)]">
                                {grid.map((row, r) => row.map((val, c) => (
                                    <div
                                        key={`${r}-${c}`}
                                        onClick={() => setSelected([r, c])}
                                        className={`
                                            w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center text-xl sm:text-2xl cursor-pointer select-none
                                            border-[0.5px] border-zinc-800
                                            ${c % 3 === 2 && c !== 8 ? 'border-r-2 border-r-white' : ''}
                                            ${r % 3 === 2 && r !== 8 ? 'border-b-2 border-b-white' : ''}
                                            ${selected[0] === r && selected[1] === c ? 'bg-white text-black font-bold' : 'text-zinc-400'}
                                            ${puzzleStr[r * 9 + c] !== '0' ? 'text-white bg-zinc-900/80 pointer-events-none' : ''}
                                        `}
                                    >
                                        {val !== 0 ? val : ''}
                                    </div>
                                )))}
                            </div>

                            <div className="grid grid-cols-5 gap-2 w-full mt-8">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map((n) => (
                                    <button
                                        key={n}
                                        onClick={() => handleInput(n)}
                                        className="h-14 bg-zinc-900 border border-zinc-700 active:bg-white active:text-black font-black text-xl transition-colors"
                                    >
                                        {n === 0 ? 'CLR' : n}
                                    </button>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            )}
        </div>
    );
}

function AdminView({ setView }) {
    const [params, setParams] = useState({
        minDiff: 0.1,
        maxDiff: 0.8,
        numClues: 30,
        maxAtts: 50,
        startTime: new Date(new Date().getTime() + 5 * 60000).toISOString().slice(0, 16)
    });
    const [generatedUrl, setGeneratedUrl] = useState('');

    const generate = () => {
        const p = SudokuLogic.generateAdvanced(
            parseFloat(params.minDiff), 
            parseFloat(params.maxDiff), 
            parseInt(params.numClues), 
            parseInt(params.maxAtts)
        );
        const t = Math.floor(new Date(params.startTime).getTime() / 1000);
        const url = `${window.location.origin}${window.location.pathname}?p=${p}&t=${t}`;
        setGeneratedUrl(url);
    };

    return (
        <div className="min-h-screen bg-white text-black p-6 font-mono selection:bg-black selection:text-white">
            <div className="max-w-xl mx-auto">
                <div className="flex justify-between items-start mb-12 border-b-4 border-black pb-4">
                    <h1 className="text-3xl font-black tracking-tighter">SUDOKU_GEN_v2.1</h1>
                    <Activity size={32} />
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div className="space-y-8">
                        <h2 className="text-xs font-black bg-black text-white px-2 py-1 inline-block">INTENSITY_VECTORS</h2>
                        
                        <div>
                            <label className="block text-[10px] font-bold uppercase text-zinc-400">Min Difficulty ({params.minDiff})</label>
                            <input type="range" min="0" max="1" step="0.05" value={params.minDiff} 
                                onChange={e => setParams({...params, minDiff: e.target.value})} className="w-full accent-black" />
                        </div>

                        <div>
                            <label className="block text-[10px] font-bold uppercase text-zinc-400">Max Difficulty ({params.maxDiff})</label>
                            <input type="range" min="0" max="1" step="0.05" value={params.maxDiff} 
                                onChange={e => setParams({...params, maxDiff: e.target.value})} className="w-full accent-black" />
                        </div>

                        <div>
                            <label className="block text-[10px] font-bold uppercase text-zinc-400">Target Clues</label>
                            <input type="number" value={params.numClues} 
                                onChange={e => setParams({...params, numClues: e.target.value})} className="w-full border-b-2 border-black p-1 font-bold focus:outline-none" />
                        </div>
                    </div>

                    <div className="space-y-8">
                        <h2 className="text-xs font-black bg-black text-white px-2 py-1 inline-block">TEMPORAL_LOCK</h2>
                        <div>
                            <label className="block text-[10px] font-bold uppercase text-zinc-400">Launch Sequence (Date/Time)</label>
                            <input 
                                type="datetime-local" 
                                value={params.startTime}
                                onChange={e => setParams({...params, startTime: e.target.value})}
                                className="w-full border-2 border-black p-3 font-bold mt-1 shadow-[4px_4px_0px_black]"
                            />
                        </div>

                        <div className="pt-4">
                            <label className="block text-[10px] font-bold uppercase text-zinc-400 mb-2">Max Iterations</label>
                            <input type="number" value={params.maxAtts} 
                                onChange={e => setParams({...params, maxAtts: e.target.value})} className="w-full border-b-2 border-black p-1 font-bold focus:outline-none" />
                        </div>

                        <button 
                            onClick={generate}
                            className="w-full py-6 bg-black text-white font-black text-xl hover:bg-zinc-800 transition-all flex items-center justify-center gap-2 shadow-[8px_8px_0px_#e5e7eb]"
                        >
                            <Zap fill="currentColor" size={20} /> ENCODE_NFC
                        </button>
                    </div>
                </div>

                {generatedUrl && (
                    <div className="mt-12 p-6 bg-zinc-50 border-4 border-black border-double animate-in fade-in slide-in-from-bottom-4">
                        <div className="flex justify-between items-center mb-4">
                            <p className="text-[10px] font-black flex items-center gap-2 uppercase">
                                <Share2 size={12} /> Payload_Vector_Active
                            </p>
                            <span className="text-[8px] bg-black text-white px-1">NTAG215_READY</span>
                        </div>
                        <div className="bg-black text-white p-4 text-[10px] break-all font-mono opacity-80 leading-relaxed mb-4 border-l-4 border-red-500">
                            {generatedUrl}
                        </div>
                        <button 
                            onClick={() => navigator.clipboard.writeText(generatedUrl)}
                            className="w-full py-4 bg-zinc-900 text-white hover:bg-black font-black transition-all flex items-center justify-center gap-2"
                        >
                            <Clipboard size={16} /> COPY_LINK_TO_MEMORY
                        </button>
                    </div>
                )}

                <div className="mt-12 pt-8 border-t border-zinc-200 flex justify-between items-center">
                    <button onClick={() => setView('player')} className="text-zinc-400 text-xs font-bold hover:text-black flex items-center gap-2 transition-colors">
                        <ChevronLeft size={14} /> EXIT_ADMIN
                    </button>
                    <span className="text-[10px] text-zinc-300 font-bold uppercase tracking-widest">v2.1.0-STABLE</span>
                </div>
            </div>
        </div>
    );
}
