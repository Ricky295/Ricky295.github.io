<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT_SYS // AUG-21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #050505;
            color: #ffffff;
            touch-action: manipulation;
        }

        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            border: 2px solid #fff;
            background: #000;
        }

        .cell {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0.5px solid #222;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.1s;
        }

        .cell.selected { background: #fff !important; color: #000 !important; font-weight: 800; }
        .cell.fixed { background: #111; color: #fff; pointer-events: none; }
        
        /* 3x3 Borders */
        .cell:nth-child(3n) { border-right: 2px solid #fff; }
        .cell:nth-child(9n) { border-right: 0.5px solid #222; }
        .sudoku-grid > div:nth-child(n+19):nth-child(-n+27),
        .sudoku-grid > div:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #fff;
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="hidden min-h-screen bg-white text-black p-6">
        <div class="max-w-xl mx-auto">
            <header class="border-b-4 border-black pb-4 mb-8 flex justify-between items-center">
                <h1 class="text-3xl font-black italic tracking-tighter">SUDOKU_GEN_v3</h1>
                <div class="bg-black text-white text-[10px] px-2 py-1">ADMIN_ACCESS</div>
            </header>

            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h2 class="text-xs font-black bg-black text-white px-2 py-1 inline-block">INTENSITY</h2>
                        <div>
                            <label class="block text-[10px] font-bold text-zinc-400">MIN_DIFF (0.0-1.0)</label>
                            <input type="number" id="minDiff" value="0.1" step="0.1" min="0" max="1" class="w-full border-b-2 border-black p-1 font-bold">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-zinc-400">MAX_DIFF (0.0-1.0)</label>
                            <input type="number" id="maxDiff" value="0.8" step="0.1" min="0" max="1" class="w-full border-b-2 border-black p-1 font-bold">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-zinc-400">TARGET_CLUES</label>
                            <input type="number" id="numClues" value="30" class="w-full border-b-2 border-black p-1 font-bold">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h2 class="text-xs font-black bg-black text-white px-2 py-1 inline-block">TEMPORAL_LOCK</h2>
                        <div>
                            <label class="block text-[10px] font-bold text-zinc-400">UNLOCK_TIME</label>
                            <input type="datetime-local" id="startTime" class="w-full border-2 border-black p-2 font-bold mt-1 shadow-[4px_4px_0px_black]">
                        </div>
                        <button onclick="generateNFC()" class="w-full mt-4 py-6 bg-black text-white font-black text-xl hover:bg-zinc-800 shadow-[8px_8px_0px_#ddd]">ENCODE_NFC</button>
                    </div>
                </div>

                <div id="output" class="hidden mt-8 p-4 bg-zinc-100 border-4 border-black border-double">
                    <p class="text-[10px] font-black mb-2 uppercase">Payload_Ready:</p>
                    <div id="url-box" class="text-[10px] break-all font-mono bg-white p-3 border border-black mb-4"></div>
                    <button onclick="copyURL()" class="w-full py-2 bg-zinc-300 font-bold text-xs uppercase hover:bg-black hover:text-white">Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PLAYER VIEW -->
    <div id="player-view" class="hidden min-h-screen flex flex-col items-center p-4">
        <header class="w-full max-w-md flex justify-between items-center mb-6 border-b border-zinc-800 pb-4">
            <div>
                <h1 class="text-xl font-black">VAULT_SYS</h1>
                <p id="diff-label" class="text-[10px] text-zinc-500 uppercase">AUG-21-PROTOCOL</p>
            </div>
            <div id="timer-display" class="text-xl font-black">00:00</div>
        </header>

        <!-- LOCK SCREEN -->
        <div id="lock-screen" class="flex-1 flex flex-col items-center justify-center space-y-6">
            <div class="w-20 h-20 border-4 border-zinc-800 border-t-white rounded-full animate-spin"></div>
            <div class="text-center">
                <p class="text-zinc-500 text-xs uppercase tracking-widest mb-2">Temporal Lock</p>
                <h2 id="countdown" class="text-7xl font-black">--s</h2>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-1 w-full max-w-md flex flex-col items-center">
            <div id="grid" class="sudoku-grid w-full"></div>
            
            <div class="grid grid-cols-5 gap-2 w-full mt-8">
                <button onclick="inputValue(1)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">1</button>
                <button onclick="inputValue(2)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">2</button>
                <button onclick="inputValue(3)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">3</button>
                <button onclick="inputValue(4)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">4</button>
                <button onclick="inputValue(5)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">5</button>
                <button onclick="inputValue(6)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">6</button>
                <button onclick="inputValue(7)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">7</button>
                <button onclick="inputValue(8)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">8</button>
                <button onclick="inputValue(9)" class="h-14 bg-zinc-900 border border-zinc-700 font-black text-xl active:bg-white active:text-black">9</button>
                <button onclick="inputValue(0)" class="h-14 bg-red-900/20 border border-red-900 font-black text-xs active:bg-white active:text-black uppercase">Clear</button>
            </div>
        </div>

        <!-- WIN SCREEN -->
        <div id="win-screen" class="hidden fixed inset-0 bg-white text-black z-50 flex flex-col items-center justify-center p-8 text-center">
            <h2 class="text-6xl font-black italic mb-2">SOLVED</h2>
            <p class="text-xl font-bold uppercase tracking-widest border-b-4 border-black pb-4 mb-4">Vault Accessed</p>
            <p id="final-time" class="text-4xl font-black mb-8">00s</p>
            <button onclick="location.reload()" class="px-12 py-4 bg-black text-white font-black hover:invert transition-all">RESTART</button>
        </div>
    </div>

    <script>
        // --- CORE LOGIC (newsudoku.js style) ---
        const Logic = {
            isValid: (board, r, c, val) => {
                for (let i = 0; i < 9; i++) if (board[r][i] === val || board[i][c] === val) return false;
                const sr = Math.floor(r / 3) * 3, sc = Math.floor(c / 3) * 3;
                for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (board[sr+i][sc+j] === val) return false;
                return true;
            },
            solve: (board) => {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (board[r][c] === 0) {
                            for (let n = 1; n <= 9; n++) {
                                if (Logic.isValid(board, r, c, n)) {
                                    board[r][c] = n;
                                    if (Logic.solve(board)) return true;
                                    board[r][c] = 0;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            },
            generate: (numClues, maxAtts) => {
                const board = Array(9).fill().map(() => Array(9).fill(0));
                Logic.solve(board);
                let puzzle = board.map(row => [...row]);
                let removed = 0, atts = 0;
                while (removed < (81 - numClues) && atts < maxAtts) {
                    const r = Math.floor(Math.random() * 9), c = Math.floor(Math.random() * 9);
                    if (puzzle[r][c] !== 0) { puzzle[r][c] = 0; removed++; }
                    atts++;
                }
                return puzzle.flat().join('');
            }
        };

        // --- STATE ---
        let state = {
            puzzle: '',
            currentGrid: [],
            selected: [0, 0],
            startTime: 0,
            gameStartTime: 0,
            isLocked: true
        };

        // --- UI HANDLERS ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            const p = params.get('p');
            const t = params.get('t');

            if (p && t) {
                state.puzzle = p;
                state.startTime = parseInt(t) * 1000;
                state.currentGrid = p.split('').map(Number);
                document.getElementById('player-view').classList.remove('hidden');
                renderGrid();
                tick();
            } else {
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('startTime').value = new Date(Date.now() + 300000).toISOString().slice(0, 16);
            }
        }

        function renderGrid() {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            state.currentGrid.forEach((val, i) => {
                const r = Math.floor(i / 9);
                const c = i % 9;
                const cell = document.createElement('div');
                cell.className = `cell ${state.puzzle[i] !== '0' ? 'fixed' : ''}`;
                if (state.selected[0] === r && state.selected[1] === c) cell.classList.add('selected');
                cell.textContent = val !== 0 ? val : '';
                cell.onclick = () => { if (!state.isLocked) { state.selected = [r, c]; renderGrid(); } };
                container.appendChild(cell);
            });
        }

        function inputValue(val) {
            const idx = state.selected[0] * 9 + state.selected[1];
            if (state.puzzle[idx] !== '0') return;
            state.currentGrid[idx] = val;
            renderGrid();
            if (!state.currentGrid.includes(0)) {
                document.getElementById('win-screen').classList.remove('hidden');
                document.getElementById('final-time').textContent = Math.floor((Date.now() - state.gameStartTime) / 1000) + 's';
            }
        }

        function tick() {
            const now = Date.now();
            const diff = state.startTime - now;
            
            if (diff > 0) {
                document.getElementById('countdown').textContent = Math.ceil(diff / 1000) + 's';
                setTimeout(tick, 1000);
            } else {
                state.isLocked = false;
                state.gameStartTime = Date.now();
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                updateGameTimer();
            }
        }

        function updateGameTimer() {
            if (document.getElementById('win-screen').classList.contains('hidden')) {
                const elapsed = Math.floor((Date.now() - state.gameStartTime) / 1000);
                const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const s = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;
                setTimeout(updateGameTimer, 1000);
            }
        }

        // --- ADMIN FUNCTIONS ---
        function generateNFC() {
            const clues = document.getElementById('numClues').value;
            const atts = document.getElementById('maxAtts')?.value || 100;
            const p = Logic.generate(clues, atts);
            const t = Math.floor(new Date(document.getElementById('startTime').value).getTime() / 1000);
            const url = `${window.location.origin}${window.location.pathname}?p=${p}&t=${t}`;
            
            document.getElementById('output').classList.remove('hidden');
            document.getElementById('url-box').textContent = url;
        }

        function copyURL() {
            const text = document.getElementById('url-box').textContent;
            const temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
        }

        window.onload = init;
    </script>
</body>
</html>
