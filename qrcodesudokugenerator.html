<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Sudoku Pack Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 100%);min-height:100vh;padding:20px;color:#333}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);padding:30px}
        h1{color:#818cf8;margin-bottom:10px;font-size:2em}
        .disclaimer{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin-bottom:20px;border-radius:4px;font-size:0.9em}
        .controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;font-size:14px}
        button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-primary{background:linear-gradient(135deg,#818cf8 0%,#6366f1 100%);color:white}
        .btn-secondary{background:linear-gradient(135deg,#34d399 0%,#10b981 100%);color:white}
        .btn-warning{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:white}
        .btn-danger{background:linear-gradient(135deg,#f87171 0%,#ef4444 100%);color:white}
        .btn-info{background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%);color:white}
        .capacity-bar{background:#f1f5f9;border-radius:8px;padding:15px;margin-bottom:20px;border:2px solid #e2e8f0}
        .capacity-label{font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between}
        .progress-bar{height:24px;background:#e2e8f0;border-radius:12px;overflow:hidden;position:relative}
        .progress-fill{height:100%;background:linear-gradient(90deg,#34d399,#10b981);transition:width 0.3s,background 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px}
        .progress-fill.warning{background:linear-gradient(90deg,#fbbf24,#f59e0b)}
        .progress-fill.danger{background:linear-gradient(90deg,#f87171,#ef4444)}
        .puzzle-list{display:flex;flex-direction:column;gap:15px;margin-bottom:20px}
        .puzzle-item{background:#f8fafc;border-radius:8px;padding:15px;border:2px solid #e2e8f0;display:flex;align-items:center;gap:15px}
        .puzzle-preview{font-family:'Courier New',monospace;font-size:10px;line-height:1.2;background:white;padding:8px;border-radius:4px;flex-shrink:0}
        .puzzle-info{flex-grow:1}
        .puzzle-type{font-weight:600;color:#6366f1;margin-bottom:4px}
        .puzzle-source{font-size:0.85em;color:#64748b}
        .difficulty-badge{display:inline-block;padding:3px 10px;border-radius:4px;font-size:0.85em;font-weight:700;margin-left:8px;font-family:'Courier New',monospace}
        .difficulty-green{background:#d1fae5;color:#065f46}
        .difficulty-yellow{background:#fef3c7;color:#78350f}
        .difficulty-red{background:#fee2e2;color:#7f1d1d}
        .difficulty-purple{background:#e9d5ff;color:#581c87}
        .puzzle-actions{display:flex;gap:8px;flex-wrap:wrap}
        .puzzle-actions button{padding:6px 12px;font-size:12px}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:12px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
        .modal h2{margin-bottom:20px;color:#6366f1}
        .form-group{margin-bottom:15px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        label{display:block;margin-bottom:5px;font-weight:600;font-size:0.9em}
        input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px}
        input[type="number"]{font-family:'Courier New',monospace}
        textarea{resize:vertical;min-height:100px;font-family:'Courier New',monospace}
        .modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
        #qrcode{display:flex;justify-content:center;margin:20px 0}
        .empty-state{text-align:center;padding:60px 20px;color:#94a3b8}
        .empty-state svg{width:80px;height:80px;margin-bottom:20px;opacity:0.5}
        .generation-progress{background:#ddd6fe;border-radius:8px;padding:15px;margin-top:15px;display:none}
        .generation-progress.active{display:block}
        .generation-progress-bar{height:20px;background:#cbd5e1;border-radius:10px;overflow:hidden;margin-top:10px}
        .generation-progress-fill{height:100%;background:linear-gradient(90deg,#818cf8,#6366f1);transition:width 0.3s}
    </style>
</head>
<body>
    <div class="container">
        <h1>üß© QR Code Sudoku Pack Generator</h1>
        <div class="disclaimer">
            <strong>‚ö†Ô∏è Note:</strong> The built-in generator creates easy-to-medium puzzles. For genuinely difficult Sudokus, visit <a href="https://sudoku.coach" target="_blank">sudoku.coach</a> and import them manually.
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="openAddModal()">‚ûï Add Puzzle</button>
            <button class="btn-primary" onclick="openMassImportModal()">üì• Mass Import</button>
            <button class="btn-secondary" onclick="openGenerateModal('9x9')">üé≤ Generate 9x9 Pack</button>
            <button class="btn-secondary" onclick="openGenerateModal('6x6')">üé≤ Generate 6x6 Pack</button>
            <button class="btn-info" onclick="sortPuzzles('type')">üìä Sort by Type</button>
            <button class="btn-info" onclick="sortPuzzles('difficulty')">üìä Sort by Difficulty</button>
            <button class="btn-warning" onclick="openExportModal()">üì§ Export</button>
        </div>

        <div class="capacity-bar">
            <div class="capacity-label">
                <span>QR Code Capacity</span>
                <span id="capacity-text">0 / 4000 bytes</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="capacity-fill" style="width:0%">0%</div>
            </div>
        </div>

        <div id="puzzle-list" class="puzzle-list">
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>No puzzles yet. Add some to get started!</p>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Add Puzzle</h2>
            <div class="form-group">
                <label>Puzzle Type</label>
                <select id="puzzle-type">
                    <option value="9x9">9x9 Sudoku</option>
                    <option value="6x6">6x6 Sudoku</option>
                </select>
            </div>
            <div class="form-group">
                <label>Puzzle String (81 digits for 9x9, 36 digits for 6x6, 0 = empty)</label>
                <textarea id="puzzle-string" placeholder="000000000..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn-primary" onclick="savePuzzle()">Save</button>
            </div>
        </div>
    </div>

    <div id="massImportModal" class="modal">
        <div class="modal-content">
            <h2>Mass Import Puzzles</h2>
            <div class="form-group">
                <label>Paste puzzle strings (one per line, auto-detects 9x9 or 6x6)</label>
                <textarea id="mass-import-text" placeholder="000000000...&#10;000000000...&#10;000000000..." style="min-height:200px"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeMassImportModal()">Cancel</button>
                <button class="btn-primary" onclick="processMassImport()">Import</button>
            </div>
        </div>
    </div>

    <div id="generateModal" class="modal">
        <div class="modal-content">
            <h2 id="generate-modal-title">Generate 9x9 Pack</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Min Difficulty (0-1)</label>
                    <input type="number" id="gen-min-diff" value="0.3" step="0.05" min="0" max="1">
                </div>
                <div class="form-group">
                    <label>Max Difficulty (0-1)</label>
                    <input type="number" id="gen-max-diff" value="0.7" step="0.05" min="0" max="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Target Clues</label>
                    <input type="number" id="gen-target-clues" value="30" min="17" max="81">
                </div>
                <div class="form-group">
                    <label>Max Attempts per Puzzle</label>
                    <input type="number" id="gen-max-attempts" value="100" min="10" max="500">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Count to Generate</label>
                    <input type="number" id="gen-count" value="5" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Sort After Generation</label>
                    <select id="gen-sort">
                        <option value="none">No sorting</option>
                        <option value="difficulty">By difficulty</option>
                        <option value="type">By type</option>
                    </select>
                </div>
            </div>
            <div class="generation-progress" id="generation-progress">
                <div>Generating puzzles... <span id="gen-progress-text">0/0</span></div>
                <div class="generation-progress-bar">
                    <div class="generation-progress-fill" id="gen-progress-fill" style="width:0%"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeGenerateModal()">Cancel</button>
                <button class="btn-primary" id="generate-btn" onclick="processGenerate()">Generate</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h2>Export Sudoku Pack</h2>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="encrypt-mode"> Use encrypted mode (Base64)
                </label>
            </div>
            <div class="form-group">
                <label>Generated URL</label>
                <textarea id="export-url" readonly></textarea>
            </div>
            <div id="qrcode"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="copyURL()">üìã Copy URL</button>
                <button class="btn-primary" onclick="closeExportModal()">Close</button>
            </div>
        </div>
    </div>
<script src="newsudoku.js"></script>
   <script src="newsudoku6x6.js"></script>
    <script>
        let puzzles=[],editingIndex=-1,currentGenerateType='9x9',isGenerating=false;

        function calculateDifficulty(s,t){
            try{
                if(t==='9x9'){
                    if(!window.Sudoku)return -1;
                    const m=window.Sudoku.convertToMatrix(s);
                    return window.Sudoku.solveWithSingles(m,true);
                }else{
                    if(!window.Sudoku6x6)return -1;
                    const m=window.Sudoku6x6.convertToMatrix(s);
                    return window.Sudoku6x6.solveWithSingles(m,true);
                }
            }catch(e){
                console.error('Error calculating difficulty:',e);
                return -1;
            }
        }

        function getDifficultyDisplay(d){
            return d<0?'xx.x%':(d*100).toFixed(1)+'%';
        }

        function getDifficultyClass(d){
            if(d<0)return'difficulty-purple';
            if(d<1/3)return'difficulty-green';
            if(d<2/3)return'difficulty-yellow';
            if(d<1)return'difficulty-red';
            return'difficulty-purple';
        }

        function openAddModal(){
            editingIndex=-1;
            document.getElementById('modal-title').textContent='Add Puzzle';
            document.getElementById('puzzle-string').value='';
            document.getElementById('puzzle-type').value='9x9';
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal(){
            document.getElementById('addModal').classList.remove('active');
        }

        function openMassImportModal(){
            document.getElementById('mass-import-text').value='';
            document.getElementById('massImportModal').classList.add('active');
        }

        function closeMassImportModal(){
            document.getElementById('massImportModal').classList.remove('active');
        }

        function openGenerateModal(t){
            currentGenerateType=t;
            document.getElementById('generate-modal-title').textContent=`Generate ${t} Pack`;
            const tc=document.getElementById('gen-target-clues');
            tc.value=t==='9x9'?30:18;
            tc.max=t==='9x9'?81:36;
            document.getElementById('generation-progress').classList.remove('active');
            document.getElementById('generateModal').classList.add('active');
        }

        function closeGenerateModal(){
            if(!isGenerating)document.getElementById('generateModal').classList.remove('active');
        }

        async function processGenerate(){
            if(isGenerating)return;

            // Check if libraries are loaded
            if(currentGenerateType==='9x9'&&!window.Sudoku){
                alert('Error: newsudoku.js is not loaded!');
                return;
            }
            if(currentGenerateType==='6x6'&&!window.Sudoku6x6){
                alert('Error: newsudoku6x6.js is not loaded!');
                return;
            }

            isGenerating=true;
            const btn=document.getElementById('generate-btn');
            btn.disabled=true;

            const minDiff=parseFloat(document.getElementById('gen-min-diff').value);
            const maxDiff=parseFloat(document.getElementById('gen-max-diff').value);
            const targetClues=parseInt(document.getElementById('gen-target-clues').value);
            const maxAttempts=parseInt(document.getElementById('gen-max-attempts').value);
            const count=parseInt(document.getElementById('gen-count').value);
            const sortMethod=document.getElementById('gen-sort').value;

            const progressDiv=document.getElementById('generation-progress');
            const progressText=document.getElementById('gen-progress-text');
            const progressFill=document.getElementById('gen-progress-fill');
            
            progressDiv.classList.add('active');
            progressText.textContent=`0/${count}`;
            progressFill.style.width='0%';

            const newPuzzles=[];

            for(let i=0;i<count;i++){
                await new Promise(r=>setTimeout(r,10));

                let puzzle;
                if(currentGenerateType==='9x9'){
                    puzzle=window.Sudoku.generateSudoku(minDiff,maxDiff,targetClues,maxAttempts);
                }else{
                    puzzle=window.Sudoku6x6.generateSudoku(minDiff,maxDiff,targetClues,maxAttempts);
                }

                const string=currentGenerateType==='9x9'?
                    window.Sudoku.convertToString(puzzle):
                    window.Sudoku6x6.convertToString(puzzle);

                const difficulty=calculateDifficulty(string,currentGenerateType);
                
                newPuzzles.push({
                    type:currentGenerateType,
                    string:string,
                    source:'generated',
                    difficulty:difficulty
                });

                progressText.textContent=`${i+1}/${count}`;
                progressFill.style.width=`${((i+1)/count)*100}%`;
            }

            puzzles.push(...newPuzzles);

            if(sortMethod!=='none'){
                sortPuzzles(sortMethod);
            }else{
                updatePuzzleList();
            }

            progressDiv.classList.remove('active');
            btn.disabled=false;
            isGenerating=false;
            closeGenerateModal();
        }

        function processMassImport(){
            const text=document.getElementById('mass-import-text').value;
            const lines=text.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
            
            let imported=0,failed=0;

            for(const line of lines){
                const cleanLine=line.replace(/\s/g,'');
                if(!/^[0-9]+$/.test(cleanLine)){failed++;continue;}

                let type;
                if(cleanLine.length===81){
                    type='9x9';
                }else if(cleanLine.length===36){
                    type='6x6';
                }else{
                    failed++;
                    continue;
                }

                const difficulty=calculateDifficulty(cleanLine,type);
                puzzles.push({type:type,string:cleanLine,source:'manual',difficulty:difficulty});
                imported++;
            }

            alert(`Import complete!\nImported: ${imported}\nFailed: ${failed}`);
            updatePuzzleList();
            closeMassImportModal();
        }

        function savePuzzle(){
            const type=document.getElementById('puzzle-type').value;
            const string=document.getElementById('puzzle-string').value.replace(/\s/g,'');
            
            const expectedLength=type==='9x9'?81:36;
            if(string.length!==expectedLength){
                alert(`Puzzle string must be exactly ${expectedLength} characters long!`);
                return;
            }

            if(!/^[0-9]+$/.test(string)){
                alert('Puzzle string must contain only digits 0-9!');
                return;
            }

            const difficulty=calculateDifficulty(string,type);
            const puzzle={type:type,string:string,source:'manual',difficulty:difficulty};

            if(editingIndex>=0){
                puzzles[editingIndex]=puzzle;
            }else{
                puzzles.push(puzzle);
            }

            updatePuzzleList();
            closeAddModal();
        }

        function editPuzzle(index){
            editingIndex=index;
            const puzzle=puzzles[index];
            document.getElementById('modal-title').textContent='Edit Puzzle';
            document.getElementById('puzzle-type').value=puzzle.type;
            document.getElementById('puzzle-string').value=puzzle.string;
            document.getElementById('addModal').classList.add('active');
        }

        function regeneratePuzzle(index){
            const puzzle=puzzles[index];
            if(puzzle.source!=='generated')return;

            let newPuzzle;
            if(puzzle.type==='9x9'){
                if(!window.Sudoku){
                    alert('Error: newsudoku.js is not loaded!');
                    return;
                }
                newPuzzle=window.Sudoku.generateSudoku(0.3,0.7,30);
            }else{
                if(!window.Sudoku6x6){
                    alert('Error: newsudoku6x6.js is not loaded!');
                    return;
                }
                newPuzzle=window.Sudoku6x6.generateSudoku(0.3,0.7,18);
            }

            puzzle.string=puzzle.type==='9x9'?
                window.Sudoku.convertToString(newPuzzle):
                window.Sudoku6x6.convertToString(newPuzzle);

            puzzle.difficulty=calculateDifficulty(puzzle.string,puzzle.type);
            updatePuzzleList();
        }

        function removePuzzle(index){
            if(confirm('Are you sure you want to remove this puzzle?')){
                puzzles.splice(index,1);
                updatePuzzleList();
            }
        }

        function sortPuzzles(method){
            if(method==='type'){
                puzzles.sort((a,b)=>{
                    if(a.type!==b.type)return a.type==='9x9'?-1:1;
                    return 0;
                });
            }else if(method==='difficulty'){
                puzzles.sort((a,b)=>{
                    const diffA=a.difficulty>=0?a.difficulty:999;
                    const diffB=b.difficulty>=0?b.difficulty:999;
                    return diffA-diffB;
                });
            }
            updatePuzzleList();
        }

        function renderPreview(s,t){
            if(t==='9x9'){
                if(!window.Sudoku)return'Error loading';
                const m=window.Sudoku.convertToMatrix(s);
                let h='';
                for(let i=0;i<9;i++){
                    h+=m[i].map(n=>n===0?'¬∑':n).join(' ');
                    if(i<8)h+='<br>';
                }
                return h;
            }else{
                if(!window.Sudoku6x6)return'Error loading';
                const m=window.Sudoku6x6.convertToMatrix(s);
                let h='';
                for(let i=0;i<6;i++){
                    h+=m[i].map(n=>n===0?'¬∑':n).join(' ');
                    if(i<5)h+='<br>';
                }
                return h;
            }
        }

        function updatePuzzleList(){
            const listDiv=document.getElementById('puzzle-list');
            
            if(puzzles.length===0){
                listDiv.innerHTML=`
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No puzzles yet. Add some to get started!</p>
                    </div>
                `;
            }else{
                listDiv.innerHTML=puzzles.map((puzzle,index)=>{
                    const diffDisplay=getDifficultyDisplay(puzzle.difficulty);
                    const diffClass=getDifficultyClass(puzzle.difficulty);
                    return`
                    <div class="puzzle-item">
                        <div class="puzzle-preview">${renderPreview(puzzle.string,puzzle.type)}</div>
                        <div class="puzzle-info">
                            <div class="puzzle-type">
                                ${puzzle.type} Sudoku
                                <span class="difficulty-badge ${diffClass}">${diffDisplay}</span>
                            </div>
                            <div class="puzzle-source">Source: ${puzzle.source==='generated'?'Generated':'Manual'}</div>
                        </div>
                        <div class="puzzle-actions">
                            <button class="btn-info" onclick="editPuzzle(${index})">‚úèÔ∏è</button>
                            ${puzzle.source==='generated'?
                                `<button class="btn-warning" onclick="regeneratePuzzle(${index})">üîÑ</button>`:''}
                            <button class="btn-danger" onclick="removePuzzle(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                `}).join('');
            }

            updateCapacity();
        }

        function updateCapacity(){
            const url=generateURL(false);
            const bytes=new Blob([url]).size;
            const percentage=Math.min((bytes/4000)*100,100);
            
            document.getElementById('capacity-text').textContent=`${bytes} / 4000 bytes`;
            const fill=document.getElementById('capacity-fill');
            fill.style.width=percentage+'%';
            fill.textContent=Math.round(percentage)+'%';
            
            fill.classList.remove('warning','danger');
            if(percentage>90){
                fill.classList.add('danger');
            }else if(percentage>70){
                fill.classList.add('warning');
            }
        }

        function generateURL(encrypt){
            const puzzleStrings=puzzles.map(p=>p.string);
            let data=puzzleStrings.join(',');
            
            if(encrypt){
                data=btoa(data);
            }
            
            return`https://ricky295.github.io/qrcodesudokuplayer?puzzles=${data}`;
        }

        function openExportModal(){
            if(puzzles.length===0){
                alert('Add some puzzles first!');
                return;
            }

            const encrypt=document.getElementById('encrypt-mode').checked;
            const url=generateURL(encrypt);
            
            document.getElementById('export-url').value=url;
            
            const qrDiv=document.getElementById('qrcode');
            qrDiv.innerHTML='';
            
            new QRCode(qrDiv,{
                text:url,
                width:256,
                height:256
            });
            
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal(){
            document.getElementById('exportModal').classList.remove('active');
        }

        function copyURL(){
            const textarea=document.getElementById('export-url');
            textarea.select();
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        }

        document.getElementById('encrypt-mode').addEventListener('change',()=>{
            if(document.getElementById('exportModal').classList.contains('active')){
                const encrypt=document.getElementById('encrypt-mode').checked;
                const url=generateURL(encrypt);
                document.getElementById('export-url').value=url;
                
                const qrDiv=document.getElementById('qrcode');
                qrDiv.innerHTML='';
                new QRCode(qrDiv,{
                    text:url,
                    width:256,
                    height:256
                });
            }
        });

        document.querySelectorAll('.modal').forEach(modal=>{
            modal.addEventListener('click',(e)=>{
                if(e.target===modal&&!isGenerating){
                    modal.classList.remove('active');
                }
            });
        });

        // Check if libraries are loaded on startup
        window.addEventListener('load',()=>{
            setTimeout(()=>{
                if(!window.Sudoku){
                    console.warn('Warning: newsudoku.js not loaded - 9x9 generation will not work');
                }
                if(!window.Sudoku6x6){
                    console.warn('Warning: newsudoku6x6.js not loaded - 6x6 generation will not work');
                }
            },100);
        });
    </script>
</body>
</html>
