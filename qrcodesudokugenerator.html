<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Sudoku Pack Generator</title>
    <!-- Dependencies -->
    <script src="newsudoku.js"></script>
    <script src="newsudoku6x6.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .capacity-transition { transition: width 0.3s ease-in-out; }
        .puzzle-card:hover .actions { opacity: 1; }
        .actions { opacity: 0.2; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-900">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white text-center">
            <h1 class="text-3xl font-bold">Sudoku Pack Generator</h1>
            <p class="text-indigo-100 mt-2 italic text-sm">
                Disclaimer: For genuinely difficult sudokus, please visit 
                <a href="https://sudoku.coach" target="_blank" class="underline font-bold hover:text-white">sudoku.coach</a>.
            </p>
        </div>

        <div class="p-6 space-y-8">
            <!-- Global Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="generateRandom('6x6')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded transition shadow-sm active:scale-95">
                    + Generate 6x6
                </button>
                <button onclick="generateRandom('9x9')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded transition shadow-sm active:scale-95">
                    + Generate 9x9
                </button>
                <button onclick="promptImport()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded transition shadow-sm active:scale-95">
                    Mass Import
                </button>
                <button onclick="sortPuzzles()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded transition shadow-sm active:scale-95">
                    Sort Puzzles
                </button>
            </div>

            <!-- Capacity Bar -->
            <div class="space-y-2 bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div class="flex justify-between text-sm font-medium text-slate-600">
                    <span>QR Data Load</span>
                    <span id="capacityLabel" class="font-mono">0 / 4000 bytes</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                    <div id="capacityBar" class="capacity-transition h-full bg-emerald-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Puzzle List Container -->
            <div class="space-y-3">
                <h3 class="text-lg font-bold text-slate-800 flex items-center justify-between">
                    Current Pack
                    <span id="puzzleCount" class="text-xs font-normal bg-slate-200 px-2 py-0.5 rounded-full">0 puzzles</span>
                </h3>
                <div id="puzzleList" class="space-y-3 min-h-[100px]">
                    <!-- Puzzles render here -->
                </div>
                <div id="emptyState" class="text-center py-10 text-slate-400 italic bg-slate-50 rounded-lg border-2 border-dashed border-slate-200">
                    No puzzles added yet. Generate or import some to begin!
                </div>
            </div>

            <!-- Export Section -->
            <div id="exportSection" class="hidden border-t pt-8 space-y-6">
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    <div class="flex-1 space-y-4 w-full">
                        <h3 class="text-xl font-bold text-slate-800">Export Pack</h3>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="encryptToggle" class="sr-only peer" onchange="renderExport()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                <span class="ms-3 text-sm font-medium text-slate-700">Encrypted (Base64)</span>
                            </label>
                        </div>
                        <textarea id="exportUrl" readonly class="w-full p-3 bg-slate-100 border rounded-lg font-mono text-[10px] break-all h-24 focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all" onclick="this.select()"></textarea>
                        <button onclick="copyUrl()" id="copyBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition active:scale-[0.98]">
                            Copy Pack URL
                        </button>
                    </div>

                    <div class="w-full md:w-64 flex flex-col items-center space-y-3 bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300 shadow-sm">
                        <span class="text-sm font-bold text-slate-500 uppercase">Live QR Preview</span>
                        <div id="qrcode" class="bg-white p-2 rounded shadow-sm"></div>
                        <p class="text-[10px] text-slate-400 text-center">Scan to open in player</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-lg w-full p-6 shadow-2xl space-y-4">
            <h2 id="modalTitle" class="text-xl font-bold text-slate-800">Modify Puzzle</h2>
            <textarea id="modalTextarea" class="w-full h-32 p-3 border border-slate-300 rounded-lg font-mono focus:ring-2 focus:ring-indigo-500 outline-none text-sm" placeholder="Enter puzzle string..."></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow transition">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let puzzles = [];
        const MAX_BYTES = 4000;
        let qrGenerator = null;

        // Initialize components
        window.onload = function() {
            const qrContainer = document.getElementById("qrcode");
            qrGenerator = new QRCode(qrContainer, {
                text: "https://ricky295.github.io/qrcodesudokuplayer",
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            renderList();
        };

        // Helper: Calculate Difficulty
        function getDifficulty(str) {
            if (!str) return 0;
            const zeros = (str.match(/0/g) || []).length;
            const total = str.length;
            return Math.round((zeros / total) * 100);
        }

        // --- Core Functions ---

        function generateRandom(type) {
            try {
                let string = "";
                if (type === '6x6') {
                    if (typeof Sudoku6x6 === 'undefined') throw new Error("Sudoku6x6 library missing");
                    const p = Sudoku6x6.generateSudoku(0.3, 0.7, 18);
                    string = Sudoku6x6.convertToString(p);
                } else {
                    if (typeof Sudoku === 'undefined') throw new Error("Sudoku 9x9 library missing");
                    const p = Sudoku.generateSudoku(0.3, 0.7, 25);
                    string = Sudoku.convertToString(p);
                }
                
                puzzles.push({
                    id: Date.now() + Math.random(),
                    type: type,
                    string: string,
                    generated: true
                });
                renderList();
            } catch (e) {
                console.error(e);
                alert("Error generating puzzle: " + e.message);
            }
        }

        function promptImport() {
            const val = prompt("Paste puzzle strings (36 or 81 chars each), separated by commas or new lines:");
            if (!val) return;
            
            const raw = val.split(/[,\n]/).map(s => s.trim()).filter(s => s.length > 0);
            let addedCount = 0;
            raw.forEach(str => {
                if (str.length === 36 || str.length === 81) {
                    puzzles.push({
                        id: Date.now() + Math.random(),
                        type: str.length === 36 ? '6x6' : '9x9',
                        string: str,
                        generated: false
                    });
                    addedCount++;
                }
            });
            if (addedCount > 0) renderList();
            else alert("No valid strings found. Lengths must be 36 (6x6) or 81 (9x9).");
        }

        function sortPuzzles() {
            puzzles.sort((a, b) => {
                // Primary sort: Type
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                // Secondary sort: Difficulty (Descending)
                return getDifficulty(b.string) - getDifficulty(a.string);
            });
            renderList();
        }

        function removePuzzle(id) {
            puzzles = puzzles.filter(p => p.id !== id);
            renderList();
        }

        function regeneratePuzzle(id) {
            const idx = puzzles.findIndex(p => p.id === id);
            if (idx === -1) return;
            const type = puzzles[idx].type;
            try {
                let string = "";
                if (type === '6x6') {
                    const p = Sudoku6x6.generateSudoku(0.3, 0.7, 18);
                    string = Sudoku6x6.convertToString(p);
                } else {
                    const p = Sudoku.generateSudoku(0.3, 0.7, 25);
                    string = Sudoku.convertToString(p);
                }
                puzzles[idx].string = string;
                renderList();
            } catch (e) {
                alert("Regeneration failed: " + e.message);
            }
        }

        function modifyPuzzle(id) {
            const puzzle = puzzles.find(p => p.id === id);
            if (!puzzle) return;

            const modal = document.getElementById('modalOverlay');
            const textarea = document.getElementById('modalTextarea');
            const confirmBtn = document.getElementById('modalConfirm');

            textarea.value = puzzle.string;
            modal.style.display = 'flex';
            
            confirmBtn.onclick = () => {
                const val = textarea.value.trim();
                if (val.length === 36 || val.length === 81) {
                    puzzle.string = val;
                    puzzle.type = val.length === 36 ? '6x6' : '9x9';
                    closeModal();
                    renderList();
                } else {
                    alert("Length must be 36 or 81.");
                }
            };
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // --- Rendering Logic ---

        function renderList() {
            const list = document.getElementById('puzzleList');
            const empty = document.getElementById('emptyState');
            const countLabel = document.getElementById('puzzleCount');
            const exportSection = document.getElementById('exportSection');
            
            if (!list || !empty || !countLabel || !exportSection) return;

            list.innerHTML = '';
            countLabel.innerText = `${puzzles.length} puzzles`;

            if (puzzles.length === 0) {
                empty.style.display = 'block';
                exportSection.style.display = 'none';
                updateCapacity(0);
                return;
            }

            empty.style.display = 'none';
            exportSection.style.display = 'block';

            let totalBytes = 0;

            puzzles.forEach((p, index) => {
                totalBytes += p.string.length + 1; // Content + delimiter
                const diff = getDifficulty(p.string);
                const card = document.createElement('div');
                card.className = "puzzle-card group flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-lg hover:border-indigo-300 transition-all shadow-sm";
                card.innerHTML = `
                    <div class="flex items-center space-x-4 min-w-0 flex-1">
                        <span class="text-xs font-bold w-6 h-6 flex items-center justify-center rounded bg-indigo-100 text-indigo-700 shrink-0">${index + 1}</span>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center space-x-2 flex-wrap">
                                <span class="text-sm font-bold text-slate-700 uppercase tracking-tighter">${p.type}</span>
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${diff > 50 ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}">
                                    Difficulty: ${diff}%
                                </span>
                            </div>
                            <div class="text-[10px] font-mono text-slate-400 truncate w-full">${p.string}</div>
                        </div>
                    </div>
                    <div class="actions flex space-x-1 ml-4 shrink-0">
                        <button onclick="modifyPuzzle(${p.id})" class="p-2 text-indigo-600 hover:bg-white hover:shadow-sm rounded transition" title="Modify">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        ${p.generated ? `
                        <button onclick="regeneratePuzzle(${p.id})" class="p-2 text-emerald-600 hover:bg-white hover:shadow-sm rounded transition" title="Regenerate">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>` : ''}
                        <button onclick="removePuzzle(${p.id})" class="p-2 text-rose-600 hover:bg-white hover:shadow-sm rounded transition" title="Remove">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });

            updateCapacity(totalBytes);
            renderExport();
        }

        function updateCapacity(bytes) {
            const label = document.getElementById('capacityLabel');
            const bar = document.getElementById('capacityBar');
            if (!label || !bar) return;

            const percent = Math.min((bytes / MAX_BYTES) * 100, 100);
            label.innerText = `${bytes} / ${MAX_BYTES} bytes`;
            bar.style.width = `${percent}%`;
            
            bar.classList.remove('bg-emerald-500', 'bg-amber-500', 'bg-rose-600');
            if (percent >= 100) bar.classList.add('bg-rose-600');
            else if (percent > 80) bar.classList.add('bg-amber-500');
            else bar.classList.add('bg-emerald-500');
        }

        function renderExport() {
            if (puzzles.length === 0) return;

            const isEncrypted = document.getElementById('encryptToggle').checked;
            const baseUrl = "https://ricky295.github.io/qrcodesudokuplayer";
            const puzzleData = puzzles.map(p => p.string).join(',');
            
            let urlParams = "";
            if (isEncrypted) {
                const b64 = btoa(puzzleData);
                urlParams = `?puzzles=${b64}&enc=true`;
            } else {
                urlParams = `?puzzles=${encodeURIComponent(puzzleData)}`;
            }

            const fullUrl = baseUrl + urlParams;
            const exportArea = document.getElementById('exportUrl');
            if (exportArea) exportArea.value = fullUrl;

            if (qrGenerator) {
                qrGenerator.clear();
                qrGenerator.makeCode(fullUrl);
            }
        }

        function copyUrl() {
            const copyText = document.getElementById("exportUrl");
            copyText.select();
            document.execCommand('copy');
            
            const btn = document.getElementById("copyBtn");
            const originalText = btn.innerText;
            btn.innerText = "Copied!";
            btn.classList.replace('bg-indigo-600', 'bg-emerald-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.replace('bg-emerald-600', 'bg-indigo-600');
            }, 2000);
        }
    </script>
</body>
</html>
