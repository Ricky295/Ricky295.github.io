<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Flux Player Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container { max-width: 500px; width: 100%; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title { font-size: 28px; font-weight: 700; color: #fff; }
        .title span {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .info { font-size: 11px; color: #94a3b8; margin-top: 4px; }
        .difficulty {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-weight: 600;
            color: #a5b4fc;
        }

        .grid-wrapper {
            background: #4a5568;
            padding: 3px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
        }

        .grid {
            display: grid;
            background: #4a5568;
            gap: 1px;
            width: 100%;
        }

        .grid.size-9 { grid-template-columns: repeat(9, 1fr); }
        .grid.size-6 { grid-template-columns: repeat(6, 1fr); }

        .cell {
            aspect-ratio: 1;
            background: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 5vw, 24px);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.1s;
            position: relative;
            user-select: none;
        }

        /* Highlight Logic */
        .cell.related { background: #2d3748; }
        .cell.same-value { background: rgba(102, 126, 234, 0.35); }
        .cell.selected { background: #667eea !important; color: white; }
        .cell.fixed { background: #0f172a; color: #94a3b8; }
        .cell.error { color: #ef4444; }

        /* Candidates (Pencil Marks) */
        .candidates {
            display: grid;
            width: 100%;
            height: 100%;
            padding: 2px;
            pointer-events: none;
        }
        .size-9 .candidates { grid-template-columns: repeat(3, 1fr); }
        .size-6 .candidates { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); }

        .candidate {
            font-size: clamp(7px, 2vw, 9px);
            color: #818cf8;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* Section Borders */
        .size-9 .cell:nth-child(3n):not(:nth-child(9n)) { border-right: 2px solid #667eea; }
        .size-9 .cell:nth-child(n+19):nth-child(-n+27),
        .size-9 .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #667eea; }

        .size-6 .cell:nth-child(3n):not(:nth-child(6n)) { border-right: 2px solid #667eea; }
        .size-6 .cell:nth-child(n+13):nth-child(-n+18),
        .size-6 .cell:nth-child(n+31):nth-child(-n+36) { border-bottom: 2px solid #667eea; }

        /* Controls */
        .controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px; }
        .num-btn {
            height: 48px;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .num-btn:active { background: #667eea; transform: scale(0.95); }

        .toolbar { display: flex; gap: 8px; margin-bottom: 12px; }
        .tool-btn {
            flex: 1;
            height: 44px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .tool-btn.active { background: #6366f1; color: white; border-color: #818cf8; }

        .toast {
            position: fixed;
            bottom: 40px;
            background: white;
            color: #000;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 700;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="title">Sudoku <span>Flux</span></div>
                <div class="info">
                    <span id="puzzle-info">Initializing...</span>
                    <span id="difficulty" class="difficulty">0%</span>
                </div>
            </div>
            <div style="display: flex; gap: 6px;">
                <button class="num-btn" style="width: 40px;" onclick="navigate(-1)">‚Äπ</button>
                <button class="num-btn" style="width: 40px;" onclick="navigate(1)">‚Ä∫</button>
            </div>
        </header>

        <div class="grid-wrapper">
            <div id="grid" class="grid"></div>
        </div>

        <div class="toolbar">
            <button id="pencil-toggle" class="tool-btn" onclick="togglePencil()">
                <span>‚úèÔ∏è</span> Pencil Mode (P)
            </button>
            <button class="tool-btn" onclick="clearCell()">Clear</button>
        </div>

        <div class="controls" id="numpad"></div>
        
        <button class="num-btn" style="width: 100%; margin-top: 8px; background: #6366f1;" onclick="verify()">Verify Solution</button>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Logic imports from uploaded files -->
    <script src="newsudoku.js"></script>
    <script src="newsudoku6x6.js"></script>

    <script>
        let puzzles = [];
        let currentIndex = 0;
        let selectedIdx = null;
        let size = 9;
        let board = [];
        let pencilMode = false;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            let raw = params.get('puzzles');
            if (!raw) {
                document.getElementById('puzzle-info').textContent = "No Puzzles Found";
                return;
            }
            try { if (!raw.includes(',')) raw = atob(raw); } catch(e) {}
            puzzles = raw.split(',').filter(s => s.length === 81 || s.length === 36);
            if (puzzles.length > 0) loadPuzzle(0);
        };

        function loadPuzzle(idx) {
            currentIndex = idx;
            const s = puzzles[idx];
            size = s.length === 81 ? 9 : 6;
            board = s.split('').map(v => ({
                val: parseInt(v),
                fixed: v !== '0',
                notes: new Set()
            }));
            selectedIdx = 0; // Default selection
            render();
            updateMeta(s);
        }

        function togglePencil() {
            pencilMode = !pencilMode;
            document.getElementById('pencil-toggle').classList.toggle('active', pencilMode);
        }

        function render() {
            const grid = document.getElementById('grid');
            grid.className = `grid size-${size}`;
            grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            grid.innerHTML = '';

            const selectedCell = selectedIdx !== null ? board[selectedIdx] : null;
            const selectedVal = selectedCell ? (selectedCell.val || 0) : 0;

            board.forEach((cell, i) => {
                const div = document.createElement('div');
                div.className = `cell ${cell.fixed ? 'fixed' : ''}`;
                
                // --- Highlighting Logic ---
                if (selectedIdx !== null) {
                    if (i === selectedIdx) {
                        div.classList.add('selected');
                    } else {
                        const r = Math.floor(i / size), c = i % size;
                        const sr = Math.floor(selectedIdx / size), sc = selectedIdx % size;
                        
                        // Row/Col/Box calculation
                        const isSameRow = r === sr;
                        const isSameCol = c === sc;
                        let isSameBox = false;
                        if (size === 9) {
                            isSameBox = Math.floor(r/3) === Math.floor(sr/3) && Math.floor(c/3) === Math.floor(sc/3);
                        } else {
                            // 6x6 uses 2x3 boxes (2 rows, 3 cols)
                            isSameBox = Math.floor(r/2) === Math.floor(sr/2) && Math.floor(c/3) === Math.floor(sc/3);
                        }

                        if (isSameRow || isSameCol || isSameBox) div.classList.add('related');
                        if (selectedVal > 0 && cell.val === selectedVal) div.classList.add('same-value');
                    }
                }

                if (cell.val !== 0) {
                    div.textContent = cell.val;
                } else if (cell.notes.size > 0) {
                    const notesDiv = document.createElement('div');
                    notesDiv.className = 'candidates';
                    for (let n = 1; n <= size; n++) {
                        const nEl = document.createElement('div');
                        nEl.className = 'candidate';
                        nEl.textContent = cell.notes.has(n) ? n : '';
                        notesDiv.appendChild(nEl);
                    }
                    div.appendChild(notesDiv);
                }

                div.onclick = () => { selectedIdx = i; render(); };
                grid.appendChild(div);
            });

            // Update Controls
            const pad = document.getElementById('numpad');
            pad.innerHTML = '';
            for (let i = 1; i <= size; i++) {
                const b = document.createElement('button');
                b.className = 'num-btn';
                b.textContent = i;
                b.onclick = () => inputNumber(i);
                pad.appendChild(b);
            }
        }

        function inputNumber(num) {
            if (selectedIdx === null || board[selectedIdx].fixed) return;

            if (pencilMode) {
                if (board[selectedIdx].val !== 0) return;
                if (board[selectedIdx].notes.has(num)) board[selectedIdx].notes.delete(num);
                else board[selectedIdx].notes.add(num);
            } else {
                // Toggle value
                const oldVal = board[selectedIdx].val;
                board[selectedIdx].val = (oldVal === num) ? 0 : num;
                board[selectedIdx].notes.clear();
                
                if (board[selectedIdx].val !== 0) {
                    autoRemoveCandidates(selectedIdx, num);
                }
            }
            render();
        }

        function autoRemoveCandidates(idx, num) {
            const r = Math.floor(idx / size), c = idx % size;
            for (let i = 0; i < size * size; i++) {
                const ir = Math.floor(i / size), ic = i % size;
                
                let sameBox = false;
                if (size === 9) {
                    sameBox = Math.floor(ir/3) === Math.floor(r/3) && Math.floor(ic/3) === Math.floor(c/3);
                } else {
                    sameBox = Math.floor(ir/2) === Math.floor(r/2) && Math.floor(ic/3) === Math.floor(c/3);
                }

                if (ir === r || ic === c || sameBox) {
                    board[i].notes.delete(num);
                }
            }
        }

        function clearCell() {
            if (selectedIdx === null || board[selectedIdx].fixed) return;
            board[selectedIdx].val = 0;
            board[selectedIdx].notes.clear();
            render();
        }

        function navigate(dir) {
            let n = currentIndex + dir;
            if (n < 0) n = puzzles.length - 1;
            if (n >= puzzles.length) n = 0;
            loadPuzzle(n);
        }

        function updateMeta(puzzleStr) {
            document.getElementById('puzzle-info').textContent = `Puzzle ${currentIndex+1} of ${puzzles.length} (${size}x${size})`;
            
            // Use external logic for difficulty if available
            let diff = 0;
            try {
                if (size === 9 && window.Sudoku) {
                    const matrix = window.Sudoku.convertToMatrix(puzzleStr);
                    diff = window.Sudoku.solveWithSingles(matrix, true);
                } else if (size === 6 && window.Sudoku6x6) {
                    const matrix = window.Sudoku6x6.convertToMatrix(puzzleStr);
                    diff = window.Sudoku6x6.solveWithSingles(matrix, true);
                }
            } catch (e) {
                // Fallback basic difficulty
                const clues = board.filter(c => c.fixed).length;
                diff = (1 - (clues / (size * size)));
            }
            
            document.getElementById('difficulty').textContent = `${(diff * 100).toFixed(1)}% Difficulty`;
        }

        function verify() {
            const vals = board.map(c => c.val);
            if (vals.includes(0)) return showToast("Grid is incomplete!");
            
            let error = false;
            // Check rows & columns
            for (let i = 0; i < size; i++) {
                let row = new Set(), col = new Set();
                for (let j = 0; j < size; j++) {
                    row.add(vals[i * size + j]);
                    col.add(vals[j * size + i]);
                }
                if (row.size !== size || col.size !== size) error = true;
            }

            // Check Boxes
            const boxRows = size === 9 ? 3 : 2;
            const boxCols = 3;
            for (let br = 0; br < size; br += boxRows) {
                for (let bc = 0; bc < size; bc += boxCols) {
                    let box = new Set();
                    for (let r = 0; r < boxRows; r++) {
                        for (let c = 0; c < boxCols; c++) {
                            box.add(vals[(br + r) * size + (bc + c)]);
                        }
                    }
                    if (box.size !== size) error = true;
                }
            }
            
            showToast(error ? "‚ùå There are conflicts!" : "üéâ Perfect Solution!");
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        document.addEventListener('keydown', (e) => {
            // Numbers
            if (e.key >= '1' && e.key <= size.toString()) {
                inputNumber(parseInt(e.key));
            }
            // Deletion
            if (e.key === 'Backspace' || e.key === 'Delete') {
                clearCell();
            }
            // Toggle pencil
            if (e.key.toLowerCase() === 'p') {
                togglePencil();
            }

            // Arrow movement (infinite/free)
            if (e.key.startsWith('Arrow')) {
                if (selectedIdx === null) selectedIdx = 0;
                let r = Math.floor(selectedIdx / size);
                let c = selectedIdx % size;

                if (e.key === 'ArrowUp') r = (r - 1 + size) % size;
                if (e.key === 'ArrowDown') r = (r + 1) % size;
                if (e.key === 'ArrowLeft') c = (c - 1 + size) % size;
                if (e.key === 'ArrowRight') c = (c + 1) % size;

                selectedIdx = r * size + c;
                render();
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
