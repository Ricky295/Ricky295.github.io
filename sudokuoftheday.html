<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sudoku of the Day</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Comic Sans MS', 'Comic Sans', cursive;
    background: #fef9ec;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 39px, #f0e8d0 39px, #f0e8d0 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, #f0e8d0 39px, #f0e8d0 40px);
  }

  header { text-align: center; margin-bottom: 14px; }
  .title { font-size: 2rem; color: #c0392b; text-shadow: 3px 3px 0px #f39c12; letter-spacing: 2px; }
  .subtitle { font-size: 0.85rem; color: #7f8c8d; margin-top: 2px; }

  /* date selector row */
  .date-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .date-badge {
    display: inline-block;
    background: #c0392b;
    color: white;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 3px solid #922b21;
    cursor: default;
  }
  .date-nav {
    background: white;
    border: 3px solid #2c3e50;
    border-radius: 50%;
    width: 34px; height: 34px;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 2px 2px 0 #2c3e50;
    transition: transform .1s, box-shadow .1s;
    font-family: 'Comic Sans MS', cursive;
  }
  .date-nav:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #2c3e50; }
  .date-nav:disabled { opacity: 0.3; cursor: default; }
  input[type="date"].date-picker {
    font-family: 'Comic Sans MS', cursive;
    font-size: 0.8rem;
    border: 3px solid #2c3e50;
    border-radius: 10px;
    padding: 4px 8px;
    background: white;
    cursor: pointer;
    box-shadow: 2px 2px 0 #2c3e50;
    color: #2c3e50;
  }

  /* past-date banner */
  .past-banner {
    display: none;
    width: 100%;
    max-width: 420px;
    background: #fde8c8;
    border: 3px solid #f39c12;
    border-radius: 10px;
    padding: 8px 14px;
    text-align: center;
    font-size: 0.85rem;
    color: #b7770d;
    box-shadow: 3px 3px 0 #f39c12;
  }
  .past-banner.show { display: block; }

  /* game area */
  #gameArea {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 100%;
    max-width: 420px;
  }

  /* top bar */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: white;
    border: 3px solid #2c3e50;
    border-radius: 12px;
    padding: 8px 18px;
    box-shadow: 4px 4px 0 #f39c12;
  }
  #timer { font-size: 1.8rem; color: #2c3e50; font-weight: bold; }
  #scoreDisplay { font-size: 1.1rem; font-weight: bold; color: #2c3e50; text-align: right; }
  #scoreDisplay span { font-size: 1.6rem; display: block; color: #8e44ad; }
  #diffLabel {
    font-size: 1.1rem;
    font-weight: bold;
    letter-spacing: 1px;
    transition: color .3s;
  }

  /* board */
  #board {
    border-collapse: collapse;
    border: 4px solid #2c3e50;
    background: white;
    box-shadow: 6px 6px 0 #c0392b;
    width: 100%;
    max-width: 420px;
    table-layout: fixed;
  }
  #board td {
    width: calc(min(420px, 100vw - 32px) / 9);
    height: calc(min(420px, 100vw - 32px) / 9);
    border: 1px solid #bdc3c7;
    text-align: center;
    vertical-align: middle;
    font-family: 'Comic Sans MS', cursive;
    font-size: clamp(0.9rem, 4vw, 1.4rem);
    cursor: pointer;
    position: relative;
    transition: background 0.1s;
  }
  #board td:nth-child(3n)    { border-right: 3px solid #2c3e50; }
  #board tr:nth-child(3n) td { border-bottom: 3px solid #2c3e50; }
  #board td.given       { color: #2c3e50; font-weight: bold; background: #f2f2f2; }
  #board td.user-filled { color: #c0392b; }
  #board td.selected    { background: #fde8c8 !important; }
  #board td.highlight   { background: #fef5e7; }
  #board td.hint-cell   { background: #d5f5e3 !important; color: #1e8449; }
  .notes-grid {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    grid-template-rows: repeat(3,1fr);
    width: 100%; height: 100%;
    padding: 1px;
    position: absolute; top:0; left:0;
    pointer-events: none;
  }
  .note-num {
    font-size: clamp(0.35rem, 1.5vw, 0.55rem);
    color: #7f8c8d;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Comic Sans MS', cursive;
  }

  /* numpad */
  .numpad {
    display: grid;
    grid-template-columns: repeat(9,1fr);
    gap: 5px;
    width: 100%;
  }
  .num-btn {
    aspect-ratio: 1;
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    font-family: 'Comic Sans MS', cursive;
    font-size: clamp(1rem, 4vw, 1.3rem);
    cursor: pointer;
    background: white;
    font-weight: bold;
    color: #2c3e50;
    box-shadow: 3px 3px 0 #bdc3c7;
    transition: transform 0.1s;
  }
  .num-btn:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 #bdc3c7; }
  .num-btn:hover  { background: #fde8c8; border-color: #f39c12; }
  .num-btn.used   { opacity: 0.3; }

  /* action buttons */
  .actions {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 8px;
    width: 100%;
  }
  .btn {
    padding: 10px 6px;
    border: 3px solid #2c3e50;
    border-radius: 10px;
    font-family: 'Comic Sans MS', cursive;
    font-size: 0.85rem;
    cursor: pointer;
    box-shadow: 3px 3px 0 #2c3e50;
    font-weight: bold;
    transition: transform 0.1s, box-shadow 0.1s;
    text-align: center;
  }
  .btn:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 #2c3e50; }
  .btn-hint  { background: #27ae60; color: white; }
  .btn-check { background: #f39c12; color: white; }
  .btn-clear { background: #ecf0f1; color: #2c3e50; }
  .btn-notes { background: #8e44ad; color: white; }
  .btn-notes.active { background: #6c3483; }
  .btn-erase { background: #e74c3c; color: white; }

  /* feedback */
  .message { display: none; width: 100%; background: white; border: 3px solid #27ae60; border-radius: 10px; padding: 10px; box-shadow: 3px 3px 0 #27ae60; text-align: center; color: #1e8449; font-size: 0.9rem; }
  .message.err  { border-color: #e74c3c; color: #e74c3c; box-shadow: 3px 3px 0 #e74c3c; }
  .message.show { display: block; }
  .hint-box { width: 100%; background: white; border: 3px solid #8e44ad; border-radius: 10px; padding: 10px; box-shadow: 3px 3px 0 #8e44ad; font-size: 0.85rem; color: #6c3483; display: none; }
  .hint-box.show { display: block; }

  #loading { font-size: 1.5rem; color: #c0392b; margin: 40px 0; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* congrats */
  .congrats { display: none; position: fixed; inset:0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
  .congrats.show { display: flex; }
  .congrats-box { background: white; border: 5px solid #f39c12; border-radius: 20px; padding: 36px; text-align: center; box-shadow: 10px 10px 0 #c0392b; max-width: 320px; width: 90%; }
  .congrats-box h2 { font-size: 2rem; color: #c0392b; margin-bottom: 10px; }
  .congrats-box p  { color: #7f8c8d; margin-bottom: 16px; }
  .confetti { font-size: 2.5rem; margin-bottom: 10px; }
</style>
</head>
<body>

<header>
  <div class="title">‚òÄÔ∏è Sudoku of the Day ‚òÄÔ∏è</div>
  <div class="subtitle">a new puzzle every day, in comic sans, obviously</div>
  <div class="date-row">
    <button class="date-nav" id="btnPrev" onclick="shiftDay(-1)">‚óÄ</button>
    <div class="date-badge" id="dateBadge">Loading...</div>
    <button class="date-nav" id="btnNext" onclick="shiftDay(1)" disabled>‚ñ∂</button>
    <input type="date" class="date-picker" id="datePicker" onchange="pickDate(this.value)">
  </div>
</header>

<div id="loading">Generating puzzle... üé≤</div>
<div class="past-banner" id="pastBanner"></div>

<div id="gameArea">
  <div class="top-bar">
    <div id="timer">0:00</div>
    <div id="diffLabel">‚Äî</div>
    <div id="scoreDisplay">score<span id="scoreLive">‚Äî</span></div>
  </div>
  <table id="board"></table>
  <div class="numpad" id="numpad"></div>
  <div class="actions">
    <button class="btn btn-notes" id="notesBtn" onclick="toggleNotes()">üìù Notes: OFF</button>
    <button class="btn btn-erase" onclick="eraseCell()">üßπ Erase</button>
    <button class="btn btn-hint"  onclick="getHint()">üí° Hint</button>
    <button class="btn btn-check" onclick="checkBoard()">‚úÖ Check</button>
    <button class="btn btn-clear" onclick="clearErrors()">‚ùå Clear</button>
  </div>
  <div class="message"  id="message"></div>
  <div class="hint-box" id="hintBox"></div>
</div>

<div class="congrats" id="congrats">
  <div class="congrats-box">
    <div class="confetti">üéâüéäü•≥</div>
    <h2>You did it!!</h2>
    <p>Solved in <strong id="finalTime"></strong>!</p>
    <p>Score: <strong id="finalScore" style="color:#8e44ad;font-size:1.3rem"></strong></p>
    <p style="font-size:0.75rem;color:#bdc3c7">hints: √ó0.9 each ¬∑ mistakes: √ó0.95 each</p>
    <p style="font-size:0.8rem;color:#bdc3c7">Come back tomorrow for a new one üòä</p>
    <button class="btn btn-hint" style="margin-top:10px;width:100%" onclick="document.getElementById('congrats').classList.remove('show')">Close</button>
  </div>
</div>

<script>
// ===== newsudoku.js core =====
function range1To9(){return[1,2,3,4,5,6,7,8,9];}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function deepCopyBoard(b){return b.map(r=>[...r]);}

function getPossibleValues(board,row,col){
  if(board[row][col]!==0)return[];
  const used=new Set();
  for(let c=0;c<9;c++)used.add(board[row][c]);
  for(let r=0;r<9;r++)used.add(board[r][col]);
  const sr=Math.floor(row/3)*3,sc=Math.floor(col/3)*3;
  for(let r=sr;r<sr+3;r++)for(let c=sc;c<sc+3;c++)used.add(board[r][c]);
  const p=[];for(let n=1;n<=9;n++)if(!used.has(n))p.push(n);return p;
}

function boxHasNum(grid,r,c,num){
  const sr=Math.floor(r/3)*3,sc=Math.floor(c/3)*3;
  for(let rb=sr;rb<sr+3;rb++)for(let cb=sc;cb<sc+3;cb++)if(grid[rb][cb]===num)return true;
  return false;
}

function solveGridRandom(grid){
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      if(grid[r][c]===0){
        const nums=shuffle(range1To9());
        for(const num of nums){
          let ok=true;
          if(grid[r].includes(num))ok=false;
          if(ok)for(let i=0;i<9;i++)if(grid[i][c]===num){ok=false;break;}
          if(ok&&boxHasNum(grid,r,c,num))ok=false;
          if(ok){grid[r][c]=num;if(solveGridRandom(grid))return true;grid[r][c]=0;}
        }
        return false;
      }
    }
  }
  return true;
}

function generateSolutionRandom(){
  const s=Array(9).fill(null).map(()=>Array(9).fill(0));
  solveGridRandom(s);return s;
}

function eliminatePoss(poss,r,c,val,puzzle){
  let contra=false;
  for(let i=0;i<9;i++){
    if(poss[r][i].has(val)){poss[r][i].delete(val);if(poss[r][i].size===0&&puzzle[r][i]===0)contra=true;}
    if(poss[i][c].has(val)){poss[i][c].delete(val);if(poss[i][c].size===0&&puzzle[i][c]===0)contra=true;}
  }
  const sr=Math.floor(r/3)*3,sc=Math.floor(c/3)*3;
  for(let rb=sr;rb<sr+3;rb++)for(let cb=sc;cb<sc+3;cb++)if(poss[rb][cb].has(val)){poss[rb][cb].delete(val);if(poss[rb][cb].size===0&&puzzle[rb][cb]===0)contra=true;}
  return contra;
}

function findHiddenSingles(puzzle,poss,type,idx){
  const upd=[],unitPoss={};
  for(let n=1;n<=9;n++)unitPoss[n]=[];
  let coords=[];
  if(type==='row')coords=Array(9).fill(null).map((_,c)=>[idx,c]);
  else if(type==='col')coords=Array(9).fill(null).map((_,r)=>[r,idx]);
  else{const sr=Math.floor(idx/3)*3,sc=(idx%3)*3;for(let r=sr;r<sr+3;r++)for(let c=sc;c<sc+3;c++)coords.push([r,c]);}
  for(const [r,c] of coords)if(puzzle[r][c]===0)for(const n of poss[r][c])unitPoss[n].push([r,c]);
  for(const [n,locs] of Object.entries(unitPoss))if(locs.length===1){const [r,c]=locs[0];if(puzzle[r][c]===0)upd.push([r,c,parseInt(n)]);}
  return upd;
}

function findNakedSingles(puzzle,poss){
  const upd=[];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(puzzle[r][c]===0&&poss[r][c].size===1)upd.push([r,c,[...poss[r][c]][0]]);
  return upd;
}

function applyUpdates(type,puzzle,poss,empty){
  let updates=[];
  if(type==='BoxHS')for(let b=0;b<9;b++)updates=updates.concat(findHiddenSingles(puzzle,poss,'box',b));
  else if(type==='LineHS')for(let i=0;i<9;i++)updates=updates.concat(findHiddenSingles(puzzle,poss,'row',i),findHiddenSingles(puzzle,poss,'col',i));
  else updates=findNakedSingles(puzzle,poss);
  if(updates.length===0)return[empty,false];
  const seen=new Set(),uniq=[];
  for(const [r,c,v] of updates){const k=r+','+c+','+v;if(!seen.has(k)){seen.add(k);uniq.push([r,c,v]);}}
  let contra=false;
  for(const [r,c,v] of uniq)if(puzzle[r][c]===0){puzzle[r][c]=v;empty--;if(eliminatePoss(poss,r,c,v,puzzle))contra=true;poss[r][c]=new Set();}
  return[empty,contra];
}

function solveWithSingles(sudoku,retDiff){
  const puzzle=deepCopyBoard(sudoku);
  const init=puzzle.flat().filter(x=>x===0).length;
  let highest=0;
  if(init===0)return retDiff?0.0:puzzle;
  const poss=Array(9).fill(null).map(()=>Array(9).fill(null).map(()=>new Set()));
  let empty=0;
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    if(puzzle[r][c]===0){poss[r][c]=new Set(getPossibleValues(puzzle,r,c));if(poss[r][c].size===0)return retDiff?-0.2:sudoku;empty++;}
    else poss[r][c]=new Set();
  }
  let steps=0,contra=false;
  while(empty>0){
    const p0=empty;[empty,contra]=applyUpdates('BoxHS',puzzle,poss,empty);
    if(empty<p0){steps++;if(contra)break;continue;}
    highest=Math.max(1,highest);
    const p1=empty;[empty,contra]=applyUpdates('LineHS',puzzle,poss,empty);
    if(empty<p1){steps++;if(contra)break;continue;}
    highest=2;
    const p2=empty;[empty,contra]=applyUpdates('NakedSingle',puzzle,poss,empty);
    if(empty<p2){steps++;if(contra)break;continue;}
    break;
  }
  if(contra)return retDiff?-0.2:sudoku;
  if(empty===0){const d=init>0?steps/init:0;return retDiff?(d+highest)/3:puzzle;}
  return retDiff?-0.1:sudoku;
}

function generateSudoku(minD,maxD,targetClues,maxAttempts){
  targetClues=targetClues||25;maxAttempts=maxAttempts||100;
  for(let att=0;att<maxAttempts;att++){
    const sol=generateSolutionRandom(),puzzle=deepCopyBoard(sol);
    const pos=[];for(let r=0;r<9;r++)for(let c=0;c<9;c++)pos.push([r,c]);shuffle(pos);
    let clues=81;
    for(const [r,c] of pos){
      if(clues<=targetClues)break;
      const orig=puzzle[r][c];puzzle[r][c]=0;
      const d=solveWithSingles(puzzle,true);
      if(d<0)puzzle[r][c]=orig;
      else{clues--;if(clues<=targetClues&&d>=minD&&d<=maxD)return puzzle;}
    }
    const fd=solveWithSingles(puzzle,true);
    if(fd>=minD&&fd<=maxD&&clues<=targetClues+5)return puzzle;
  }
  const sol=generateSolutionRandom(),puzzle=deepCopyBoard(sol);
  const pos=[];for(let r=0;r<9;r++)for(let c=0;c<9;c++)pos.push([r,c]);shuffle(pos);
  let clues=81;
  for(const [r,c] of pos){
    if(clues<=targetClues)break;
    const orig=puzzle[r][c];puzzle[r][c]=0;
    const d=solveWithSingles(puzzle,true);
    if(d<0)puzzle[r][c]=orig;else clues--;
  }
  return puzzle;
}

function seededRandom(seed){let s=seed;return function(){s=Math.sin(s)*10000;return s-Math.floor(s);};}
function hashCode(str){let h=0;for(let i=0;i<str.length;i++){const c=str.charCodeAt(i);h=((h<<5)-h)+c;h=h&h;}return Math.abs(h);}

function generateDailySudoku(date){
  const ds=dateToKey(date);
  const orig=Math.random;Math.random=seededRandom(hashCode(ds));
  const puzzle=generateSudoku(0.3,0.7,30);Math.random=orig;return puzzle;
}

function getSortedHS(puzzle,poss,type){
  for(const num of range1To9()){
    for(let idx=0;idx<9;idx++){
      let coords=[];
      if(type==='row')coords=Array(9).fill(null).map((_,c)=>[idx,c]);
      else if(type==='col')coords=Array(9).fill(null).map((_,r)=>[r,idx]);
      else{const sr=Math.floor(idx/3)*3,sc=(idx%3)*3;for(let r=sr;r<sr+3;r++)for(let c=sc;c<sc+3;c++)coords.push([r,c]);}
      const locs=[];
      for(const [r,c] of coords)if(puzzle[r][c]===0&&poss[r][c].has(num))locs.push([r,c]);
      if(locs.length===1)return[locs[0][0],locs[0][1],num];
    }
  }
  return null;
}

function hint(sudoku){
  const puzzle=deepCopyBoard(sudoku);
  const poss=Array(9).fill(null).map(()=>Array(9).fill(null).map(()=>new Set()));
  const empty=[];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    if(puzzle[r][c]===0){poss[r][c]=new Set(getPossibleValues(puzzle,r,c));if(poss[r][c].size===0)return["Contradiction",[r,c],0];empty.push([r,c]);}
  }
  if(empty.length===0)return["Solved",[-1,-1],0];
  let u=getSortedHS(puzzle,poss,'box');if(u)return["Box HS",[u[0],u[1]],u[2]];
  u=getSortedHS(puzzle,poss,'row');if(u)return["Line HS",[u[0],u[1]],u[2]];
  u=getSortedHS(puzzle,poss,'col');if(u)return["Line HS",[u[0],u[1]],u[2]];
  const ns=findNakedSingles(puzzle,poss);
  if(ns.length>0)return["Naked Single",[ns[0][0],ns[0][1]],ns[0][2]];
  return["Stuck",[-1,-1],0];
}

// ===== Date helpers =====
function dateToKey(d){
  // YYYY-MM-DD in local time
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return y+'-'+m+'-'+dd;
}
function keyToDate(key){
  const [y,m,d]=key.split('-').map(Number);
  return new Date(y,m-1,d);
}
function todayKey(){return dateToKey(new Date());}
function formatBadge(d){
  return d.toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'long',day:'numeric'});
}
function formatShort(d){
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

// ===== Difficulty display =====
function diffColor(pct){
  // 0% = green #27ae60, 50% = yellow #f39c12, 100% = red #e74c3c
  // interpolate green->yellow then yellow->red
  if(pct<=50){
    const t=pct/50;
    const r=Math.round(39+(243-39)*t);
    const g=Math.round(174+(156-174)*t);
    const b=Math.round(96+(18-96)*t);
    return'rgb('+r+','+g+','+b+')';
  } else {
    const t=(pct-50)/50;
    const r=Math.round(243+(231-243)*t);
    const g=Math.round(156+(76-156)*t);
    const b=Math.round(18+(60-18)*t);
    return'rgb('+r+','+g+','+b+')';
  }
}
function showDifficulty(rawScore){
  // rawScore is 0.0‚Äì1.0 from solveWithSingles
  const pct=Math.round(Math.min(Math.max(rawScore,0),1)*1000)/10;
  const el=document.getElementById('diffLabel');
  el.textContent=pct.toFixed(1)+'% difficulty';
  el.style.color=diffColor(pct);
}

// ===== Game State =====
let puzzle=null,board=null,solution=null;
let notes=Array(9).fill(null).map(()=>Array(9).fill(null).map(()=>new Set()));
let selected=null,notesMode=false,solved=false,seconds=0;
let timerInterval=null,currentKey=todayKey();
let mistakes=0,hintsUsed=0,diffScore=0;

function calcScore(){
  if(seconds===0||diffScore===0)return 0;
  const minutes=Math.max(seconds/60,0.1);
  const raw=(1e6*diffScore)/minutes;
  const penalized=raw*Math.pow(0.95,mistakes)*Math.pow(0.9,hintsUsed);
  return Math.min(Math.round(penalized),1000);
}

function updateScore(){
  const el=document.getElementById('scoreLive');
  if(!puzzle||solved){return;}
  el.textContent=calcScore();
}

// ===== Init =====
window.onload=function(){
  // Set date picker max to today
  const picker=document.getElementById('datePicker');
  picker.max=todayKey();
  picker.value=todayKey();
  loadPuzzle(currentKey);
};

function loadPuzzle(key){
  currentKey=key;
  const today=todayKey();
  const isToday=key===today;

  // Update badge
  document.getElementById('dateBadge').textContent=formatBadge(keyToDate(key));

  // Update nav buttons
  document.getElementById('btnNext').disabled=isToday;

  // Past banner
  const banner=document.getElementById('pastBanner');
  if(isToday){
    banner.classList.remove('show');
  } else {
    banner.textContent='üìÖ Playing the puzzle from '+formatShort(keyToDate(key));
    banner.classList.add('show');
  }

  // Reset state
  clearInterval(timerInterval);
  seconds=0;solved=false;selected=null;notesMode=false;
  notes=Array(9).fill(null).map(()=>Array(9).fill(null).map(()=>new Set()));
  document.getElementById('timer').textContent='0:00';
  document.getElementById('diffLabel').textContent='‚Äî';
  document.getElementById('diffLabel').style.color='';
  document.getElementById('scoreLive').textContent='‚Äî';
  mistakes=0;hintsUsed=0;diffScore=0;
  document.getElementById('notesBtn').textContent='üìù Notes: OFF';
  document.getElementById('notesBtn').classList.remove('active');
  document.getElementById('message').classList.remove('show');
  document.getElementById('hintBox').classList.remove('show');
  document.getElementById('gameArea').style.display='none';
  document.getElementById('loading').style.display='block';

  setTimeout(function(){
    puzzle=generateDailySudoku(keyToDate(key));
    board=deepCopyBoard(puzzle);
    solution=solveWithSingles(puzzle);
    const diff=solveWithSingles(puzzle,true);
    diffScore=diff>=0?diff:1;
    showDifficulty(diffScore);

    document.getElementById('loading').style.display='none';
    document.getElementById('gameArea').style.display='flex';
    renderBoard();buildNumpad();startTimer();
  },50);
}

function shiftDay(delta){
  const d=keyToDate(currentKey);
  d.setDate(d.getDate()+delta);
  const newKey=dateToKey(d);
  // Don't go into the future
  if(newKey>todayKey())return;
  document.getElementById('datePicker').value=newKey;
  loadPuzzle(newKey);
}

function pickDate(val){
  if(!val)return;
  if(val>todayKey())return;
  loadPuzzle(val);
}

// ===== Timer =====
function startTimer(){
  timerInterval=setInterval(function(){
    if(solved)return;
    seconds++;
    const m=Math.floor(seconds/60),s=seconds%60;
    document.getElementById('timer').textContent=m+':'+(s<10?'0':'')+s;
    updateScore();
  },1000);
}

// ===== Board =====
function renderBoard(){
  const tbl=document.getElementById('board');tbl.innerHTML='';
  for(let r=0;r<9;r++){
    const tr=document.createElement('tr');
    for(let c=0;c<9;c++){
      const td=document.createElement('td');
      td.dataset.r=r;td.dataset.c=c;
      const isGiven=puzzle[r][c]!==0;
      if(isGiven){td.textContent=puzzle[r][c];td.classList.add('given');}
      else if(board[r][c]!==0){td.textContent=board[r][c];td.classList.add('user-filled');}
      else{
        const cn=notes[r][c];
        if(cn.size>0){
          const g=document.createElement('div');g.className='notes-grid';
          for(let n=1;n<=9;n++){const sp=document.createElement('span');sp.className='note-num';sp.textContent=cn.has(n)?n:'';g.appendChild(sp);}
          td.appendChild(g);
        }
      }
      if(selected&&selected[0]===r&&selected[1]===c){td.classList.add('selected');}
      else if(selected){
        const sr=selected[0],sc=selected[1];
        if(r===sr||c===sc||(Math.floor(r/3)===Math.floor(sr/3)&&Math.floor(c/3)===Math.floor(sc/3)))td.classList.add('highlight');
      }
      td.addEventListener('click',function(){selectCell(r,c);});
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
}

function selectCell(r,c){selected=[r,c];document.getElementById('hintBox').classList.remove('show');renderBoard();}

document.addEventListener('keydown',function(e){
  if(!selected||solved)return;
  const r=selected[0],c=selected[1];
  if(e.key>='1'&&e.key<='9')placeNum(r,c,parseInt(e.key));
  else if(e.key==='Backspace'||e.key==='Delete'||e.key==='0')erase(r,c);
  else if(e.key==='ArrowUp'&&r>0){selected=[r-1,c];renderBoard();}
  else if(e.key==='ArrowDown'&&r<8){selected=[r+1,c];renderBoard();}
  else if(e.key==='ArrowLeft'&&c>0){selected=[r,c-1];renderBoard();}
  else if(e.key==='ArrowRight'&&c<8){selected=[r,c+1];renderBoard();}
});

function placeNum(r,c,num){
  if(puzzle[r][c]!==0)return;
  if(notesMode){
    if(board[r][c]!==0)return;
    if(notes[r][c].has(num))notes[r][c].delete(num);else notes[r][c].add(num);
  } else {
    board[r][c]=num;notes[r][c].clear();
    for(let i=0;i<9;i++){notes[r][i].delete(num);notes[i][c].delete(num);}
    const sr=Math.floor(r/3)*3,sc=Math.floor(c/3)*3;
    for(let rb=sr;rb<sr+3;rb++)for(let cb=sc;cb<sc+3;cb++)notes[rb][cb].delete(num);
  }
  clearMsg();renderBoard();updateNumpad();
  if(!notesMode)checkWin();
}

function erase(r,c){if(puzzle[r][c]!==0)return;board[r][c]=0;notes[r][c].clear();renderBoard();updateNumpad();}
function eraseCell(){if(selected)erase(selected[0],selected[1]);}

function toggleNotes(){
  notesMode=!notesMode;
  const btn=document.getElementById('notesBtn');
  btn.textContent='üìù Notes: '+(notesMode?'ON':'OFF');
  btn.classList.toggle('active',notesMode);
}

function clearErrors(){
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)
    if(puzzle[r][c]===0&&board[r][c]!==0&&board[r][c]!==solution[r][c])board[r][c]=0;
  renderBoard();updateNumpad();showMsg('Wrong entries cleared! üßπ',false);
}

function checkBoard(){
  let errors=0;
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)
    if(puzzle[r][c]===0&&board[r][c]!==0&&board[r][c]!==solution[r][c])errors++;
  if(errors===0)showMsg('Looking good so far! ‚ú®',false);
  else{mistakes+=errors;updateScore();showMsg('Found '+errors+' mistake'+(errors>1?'s':'')+'! üò¨',true);}
}

function getHint(){
  const h=hint(board);
  const tech=h[0],r=h[1][0],c=h[1][1],val=h[2];
  if(tech==='Solved'){showMsg('Puzzle is already solved!',false);return;}
  if(tech==='Stuck'||tech==='Contradiction'){showMsg("Hmm, something's wrong ü§î",true);return;}
  hintsUsed++;updateScore();
  selected=[r,c];renderBoard();
  const td=document.querySelector('td[data-r="'+r+'"][data-c="'+c+'"]');
  if(td)td.classList.add('hint-cell');
  const names={'Box HS':'Box Hidden Single','Line HS':'Line Hidden Single','Naked Single':'Naked Single'};
  const hb=document.getElementById('hintBox');
  hb.textContent='üí° '+(names[tech]||tech)+' ‚Üí Place '+val+' at row '+(r+1)+', col '+(c+1);
  hb.classList.add('show');
}

function buildNumpad(){
  const np=document.getElementById('numpad');np.innerHTML='';
  for(let n=1;n<=9;n++){
    const btn=document.createElement('button');
    btn.className='num-btn';btn.textContent=n;btn.id='nb'+n;
    btn.onclick=(function(num){return function(){if(selected&&!solved)placeNum(selected[0],selected[1],num);};})(n);
    np.appendChild(btn);
  }
}

function updateNumpad(){
  for(let n=1;n<=9;n++){
    let count=0;for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(board[r][c]===n)count++;
    const btn=document.getElementById('nb'+n);if(btn)btn.classList.toggle('used',count>=9);
  }
}

function checkWin(){
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(board[r][c]===0||board[r][c]!==solution[r][c])return;
  solved=true;clearInterval(timerInterval);
  const finalScore=calcScore();
  document.getElementById('scoreLive').textContent=finalScore;
  const m=Math.floor(seconds/60),s=seconds%60;
  document.getElementById('finalTime').textContent=m+'m '+s+'s';
  document.getElementById('finalScore').textContent=finalScore+' pts';
  setTimeout(function(){document.getElementById('congrats').classList.add('show');},400);
}

function showMsg(txt,isErr){
  const el=document.getElementById('message');
  el.textContent=txt;el.className='message show'+(isErr?' err':'');
}
function clearMsg(){document.getElementById('message').classList.remove('show');}
</script>
</body>
</html>
