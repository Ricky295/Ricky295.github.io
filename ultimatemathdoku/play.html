<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - Mathdoku Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grid-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            position: relative;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: white;
            transition: all 0.1s ease;
            user-select: none;
        }
        .grid-cell:hover { background-color: #f8fafc; }
        .grid-cell.selected {
            background-color: #eff6ff;
            outline: 2px solid #3b82f6;
            z-index: 20;
        }
        .grid-cell.given { color: #2563eb; background-color: #f1f5f9; cursor: default; }
        .grid-cell.error { color: #dc2626; background-color: #fef2f2; }
        
        .cage-label {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #64748b;
            pointer-events: none;
        }

        /* Heavy Borders for Cages */
        .bt-h { border-top: 3px solid #0f172a; }
        .bb-h { border-bottom: 3px solid #0f172a; }
        .bl-h { border-left: 3px solid #0f172a; }
        .br-h { border-right: 3px solid #0f172a; }

        @keyframes pulse-success {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); border-color: #10b981; }
            100% { transform: scale(1); }
        }
        .success-animate { animation: pulse-success 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="w-8 h-8 bg-slate-900 rounded flex items-center justify-center text-white font-black text-sm group-hover:bg-blue-600 transition">←</div>
                <span class="font-bold text-sm tracking-tight">BACK TO MENU</span>
            </a>
            <div id="game-status" class="text-xs font-bold uppercase tracking-widest text-slate-400">Solving...</div>
            <button onclick="resetGame()" class="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg transition">CLEAR GRID</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6 md:p-12 flex flex-col items-center">
        
        <div id="win-banner" class="hidden w-full max-w-md bg-emerald-500 text-white p-4 rounded-2xl mb-8 text-center shadow-lg shadow-emerald-100 animate-bounce">
            <p class="font-black text-lg">PUZZLE SOLVED!</p>
            <p class="text-xs opacity-90 uppercase font-bold">Excellent logic work.</p>
        </div>

        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200 w-fit">
            <div id="grid-player" class="grid border-2 border-slate-900 bg-slate-200" style="width: 100%; min-width: 320px; max-width: 450px;">
                <!-- Grid rendered by JS -->
            </div>
        </div>

        <div class="mt-12 grid grid-cols-3 gap-8 w-full max-w-2xl">
            <div class="text-center">
                <span class="block text-[10px] font-black text-slate-300 uppercase mb-1">Grid Size</span>
                <span id="display-size" class="text-2xl font-black">--</span>
            </div>
            <div class="text-center">
                <span class="block text-[10px] font-black text-slate-300 uppercase mb-1">Cages</span>
                <span id="display-cages" class="text-2xl font-black">--</span>
            </div>
            <div class="text-center">
                <span class="block text-[10px] font-black text-slate-300 uppercase mb-1">Conflicts</span>
                <span id="display-errors" class="text-2xl font-black text-slate-400">0</span>
            </div>
        </div>

        <!-- Utility Button to get current share link -->
        <button onclick="copyShareLink()" class="mt-8 text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-blue-600 transition">
            Copy Share Link
        </button>
    </main>

    <script src="utils.js"></script>
    <script>
        let size = 4;
        let cages = [];
        let givens = {};
        let playerValues = {};
        let selectedKey = null;

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const puzzleB64 = urlParams.get('puzzle');
            
            let data = null;

            if (puzzleB64) {
                data = MathdokuUtils.importB64(puzzleB64);
                if (!data) console.warn("Failed to load puzzle from URL, trying local storage...");
            }

            if (!data) {
                data = MathdokuUtils.loadFromStorage();
            }

            if (!data) {
                alert("No puzzle found! Redirecting to Constructor.");
                window.location.href = "constructor.html";
                return;
            }

            size = data.s;
            cages = data.c;
            givens = data.g || {};
            
            document.getElementById('display-size').textContent = `${size}x${size}`;
            document.getElementById('display-cages').textContent = cages.length;

            render();
            setupKeyboard();
        }

        function copyShareLink() {
            const data = { s: size, c: cages, g: givens };
            const b64 = MathdokuUtils.exportB64(data);
            const url = `${window.location.origin}${window.location.pathname}?puzzle=${b64}`;
            
            // Fallback for clipboard
            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            alert("Share link copied to clipboard!");
        }

        function setupKeyboard() {
            window.addEventListener('keydown', (e) => {
                if (!selectedKey) return;
                
                const key = e.key;
                const isNum = key >= '1' && key <= size.toString();
                const isClear = key === '0' || key === 'Backspace' || key === 'Delete';

                if (isNum) {
                    playerValues[selectedKey] = parseInt(key);
                    render();
                    checkWin();
                } else if (isClear) {
                    delete playerValues[selectedKey];
                    render();
                }
            });
        }

        function checkSudokuViolation(r, c, val) {
            if (!val) return false;
            for (let i = 0; i < size; i++) {
                // Row check
                if (i !== c && (playerValues[`${r},${i}`] || givens[`${r},${i}`]) === val) return true;
                // Column check
                if (i !== r && (playerValues[`${i},${c}`] || givens[`${i},${c}`]) === val) return true;
            }
            return false;
        }

        function render() {
            const container = document.getElementById('grid-player');
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

            let errorCount = 0;

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const key = `${r},${c}`;
                    const val = playerValues[key] || givens[key];
                    const isGiven = !!givens[key];
                    const isError = !isGiven && checkSudokuViolation(r, c, val);
                    if (isError) errorCount++;

                    const cell = document.createElement('div');
                    cell.className = `grid-cell`;
                    if (isGiven) cell.classList.add('given');
                    if (selectedKey === key) cell.classList.add('selected');
                    if (isError) cell.classList.add('error');

                    // Cage Borders
                    const cage = cages.find(cg => cg.cells.some(p => p[0] === r && p[1] === c));
                    if (cage) {
                        const inCage = (rr, cc) => cage.cells.some(p => p[0] === rr && p[1] === cc);
                        if (!inCage(r - 1, c)) cell.classList.add('bt-h');
                        if (!inCage(r + 1, c)) cell.classList.add('bb-h');
                        if (!inCage(r, c - 1)) cell.classList.add('bl-h');
                        if (!inCage(r, c + 1)) cell.classList.add('br-h');

                        // Label
                        if (cage.cells[0][0] === r && cage.cells[0][1] === c) {
                            const lbl = document.createElement('div');
                            lbl.className = 'cage-label';
                            lbl.textContent = `${cage.target}${cage.op === 'None' ? '' : (cage.op === '*' ? '×' : (cage.op === '/' ? '÷' : cage.op))}`;
                            cell.appendChild(lbl);
                        }
                    }

                    if (val) cell.append(val);

                    cell.onclick = () => {
                        if (isGiven) return;
                        selectedKey = (selectedKey === key) ? null : key;
                        render();
                    };

                    container.appendChild(cell);
                }
            }

            const errorDisplay = document.getElementById('display-errors');
            errorDisplay.textContent = errorCount;
            errorDisplay.className = errorCount > 0 ? "text-2xl font-black text-red-500" : "text-2xl font-black text-slate-400";
        }

        function resetGame() {
            if (confirm("Clear all your inputs?")) {
                playerValues = {};
                selectedKey = null;
                document.getElementById('win-banner').classList.add('hidden');
                render();
            }
        }

        function checkWin() {
            // 1. Check if all cells filled
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (!playerValues[`${r},${c}`] && !givens[`${r},${c}`]) return;
                }
            }

            // 2. Check Sudoku violations
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const val = playerValues[`${r},${c}`] || givens[`${r},${c}`];
                    if (checkSudokuViolation(r, c, val)) return;
                }
            }

            // 3. Check Cage Math
            const mathPass = cages.every(cg => {
                const vals = cg.cells.map(([rr, cc]) => playerValues[`${rr},${cc}`] || givens[`${rr},${cc}`]);
                const t = cg.target;
                const op = cg.op;
                if (op === '+') return vals.reduce((a, b) => a + b, 0) === t;
                if (op === '*') return vals.reduce((a, b) => a * b, 1) === t;
                if (op === '-') return Math.abs(vals[0] - vals[1]) === t;
                if (op === '/') return (vals[0] / vals[1] === t || vals[1] / vals[0] === t);
                if (op === 'None') return vals[0] === t;
                return false;
            });

            if (mathPass) {
                document.getElementById('win-banner').classList.remove('hidden');
                document.getElementById('grid-player').classList.add('success-animate');
                document.getElementById('game-status').textContent = "Solved!";
                document.getElementById('game-status').classList.replace('text-slate-400', 'text-emerald-500');
            }
        }

        init();
    </script>
</body>
</html>
