<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mathdoku Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grid-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: white;
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }
        .grid-cell:hover { background-color: #f8fafc; }
        .grid-cell.selected { background-color: #eff6ff; z-index: 10; outline: 2px solid #3b82f6; }
        .grid-cell.given { color: #64748b; background-color: #f1f5f9; cursor: default; }
        
        .cage-label { 
            position: absolute; 
            top: 2px; 
            left: 3px; 
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            font-weight: 800; 
            color: #1e293b; 
            pointer-events: none; 
            line-height: 1;
            z-index: 5;
        }

        .candidate-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 20% 5% 5% 5%;
            pointer-events: none;
        }

        .candidate-num {
            font-size: clamp(0.5rem, 1.2vw, 0.75rem);
            color: #94a3b8;
            line-height: 1;
            text-align: center;
            font-weight: normal;
        }
        
        .border-t-heavy { border-top: 3px solid #0f172a; }
        .border-b-heavy { border-bottom: 3px solid #0f172a; }
        .border-l-heavy { border-left: 3px solid #0f172a; }
        .border-r-heavy { border-right: 3px solid #0f172a; }

        .numpad-btn {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            transition: all 0.1s;
            touch-action: manipulation;
        }
        .numpad-btn:active { transform: scale(0.92); background: #f1f5f9; }

        .loader {
            border: 3px solid #cbd5e1;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans overflow-x-hidden">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- Selector Screen -->
        <div id="selectorScreen" class="space-y-8">
            <header class="text-center space-y-2">
                <h1 class="text-4xl font-black italic tracking-tighter">MATHDOKU<span class="text-blue-600">.PLAY</span></h1>
                <p class="text-slate-500 font-medium">Procedural challenge generator powered by Solver.js</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Generator Configuration -->
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
                        <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        </span>
                        New Game
                    </h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Grid Size</label>
                            <div class="grid grid-cols-3 gap-2" id="sizeSelector"></div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Target Difficulty</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="diffSelector"></div>
                        </div>

                        <div id="genStatusArea" class="hidden space-y-3 p-4 bg-slate-50 border border-slate-100 rounded-2xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="loader"></div>
                                    <span class="text-xs font-black uppercase tracking-widest text-slate-400">Attempts: <span id="attemptCount" class="text-slate-900">0</span></span>
                                </div>
                                <div id="bestSoFarBadge"></div>
                            </div>
                            <button id="stopGenBtn" class="w-full py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl text-[10px] font-black uppercase transition-all">End & Accept Best Match</button>
                        </div>

                        <button id="generateBtn" onclick="startGeneration()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-3">
                            GENERATE PUZZLE
                        </button>
                    </div>
                </div>

                <!-- Custom Import -->
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col">
                    <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
                        <span class="p-1.5 bg-purple-100 text-purple-600 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        </span>
                        Import String
                    </h3>
                    <textarea id="importString" class="flex-1 w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs font-mono mb-4 focus:ring-2 focus:ring-blue-500 outline-none min-h-[120px]" placeholder="Paste code..."></textarea>
                    <button onclick="importPuzzle()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all">LOAD CUSTOM</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden space-y-6">
            <div class="flex justify-between items-center bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                <button onclick="backToMenu()" class="text-slate-500 hover:text-slate-900 font-bold text-sm flex items-center gap-1 bg-slate-100 px-3 py-1.5 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"></path></svg>
                    Menu
                </button>
                <div id="difficultyBadge"></div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 items-center lg:items-start justify-center">
                <!-- Main Grid -->
                <div class="w-full max-w-[500px] space-y-4">
                    <div id="gridContainer" class="grid border-[3px] border-slate-900 bg-slate-300 shadow-2xl rounded-sm overflow-hidden"></div>
                </div>

                <!-- Interaction Panel -->
                <div class="w-full max-w-[400px] lg:w-80 space-y-4">
                    <!-- Mode Toggle -->
                    <div class="grid grid-cols-2 gap-2 bg-white p-1.5 rounded-2xl border border-slate-200 shadow-sm">
                        <button id="modePen" onclick="setEntryMode('pen')" class="py-3 rounded-xl font-black text-xs uppercase transition-all flex items-center justify-center gap-2 bg-blue-600 text-white">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            Pen
                        </button>
                        <button id="modePencil" onclick="setEntryMode('pencil')" class="py-3 rounded-xl font-black text-xs uppercase transition-all flex items-center justify-center gap-2 text-slate-400 hover:bg-slate-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Pencil
                        </button>
                    </div>

                    <!-- Numpad -->
                    <div id="numpad" class="grid grid-cols-3 gap-2 p-3 bg-white rounded-3xl border border-slate-200 shadow-sm"></div>
                    
                    <div class="space-y-2">
                        <button onclick="checkPuzzle()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black hover:bg-blue-700 shadow-xl shadow-blue-100 transition-all active:scale-95">CHECK SOLUTION</button>
                        <div id="messageBox" class="p-4 rounded-xl text-center text-sm font-bold hidden transition-all"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="solver.js"></script>

    <script>
        // --- APP STATE ---
        let config = { size: 4, difficulty: 'Medium' };
        let gameState = {
            gridSize: 4,
            cages: [],
            givens: {},
            userGrid: [],      // Main values
            candidates: {},    // Map of "r,c" -> Set([1,2,3])
            selected: null,
            difficulty: null,
            entryMode: 'pen'   // 'pen' or 'pencil'
        };

        const DIFFICULTIES = ['Easy', 'Medium', 'Hard', 'Vicious', 'Devilish', 'Diabolical', 'Beyond Diabolical'];
        
        let genActive = false;
        let genAttempts = 0;
        let bestPuzzle = null;
        let bestDiffDist = Infinity;

        // --- GENERATOR ---

        function startGeneration() {
            genActive = true;
            genAttempts = 0;
            bestPuzzle = null;
            bestDiffDist = Infinity;
            document.getElementById('generateBtn').classList.add('hidden');
            document.getElementById('genStatusArea').classList.remove('hidden');
            document.getElementById('bestSoFarBadge').innerHTML = '';
            document.getElementById('stopGenBtn').onclick = () => {
                if (bestPuzzle) loadPuzzleData(btoa(JSON.stringify(bestPuzzle)));
                stopGeneration();
            };
            huntLoop();
        }

        function stopGeneration() {
            genActive = false;
            document.getElementById('generateBtn').classList.remove('hidden');
            document.getElementById('genStatusArea').classList.add('hidden');
        }

        function huntLoop() {
            if (!genActive) return;
            for (let i = 0; i < 4; i++) {
                genAttempts++;
                const candidate = createCandidate(config.size, config.difficulty);
                const solverRes = solveMathdoku(candidate.gridSize, candidate.cages, candidate.givens, 2);
                if (solverRes.count === 1) {
                    const rating = ratePuzzle(solverRes);
                    const targetIdx = DIFFICULTIES.indexOf(config.difficulty);
                    const actualIdx = DIFFICULTIES.indexOf(rating.label);
                    const dist = Math.abs(targetIdx - actualIdx);
                    if (dist < bestDiffDist) {
                        bestDiffDist = dist;
                        bestPuzzle = candidate;
                        updateBestBadge(rating);
                    }
                    if (dist === 0) {
                        loadPuzzleData(btoa(JSON.stringify(candidate)));
                        stopGeneration();
                        return;
                    }
                }
            }
            document.getElementById('attemptCount').textContent = genAttempts;
            requestAnimationFrame(huntLoop);
        }

        function updateBestBadge(rating) {
            const colorMap = { emerald: 'bg-emerald-100 text-emerald-700', teal: 'bg-teal-100 text-teal-700', blue: 'bg-blue-100 text-blue-700', indigo: 'bg-indigo-100 text-indigo-700', rose: 'bg-rose-100 text-rose-700', red: 'bg-red-100 text-red-700', slate: 'bg-slate-200 text-slate-800' };
            const cls = colorMap[rating.color] || 'bg-slate-100 text-slate-600';
            document.getElementById('bestSoFarBadge').innerHTML = `<div class="flex flex-col items-end"><span class="text-[8px] font-black text-slate-400 uppercase">Found</span><span class="px-2 py-0.5 rounded text-[9px] font-black uppercase ${cls}">${rating.label}</span></div>`;
        }

        function createCandidate(size, targetDiff) {
            const grid = Array.from({ length: size }, () => Array(size).fill(0));
            function fill(r, c) {
                if (c === size) { r++; c = 0; }
                if (r === size) return true;
                const nums = Array.from({length: size}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
                for (let n of nums) { if (isSafe(grid, r, c, n, size)) { grid[r][c] = n; if (fill(r, c + 1)) return true; grid[r][c] = 0; } }
                return false;
            }
            fill(0, 0);

            const cages = [];
            const visited = new Set();
            const cells = [];
            for(let r=0; r<size; r++) for(let c=0; c<size; c++) cells.push([r, c]);
            cells.sort(() => Math.random() - 0.5);

            for (const [r, c] of cells) {
                if (visited.has(`${r},${c}`)) continue;
                let maxC = targetDiff === 'Easy' ? 2 : (targetDiff.includes('Diabolical') ? 5 : 3);
                let cageSize = Math.floor(Math.random() * maxC) + 1;
                const currentCage = [[r, c]];
                visited.add(`${r},${c}`);
                for (let i = 1; i < cageSize; i++) {
                    const neighbors = [];
                    for (const [cr, cc] of currentCage) {
                        [[cr-1, cc], [cr+1, cc], [cr, cc-1], [cr, cc+1]].forEach(([nr, nc]) => {
                            if (nr >= 0 && nr < size && nc >= 0 && nc < size && !visited.has(`${nr},${nc}`)) neighbors.push([nr, nc]);
                        });
                    }
                    if (!neighbors.length) break;
                    const next = neighbors[Math.floor(Math.random() * neighbors.length)];
                    currentCage.push(next);
                    visited.add(`${next[0]},${next[1]}`);
                }
                const vals = currentCage.map(([cr, cc]) => grid[cr][cc]);
                let op = '+', target = 0;
                if (currentCage.length === 1) { op = 'None'; target = vals[0]; }
                else if (currentCage.length === 2) {
                    const ops = ['+', '-', '*', '/'].filter(o => o !== '/' || (Math.max(...vals) % Math.min(...vals) === 0));
                    op = ops[Math.floor(Math.random() * ops.length)];
                    if (op === '+') target = vals[0] + vals[1];
                    else if (op === '*') target = vals[0] * vals[1];
                    else if (op === '-') target = Math.abs(vals[0] - vals[1]);
                    else if (op === '/') target = Math.max(...vals) / Math.min(...vals);
                } else {
                    op = Math.random() > 0.4 ? '+' : '*';
                    target = op === '+' ? vals.reduce((a,b)=>a+b,0) : vals.reduce((a,b)=>a*b,1);
                }
                cages.push({ op, target, cells: currentCage, id: Math.random() });
            }
            return { gridSize: size, cages, givens: {} };
        }

        // --- CORE GAME ---

        window.onload = () => { initMenu(); checkUrlParams(); setupKeyboard(); };

        function initMenu() {
            const sEl = document.getElementById('sizeSelector');
            sEl.innerHTML = '';
            [4, 5, 6, 7, 8, 9].forEach(s => {
                const b = document.createElement('button');
                b.className = `py-3 rounded-xl border-2 font-bold transition-all ${config.size === s ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-100 text-slate-500 hover:border-slate-200'}`;
                b.textContent = `${s}x${s}`;
                b.onclick = () => { config.size = s; initMenu(); };
                sEl.appendChild(b);
            });
            const dEl = document.getElementById('diffSelector');
            dEl.innerHTML = '';
            DIFFICULTIES.forEach(d => {
                const b = document.createElement('button');
                b.className = `py-2 rounded-xl border-2 font-bold text-[10px] uppercase transition-all ${config.difficulty === d ? 'bg-slate-900 border-slate-900 text-white' : 'bg-white border-slate-100 text-slate-500 hover:border-slate-200'}`;
                b.textContent = d;
                b.onclick = () => { config.difficulty = d; initMenu(); };
                dEl.appendChild(b);
            });
        }

        function checkUrlParams() {
            const p = new URLSearchParams(window.location.search).get('p');
            if (p) loadPuzzleData(p);
        }

        function loadPuzzleData(base64) {
            try {
                const data = JSON.parse(atob(base64));
                gameState.gridSize = data.gridSize;
                gameState.cages = data.cages;
                gameState.givens = data.givens || {};
                gameState.userGrid = Array.from({ length: data.gridSize }, () => Array(data.gridSize).fill(0));
                gameState.candidates = {};
                for (let k in gameState.givens) {
                    const [r, c] = k.split(',').map(Number);
                    gameState.userGrid[r][c] = gameState.givens[k];
                }
                const res = solveMathdoku(data.gridSize, data.cages, data.givens, 2);
                gameState.difficulty = ratePuzzle(res);
                window.history.replaceState({}, '', `?p=${base64}`);
                document.getElementById('selectorScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                renderGame();
            } catch (e) { alert("Invalid puzzle string."); }
        }

        function renderGame() {
            const container = document.getElementById('gridContainer');
            const size = gameState.gridSize;
            container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            container.innerHTML = '';

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const cell = document.createElement('div');
                    const key = `${r},${c}`;
                    const isSelected = gameState.selected?.r === r && gameState.selected?.c === c;
                    const isGiven = gameState.givens[key];
                    const val = gameState.userGrid[r][c];
                    
                    cell.className = `grid-cell ${isGiven ? 'given' : ''} ${isSelected ? 'selected' : ''}`;
                    
                    if (val !== 0) {
                        cell.textContent = val;
                    } else if (gameState.candidates[key] && gameState.candidates[key].size > 0) {
                        const cGrid = document.createElement('div');
                        cGrid.className = 'candidate-grid';
                        for (let i = 1; i <= 9; i++) {
                            const cn = document.createElement('div');
                            cn.className = 'candidate-num';
                            if (i <= size && gameState.candidates[key].has(i)) cn.textContent = i;
                            cGrid.appendChild(cn);
                        }
                        cell.appendChild(cGrid);
                    }
                    
                    const cage = gameState.cages.find(cg => cg.cells[0][0] === r && cg.cells[0][1] === c);
                    if (cage) {
                        const l = document.createElement('div');
                        l.className = 'cage-label';
                        const sym = { '+': '+', '-': '−', '*': '×', '/': '÷', 'None': '' }[cage.op];
                        l.textContent = `${cage.target}${sym}`;
                        cell.appendChild(l);
                    }
                    applyBorders(cell, r, c);
                    if (!isGiven) cell.onclick = () => { gameState.selected = {r, c}; renderGame(); };
                    container.appendChild(cell);
                }
            }
            renderNumpad();
            renderDifficultyBadge();
        }

        function applyBorders(el, r, c) {
            const cage = gameState.cages.find(cg => cg.cells.some(cell => cell[0] === r && cell[1] === c));
            if (!cage) return;
            const inCage = (row, col) => cage.cells.some(cell => cell[0] === row && cell[1] === col);
            if (!inCage(r - 1, c)) el.classList.add('border-t-heavy');
            if (!inCage(r + 1, c)) el.classList.add('border-b-heavy');
            if (!inCage(r, c - 1)) el.classList.add('border-l-heavy');
            if (!inCage(r, c + 1)) el.classList.add('border-r-heavy');
        }

        function renderNumpad() {
            const numpad = document.getElementById('numpad');
            numpad.innerHTML = '';
            for (let i = 1; i <= gameState.gridSize; i++) {
                const b = document.createElement('button');
                b.className = "numpad-btn text-xl";
                b.textContent = i;
                b.onclick = () => setVal(i);
                numpad.appendChild(b);
            }
            const clr = document.createElement('button');
            clr.className = "numpad-btn col-span-1 text-[10px] uppercase font-black text-slate-400 bg-slate-50";
            clr.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg>`;
            clr.onclick = () => setVal(0);
            numpad.appendChild(clr);
        }

        function setEntryMode(m) {
            gameState.entryMode = m;
            document.getElementById('modePen').className = m === 'pen' ? "py-3 rounded-xl font-black text-xs uppercase bg-blue-600 text-white flex items-center justify-center gap-2" : "py-3 rounded-xl font-black text-xs uppercase text-slate-400 hover:bg-slate-50 flex items-center justify-center gap-2";
            document.getElementById('modePencil').className = m === 'pencil' ? "py-3 rounded-xl font-black text-xs uppercase bg-blue-600 text-white flex items-center justify-center gap-2" : "py-3 rounded-xl font-black text-xs uppercase text-slate-400 hover:bg-slate-50 flex items-center justify-center gap-2";
        }

        function setVal(n) {
            if (!gameState.selected) return;
            const { r, c } = gameState.selected;
            const key = `${r},${c}`;
            if (gameState.givens[key]) return;

            if (gameState.entryMode === 'pen') {
                if (n === 0) {
                    gameState.userGrid[r][c] = 0;
                } else {
                    // If we place a main number, clear candidates for that cell
                    gameState.userGrid[r][c] = (gameState.userGrid[r][c] === n) ? 0 : n;
                    if (gameState.candidates[key]) delete gameState.candidates[key];
                }
            } else {
                // Pencil mode
                if (n === 0) {
                    gameState.userGrid[r][c] = 0;
                    delete gameState.candidates[key];
                } else if (gameState.userGrid[r][c] === 0) {
                    if (!gameState.candidates[key]) gameState.candidates[key] = new Set();
                    if (gameState.candidates[key].has(n)) gameState.candidates[key].delete(n);
                    else gameState.candidates[key].add(n);
                }
            }
            renderGame();
        }

        function renderDifficultyBadge() {
            const d = gameState.difficulty;
            const colorMap = { emerald: 'bg-emerald-100 text-emerald-700 border-emerald-200', teal: 'bg-teal-100 text-teal-700 border-teal-200', blue: 'bg-blue-100 text-blue-700 border-blue-200', indigo: 'bg-indigo-100 text-indigo-700 border-indigo-200', rose: 'bg-rose-100 text-rose-700 border-rose-200', red: 'bg-red-100 text-red-700 border-red-200', slate: 'bg-slate-200 text-slate-800 border-slate-300' };
            const classes = colorMap[d.color] || 'bg-slate-100 text-slate-600';
            document.getElementById('difficultyBadge').innerHTML = `<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase border ${classes}">${d.label}</span>`;
        }

        function setupKeyboard() {
            window.addEventListener('keydown', (e) => {
                if (!gameState.selected || document.activeElement.tagName === 'TEXTAREA') return;
                if (e.key >= '1' && e.key <= gameState.gridSize.toString()) setVal(parseInt(e.key));
                if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') setVal(0);
                if (e.key === 'n' || e.key === 'N') setEntryMode(gameState.entryMode === 'pen' ? 'pencil' : 'pen');
                if (e.key.startsWith('Arrow')) moveSelection(e.key);
            });
        }

        function moveSelection(key) {
            let { r, c } = gameState.selected;
            if (key === 'ArrowUp') r = Math.max(0, r - 1);
            if (key === 'ArrowDown') r = Math.min(gameState.gridSize - 1, r + 1);
            if (key === 'ArrowLeft') c = Math.max(0, c - 1);
            if (key === 'ArrowRight') c = Math.min(gameState.gridSize - 1, c + 1);
            gameState.selected = { r, c };
            renderGame();
        }

        function checkPuzzle() {
            if (gameState.userGrid.flat().includes(0)) return showMsg("Grid incomplete.", "error");
            const s = gameState.gridSize;
            for (let i = 0; i < s; i++) {
                if (new Set(gameState.userGrid[i]).size !== s || new Set(gameState.userGrid.map(r => r[i])).size !== s) return showMsg("Duplicates found.", "error");
            }
            if (checkAllCages(gameState.userGrid, gameState.cages)) showMsg("SOLVED!", "success");
            else showMsg("Arithmetic error.", "error");
        }

        function showMsg(txt, type) {
            const b = document.getElementById('messageBox');
            b.classList.remove('hidden');
            b.textContent = txt;
            const cls = { success: "bg-emerald-50 text-emerald-700 border border-emerald-200", error: "bg-red-50 text-red-700 border border-red-200" };
            b.className = `p-4 rounded-xl text-sm font-bold text-center ${cls[type]}`;
        }

        function backToMenu() {
            window.history.replaceState({}, '', window.location.pathname);
            document.getElementById('selectorScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('messageBox').classList.add('hidden');
            gameState.selected = null;
        }
        
        function importPuzzle() {
            const v = document.getElementById('importString').value.trim();
            if (v) loadPuzzleData(v);
        }
    </script>
</body>
</html>
