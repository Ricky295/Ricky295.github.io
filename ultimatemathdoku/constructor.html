<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathdoku Constructor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grid-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background: white;
            transition: all 0.1s;
            user-select: none;
        }
        .grid-cell:hover { background-color: #f3f4f6; }
        .grid-cell.selected { background-color: #dbeafe; outline: 2px solid #3b82f6; z-index: 10; }
        .grid-cell.given-mode { cursor: text; }
        .grid-cell .given-val { color: #2563eb; z-index: 5; }
        
        .cage-label { position: absolute; top: 1px; left: 2px; font-size: 0.6rem; font-weight: 800; color: #374151; pointer-events: none; line-height: 1; }
        
        .border-t-heavy { border-top: 3px solid #0f172a; }
        .border-b-heavy { border-bottom: 3px solid #0f172a; }
        .border-l-heavy { border-left: 3px solid #0f172a; }
        .border-r-heavy { border-right: 3px solid #0f172a; }

        .solution-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e293b;
            border: 1px solid #334155;
            font-weight: 900;
            font-size: 1rem;
            color: #f1f5f9;
        }
        
        #cageList::-webkit-scrollbar { width: 4px; }
        #cageList::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #modalOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        
        .grid-9 .grid-cell { font-size: 0.9rem; }
        .grid-9 .cage-label { font-size: 0.5rem; }

        .mode-toggle { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-900">

    <div id="modalOverlay">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg mx-4 border border-slate-200">
            <h3 id="modalTitle" class="text-lg font-bold mb-2 text-slate-900">Share Puzzle</h3>
            <p id="modalDesc" class="text-sm text-slate-500 mb-4">Data payload for your puzzle configuration.</p>
            <textarea id="modalTextarea" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono mb-4 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 transition">Close</button>
                <button id="modalActionBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition-all active:scale-95">Copy String</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight italic">MATHDOKU<span class="text-blue-600">.BUILDER</span></h1>
                <p class="text-slate-500 font-medium text-sm">Design Irregular Mathdoku Puzzles</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="openExportModal()" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 shadow-sm transition-all">Export</button>
                <button onclick="openImportModal()" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 shadow-sm transition-all">Import</button>
                <button onclick="resetConstructor()" class="bg-white border border-red-100 px-4 py-2 rounded-lg text-sm font-semibold text-red-500 hover:bg-red-50 transition-all">Reset All</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <label class="font-bold text-xs uppercase tracking-wider text-slate-400">Size</label>
                            <select id="gridSize" class="bg-slate-100 border-none rounded-lg px-4 py-2 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="3">3x3</option>
                                <option value="4" selected>4x4</option>
                                <option value="5">5x5</option>
                                <option value="6">6x6</option>
                                <option value="7">7x7</option>
                                <option value="8">8x8</option>
                                <option value="9">9x9</option>
                            </select>
                        </div>

                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button id="modeCage" onclick="setMode('cage')" class="mode-toggle px-4 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-blue-600">CAGES</button>
                            <button id="modeGiven" onclick="setMode('given')" class="mode-toggle px-4 py-2 text-xs font-bold rounded-lg text-slate-500">GIVENS</button>
                        </div>

                        <div id="selectionStatus" class="text-[10px] font-bold text-slate-400 uppercase">
                            0 Cells Selected
                        </div>
                    </div>

                    <div id="gridContainer" class="grid gap-0 mx-auto border-2 border-slate-900 overflow-hidden bg-slate-200 shadow-xl" style="max-width: 500px;"></div>

                    <div id="cageTools" class="mt-8 p-5 bg-blue-50 rounded-2xl border border-blue-100 flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[120px]">
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Cage Target</label>
                            <input id="cageTarget" type="number" class="w-full px-3 py-2 rounded-lg border-blue-200 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 12">
                        </div>
                        <div class="flex-1 min-w-[100px]">
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Operator</label>
                            <select id="cageOp" class="w-full px-3 py-2 rounded-lg border-blue-200 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="+">+</option>
                                <option value="-">-</option>
                                <option value="*">ร</option>
                                <option value="/">รท</option>
                                <option value="=">=</option>
                            </select>
                        </div>
                        <button onclick="createCage()" class="bg-blue-600 text-white px-8 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition-all active:scale-95">CREATE CAGE</button>
                    </div>

                    <div id="givenTools" class="hidden mt-8 p-5 bg-amber-50 rounded-2xl border border-amber-100">
                        <p class="text-xs font-bold text-amber-600 uppercase mb-2">Given Mode Active</p>
                        <p class="text-sm text-amber-700">Select a cell and type 1-<span id="maxValHint">4</span>. Partial cages are allowed.</p>
                    </div>
                </div>

                <div class="bg-slate-900 p-6 rounded-2xl shadow-xl text-white">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-slate-500 mb-4">Solution Map</h3>
                    <div id="solutionContainer" class="grid gap-1 mx-auto" style="max-width: 400px;">
                        <div class="col-span-full py-12 text-center text-slate-600 text-sm italic font-medium">Solve to reveal solution...</div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">Analysis</h2>
                        <span id="statusBadge" class="text-[10px] uppercase tracking-widest px-2 py-0.5 rounded bg-slate-100 text-slate-400 font-bold">Idle</span>
                    </div>
                    
                    <div id="resultsArea">
                        <div class="p-8 rounded-2xl bg-slate-50 border border-dashed border-slate-200 text-slate-400 text-xs text-center font-medium">
                            Run solver to check validity...
                        </div>
                    </div>

                    <button onclick="runSolver()" id="btnAnalyze" class="w-full mt-6 bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 shadow-lg transition-all active:scale-95">
                        RUN SOLVER
                    </button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-xs text-slate-400 uppercase tracking-widest">Cage Registry</h3>
                        <span id="coverageLabel" class="text-xs font-bold text-slate-500">0 / 16</span>
                    </div>
                    <div id="cageList" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MathdokuSolver {
            constructor(size, cages, givens = {}) {
                this.size = size;
                this.cages = cages;
                this.initialGivens = givens;
                this.solutions = [];
                this.backtracks = 0;
                this.cellToCageMap = {};
                this.cages.forEach((cage, index) => {
                    cage.cells.forEach(cellIdx => {
                        this.cellToCageMap[cellIdx] = index;
                    });
                });
            }

            isValid(grid, idx, val) {
                const r = Math.floor(idx / this.size);
                const c = idx % this.size;
                
                // Unique in Row
                for (let i = 0; i < this.size; i++) {
                    const rowIdx = r * this.size + i;
                    if (rowIdx !== idx && grid[rowIdx] === val) return false;
                }
                // Unique in Column
                for (let i = 0; i < this.size; i++) {
                    const colIdx = i * this.size + c;
                    if (colIdx !== idx && grid[colIdx] === val) return false;
                }

                const cageIdx = this.cellToCageMap[idx];
                if (cageIdx === undefined) return true; // If no cage, just row/col check
                
                const cage = this.cages[cageIdx];
                const cageValues = cage.cells.map(i => i === idx ? val : grid[i]).filter(v => v !== 0);
                
                if (cageValues.length === cage.cells.length) {
                    return this.checkCageLogic(cage, cageValues);
                }
                return this.checkPartialCageLogic(cage, cageValues);
            }

            checkCageLogic(cage, values) {
                switch(cage.op) {
                    case '+': return values.reduce((a, b) => a + b, 0) === cage.target;
                    case '*': return values.reduce((a, b) => a * b, 1) === cage.target;
                    case '-': {
                        const max = Math.max(...values);
                        return (max - (values.reduce((a, b) => a + b, 0) - max)) === cage.target;
                    }
                    case '/': {
                        const max = Math.max(...values);
                        const others = values.reduce((a, b) => a * b, 1) / max;
                        return (max / others) === cage.target;
                    }
                    case '=': return values[0] === cage.target;
                    default: return false;
                }
            }

            checkPartialCageLogic(cage, values) {
                const remaining = cage.cells.length - values.length;
                const currentSum = values.reduce((a, b) => a + b, 0);
                const currentProd = values.reduce((a, b) => a * b, 1);
                switch(cage.op) {
                    case '+':
                        if (currentSum + remaining > cage.target) return false;
                        if (currentSum + (remaining * this.size) < cage.target) return false;
                        break;
                    case '*':
                        if (currentProd > cage.target && cage.target !== 0) return false;
                        break;
                    case '/':
                        // Minimal partial check for division
                        break;
                }
                return true;
            }

            solve(grid, index = 0) {
                if (this.solutions.length >= 2) return;
                if (index === this.size * this.size) {
                    this.solutions.push([...grid]);
                    return;
                }

                if (this.initialGivens[index] !== undefined) {
                    const val = this.initialGivens[index];
                    if (this.isValid(grid, index, val)) {
                        grid[index] = val;
                        this.solve(grid, index + 1);
                        grid[index] = 0;
                    }
                    return;
                }

                for (let v = 1; v <= this.size; v++) {
                    if (this.isValid(grid, index, v)) {
                        grid[index] = v;
                        this.solve(grid, index + 1);
                        grid[index] = 0;
                        this.backtracks++;
                        if (this.backtracks > 300000) return; 
                    }
                }
            }

            getAnalysis() {
                if (this.solutions.length === 0) return { rank: "Impossible", status: "FAILED" };
                if (this.solutions.length > 1) return { rank: "Non-Unique", status: "MULTIPLE" };
                
                const score = Math.sqrt(this.backtracks) * 1.5;
                let rank = "Very Easy";
                if (score > 150) rank = "Diabolical";
                else if (score > 100) rank = "Expert";
                else if (score > 70) rank = "Hard";
                else if (score > 45) rank = "Challenging";
                else if (score > 25) rank = "Medium";
                else if (score > 10) rank = "Easy";
                
                return { rank, status: "VALID", solution: this.solutions[0], backtracks: this.backtracks };
            }
        }

        let size = 4;
        let cages = [];
        let givens = {};
        let selectedCells = new Set();
        let cellToCageMap = {};
        let activeMode = 'cage';

        const gridContainer = document.getElementById('gridContainer');
        const gridSizeSelect = document.getElementById('gridSize');
        const cageListEl = document.getElementById('cageList');

        function init() {
            size = parseInt(gridSizeSelect.value);
            gridSizeSelect.onchange = (e) => {
                size = parseInt(e.target.value);
                document.getElementById('maxValHint').innerText = size;
                resetConstructor();
            };
            
            window.addEventListener('keydown', (e) => {
                if (activeMode !== 'given' || selectedCells.size !== 1) return;
                const idx = Array.from(selectedCells)[0];
                const key = e.key;
                if (key >= '1' && key <= size.toString()) {
                    givens[idx] = parseInt(key);
                    renderGrid();
                } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
                    delete givens[idx];
                    renderGrid();
                }
            });

            resetConstructor();
        }

        window.setMode = (mode) => {
            activeMode = mode;
            selectedCells.clear();
            
            const modes = ['Cage', 'Given'];
            modes.forEach(m => {
                const btn = document.getElementById(`mode${m}`);
                const tool = document.getElementById(`${m.toLowerCase()}Tools`);
                if (m.toLowerCase() === mode) {
                    btn.className = `mode-toggle px-4 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-${mode === 'cage' ? 'blue' : 'amber'}-600`;
                    tool.classList.remove('hidden');
                } else {
                    btn.className = "mode-toggle px-4 py-2 text-xs font-bold rounded-lg text-slate-500";
                    tool.classList.add('hidden');
                }
            });

            renderGrid();
            updateSelectionCount();
        };

        function renderGrid() {
            gridContainer.innerHTML = '';
            gridContainer.className = `grid gap-0 mx-auto border-2 border-slate-900 overflow-hidden bg-slate-200 shadow-xl grid-${size}`;
            gridContainer.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            
            for (let i = 0; i < size * size; i++) {
                const cell = document.createElement('div');
                cell.className = `grid-cell ${selectedCells.has(i) ? 'selected' : ''}`;
                if (activeMode === 'given') cell.classList.add('given-mode');
                
                const label = document.createElement('span');
                label.className = 'cage-label';
                cell.appendChild(label);

                if (givens[i]) {
                    const gVal = document.createElement('span');
                    gVal.className = 'given-val';
                    gVal.innerText = givens[i];
                    cell.appendChild(gVal);
                }

                cell.addEventListener('click', (e) => {
                    if (activeMode === 'cage') {
                        if (!e.shiftKey && !e.ctrlKey && cellToCageMap[i] === undefined && !selectedCells.has(i)) {
                            selectedCells.clear();
                        }
                        if (cellToCageMap[i] === undefined) {
                            if (selectedCells.has(i)) selectedCells.delete(i);
                            else selectedCells.add(i);
                        }
                    } else {
                        selectedCells.clear();
                        selectedCells.add(i);
                    }
                    renderGrid();
                    updateSelectionCount();
                });
                gridContainer.appendChild(cell);
            }
            drawCageBorders();
        }

        function updateCageIndices() {
            cellToCageMap = {};
            cages.forEach((c, i) => c.cells.forEach(idx => cellToCageMap[idx] = i));
            updateCageList();
        }

        function drawCageBorders() {
            const cells = gridContainer.children;
            cages.forEach((cage, cIdx) => {
                const sortedCells = [...cage.cells].sort((a, b) => a - b);
                const labelCell = cells[sortedCells[0]];
                if (labelCell) labelCell.querySelector('.cage-label').innerText = `${cage.target}${cage.op === '=' ? '' : cage.op}`;
                
                cage.cells.forEach(idx => {
                    const r = Math.floor(idx / size);
                    const c = idx % size;
                    const cell = cells[idx];
                    if (!cell) return;
                    if (r === 0 || cellToCageMap[idx - size] !== cIdx) cell.classList.add('border-t-heavy');
                    if (r === size - 1 || cellToCageMap[idx + size] !== cIdx) cell.classList.add('border-b-heavy');
                    if (c === 0 || cellToCageMap[idx - 1] !== cIdx) cell.classList.add('border-l-heavy');
                    if (c === size - 1 || cellToCageMap[idx + 1] !== cIdx) cell.classList.add('border-r-heavy');
                });
            });
        }

        function updateSelectionCount() {
            const status = document.getElementById('selectionStatus');
            if (activeMode === 'cage') status.textContent = `${selectedCells.size} Cells Selected`;
            else status.textContent = 'Select cell for given';
        }

        window.createCage = () => {
            const targetInput = document.getElementById('cageTarget');
            const opInput = document.getElementById('cageOp');
            const target = parseInt(targetInput.value);
            if (isNaN(target) || selectedCells.size === 0) return;
            
            const newCage = { target, op: opInput.value, cells: Array.from(selectedCells), id: Date.now() };
            cages.push(newCage);
            updateCageIndices();
            
            selectedCells.clear();
            targetInput.value = '';
            renderGrid();
            updateSelectionCount();
        };

        function updateCageList() {
            cageListEl.innerHTML = '';
            let covered = 0;
            cages.forEach((c, i) => {
                covered += c.cells.length;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-xl text-xs border border-slate-200';
                div.innerHTML = `
                    <span class="font-bold text-slate-700">
                        <strong class="text-blue-600">${c.target}${c.op === '=' ? '' : c.op}</strong> 
                        <span class="text-slate-400 ml-1">(${c.cells.length} cells)</span>
                    </span>
                    <button class="text-slate-300 hover:text-red-500 transition-colors" onclick="removeCage(${i})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>`;
                cageListEl.appendChild(div);
            });
            document.getElementById('coverageLabel').textContent = `${covered} / ${size * size}`;
        }

        window.removeCage = (index) => {
            cages.splice(index, 1);
            updateCageIndices();
            renderGrid();
        };

        window.runSolver = async () => {
            const badge = document.getElementById('statusBadge');
            badge.innerText = "ANALYZING...";
            badge.className = "text-[10px] uppercase tracking-widest px-2 py-0.5 rounded bg-blue-100 text-blue-600 font-bold";
            
            await new Promise(r => setTimeout(r, 100));
            const solver = new MathdokuSolver(size, cages, givens);
            solver.solve(Array(size * size).fill(0));
            
            const analysis = solver.getAnalysis();
            renderAnalysis(analysis);
            if (analysis.solution) renderSolution(analysis.solution);
            else document.getElementById('solutionContainer').innerHTML = '<div class="col-span-full py-12 text-center text-slate-600 text-sm italic">No valid solution map to display.</div>';
        };

        function renderAnalysis(analysis) {
            const badge = document.getElementById('statusBadge');
            const area = document.getElementById('resultsArea');
            badge.innerText = analysis.rank.toUpperCase();
            
            let colorClass = "bg-green-100 text-green-600";
            let boxClass = "border-slate-900 text-blue-600";
            let subText = `Backtracks: ${analysis.backtracks || 0}`;

            if (analysis.rank === "Impossible") {
                colorClass = "bg-red-100 text-red-600";
                boxClass = "border-red-500 text-red-600";
                subText = "The constraints cannot be satisfied.";
            } else if (analysis.rank === "Non-Unique") {
                colorClass = "bg-amber-100 text-amber-600";
                boxClass = "border-amber-500 text-amber-600";
                subText = "Found multiple solutions.";
            }

            badge.className = `text-[10px] uppercase tracking-widest px-2 py-0.5 rounded font-bold ${colorClass}`;
            area.innerHTML = `
                <div class="p-6 rounded-2xl bg-white border-2 shadow-sm text-center ${boxClass}">
                    <p class="text-[10px] uppercase font-black text-slate-400 mb-1">Status / Rank</p>
                    <p class="text-2xl font-black">${analysis.rank.toUpperCase()}</p>
                    <div class="flex justify-center gap-4 mt-3 text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                        <span>${subText}</span>
                    </div>
                </div>`;
        }

        function renderSolution(solution) {
            const container = document.getElementById('solutionContainer');
            container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            container.innerHTML = '';
            solution.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'solution-cell';
                if (givens[i]) cell.classList.add('bg-blue-900/40', 'text-blue-200');
                cell.textContent = val;
                container.appendChild(cell);
            });
        }

        window.resetConstructor = () => {
            cages = []; cellToCageMap = {}; givens = {}; selectedCells.clear();
            renderGrid(); updateCageList(); updateSelectionCount();
            document.getElementById('resultsArea').innerHTML = `<div class="p-8 rounded-2xl bg-slate-50 border border-dashed border-slate-200 text-slate-400 text-xs text-center font-medium">Run solver to check validity...</div>`;
            document.getElementById('solutionContainer').innerHTML = '<div class="col-span-full py-12 text-center text-slate-600 text-sm italic font-medium">Solve to reveal solution...</div>';
            const badge = document.getElementById('statusBadge');
            badge.innerText = "IDLE";
            badge.className = "text-[10px] uppercase tracking-widest px-2 py-0.5 rounded bg-slate-100 text-slate-400 font-bold";
        };

        window.openExportModal = () => {
            const base64 = btoa(JSON.stringify({ size, cages, givens }));
            const area = document.getElementById('modalTextarea');
            const btn = document.getElementById('modalActionBtn');
            document.getElementById('modalTitle').textContent = "Export Puzzle";
            area.value = base64; area.readOnly = true;
            btn.textContent = "Copy to Clipboard";
            btn.onclick = () => {
                area.select(); document.execCommand('copy');
                btn.textContent = "Copied!";
                setTimeout(() => btn.textContent = "Copy to Clipboard", 2000);
            };
            document.getElementById('modalOverlay').style.display = 'flex';
        };

        window.openImportModal = () => {
            const area = document.getElementById('modalTextarea');
            const btn = document.getElementById('modalActionBtn');
            document.getElementById('modalTitle').textContent = "Import Puzzle";
            area.value = ""; area.readOnly = false;
            btn.textContent = "Load Puzzle";
            btn.onclick = () => {
                try {
                    const data = JSON.parse(atob(area.value));
                    size = data.size; cages = data.cages; givens = data.givens || {};
                    gridSizeSelect.value = size;
                    updateCageIndices();
                    renderGrid(); closeModal();
                } catch (e) { alert("Invalid string."); }
            };
            document.getElementById('modalOverlay').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('modalOverlay').style.display = 'none';

        init();
    </script>
</body>
</html>
