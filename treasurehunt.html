<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Treasure Hunt</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #111; font-family: Georgia, serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  #topbar {
    background: #1a1a1a; border-bottom: 1px solid #2e2e2e;
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; z-index: 1000;
  }
  #topbar h1 { font-size: 1.1rem; color: #e6b84a; letter-spacing: 0.08em; text-transform: uppercase; }
  .badge {
    background: #2a2a2a; border: 1px solid #3a3a3a; color: #aaa;
    font-size: 0.72rem; padding: 3px 9px; border-radius: 20px; font-family: monospace;
  }
  #coords { margin-left: auto; }
  #map { flex: 1; width: 100%; }
  .leaflet-tile { filter: invert(1) hue-rotate(180deg) brightness(0.85) saturate(0.6); }
  .chest-dot {
    border-radius: 50%; border: 2px solid rgba(255,255,255,0.25);
    box-shadow: 0 0 6px 2px var(--glow); transition: transform .15s; cursor: pointer;
  }
  .chest-dot:hover { transform: scale(1.4); }
  .leaflet-popup-content-wrapper {
    background: #1e1e1e; border: 1px solid #333; border-radius: 10px;
    color: #f0ead6; box-shadow: 0 4px 20px #000a;
  }
  .leaflet-popup-tip { background: #1e1e1e; }
  .popup-tier { font-size: 0.7rem; text-transform: uppercase; letter-spacing: .1em; font-weight: bold; }
  .popup-id { font-size: 0.75rem; color: #777; margin-top: 2px; }
  #gpsOverlay {
    display: none; position: fixed; inset: 0; background: #111e; z-index: 3000;
    align-items: center; justify-content: center; flex-direction: column; gap: 12px;
    font-family: Georgia, serif; color: #e6b84a;
  }
  #gpsOverlay .icon { font-size: 2.4rem; animation: pulse 1.2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  #gpsOverlay .sub { font-size: 0.75rem; color: #555; }
  #urlBox {
    display: none; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 10px;
    padding: 12px 16px; z-index: 2000; gap: 8px; align-items: center;
    box-shadow: 0 4px 24px #000c; max-width: 90vw;
  }
  #toast {
    display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
    padding: 8px 18px; border-radius: 20px; font-size: 0.85rem;
    z-index: 2000; white-space: nowrap; pointer-events: none;
    box-shadow: 0 4px 16px #000a; animation: fadeUp .3s ease;
  }
  @keyframes fadeUp { from { opacity:0; transform: translateX(-50%) translateY(8px); } }
</style>
</head>
<body>

<div id="topbar">
  <h1>ðŸ—º Treasure Hunt</h1>
  <span class="badge" id="levelBadge" style="position:relative;overflow:hidden">
    <span id="levelBar" style="position:absolute;left:0;top:0;height:100%;background:#e6b84a22;width:0%;transition:width .4s;border-radius:20px;"></span>
    <span id="levelText" style="position:relative">Lv. 0  0/30 XP</span>
  </span>
  <span class="badge" id="collectedCount">â€”</span>
  <span class="badge" id="coords">â€”</span>
</div>

<div id="map"></div>
<div id="toast"></div>

<div id="gpsOverlay">
  <div class="icon">ðŸ“¡</div>
  <div>Detecting your locationâ€¦</div>
  <div class="sub">Please allow location access when prompted</div>
</div>

<div id="urlBox">
  <span style="color:#e6b84a;font-size:0.75rem;white-space:nowrap">ðŸ”— Your hunt URL</span>
  <input id="urlOut" readonly style="background:#111;border:1px solid #333;color:#ccc;border-radius:6px;padding:4px 8px;font-size:0.72rem;font-family:monospace;width:300px;max-width:50vw"/>
  <button id="copyBtn" style="background:#e6b84a;color:#111;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.75rem;font-weight:bold">Copy</button>
  <button id="closeUrl" style="background:none;border:none;color:#555;cursor:pointer;font-size:1rem;line-height:1">âœ•</button>
</div>

<script>
  // â”€â”€ Tiers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TIERS = [
    { name: 'Mythic',    from:    0, to:   49, minR: 0.01802, minXP:  750, maxXP: 2500, color: '#ff4444', glow: '#ff000088', size: 14 },
    { name: 'Legendary', from:   50, to:  299, minR: 0.00901, minXP:  400, maxXP: 1000, color: '#ff9500', glow: '#ff950066', size: 12 },
    { name: 'Epic',      from:  300, to:  799, minR: 0.00450, minXP:  200, maxXP:  500, color: '#bf5fff', glow: '#bf5fff55', size: 10 },
    { name: 'Rare',      from:  800, to: 1799, minR: 0.00225, minXP:  100, maxXP:  250, color: '#4d9fff', glow: '#4d9fff44', size: 9  },
    { name: 'Uncommon',  from: 1800, to: 3799, minR: 0.00090, minXP:   50, maxXP:  120, color: '#4caf50', glow: '#4caf5033', size: 8  },
    { name: 'Common',    from: 3800, to: 9999, minR: 0.00000, minXP:   20, maxXP:   60, color: '#888888', glow: '#88888822', size: 7  },
  ];
  function getTier(i) {
    for (const t of TIERS) if (i >= t.from && i <= t.to) return t;
    return TIERS[TIERS.length - 1];
  }

  // â”€â”€ Encoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const XOR_KEY = 0x5F3A;
  function encodeLocation(lat, lng) {
    const str = `${lat.toFixed(6)},${lng.toFixed(6)}`;
    let x = '';
    for (let i = 0; i < str.length; i++)
      x += String.fromCharCode(str.charCodeAt(i) ^ (XOR_KEY >> (i % 2 === 0 ? 8 : 0) & 0xFF));
    return btoa(x).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
  }
  function decodeLocation(enc) {
    try {
      const x = atob(enc.replace(/-/g,'+').replace(/_/g,'/'));
      let s = '';
      for (let i = 0; i < x.length; i++)
        s += String.fromCharCode(x.charCodeAt(i) ^ (XOR_KEY >> (i % 2 === 0 ? 8 : 0) & 0xFF));
      const [lat, lng] = s.split(',').map(Number);
      if (isNaN(lat) || isNaN(lng)) return null;
      return { lat, lng };
    } catch { return null; }
  }

  // â”€â”€ PRNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function seededRNG(seed) {
    let s = seed;
    return () => {
      s |= 0; s = s + 0x6D2B79F5 | 0;
      let t = Math.imul(s ^ s >>> 15, 1 | s);
      t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
  }

  // â”€â”€ Haversine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function haversine(lat1, lng1, lat2, lng2) {
    const R = 6371000, rad = Math.PI / 180;
    const dLat = (lat2 - lat1) * rad, dLng = (lng2 - lng1) * rad;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*rad) * Math.cos(lat2*rad) * Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // â”€â”€ Spawn schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function lastSpawnTime(tierName) {
    const now = new Date(), h = now.getHours();
    const d = new Date(now); d.setMinutes(0, 0, 0);
    switch (tierName) {
      case 'Common':    return d.getTime();
      case 'Uncommon':  { const u = new Date(d); u.setHours(h - h % 3); return u.getTime(); }
      case 'Rare':      { const r = new Date(d); r.setHours(h - h % 6); return r.getTime(); }
      case 'Epic':      { const e = new Date(d); e.setHours(h < 8 ? 0 : h < 16 ? 8 : 16); return e.getTime(); }
      case 'Legendary': { const l = new Date(d); l.setHours(h < 12 ? 0 : 12); return l.getTime(); }
      case 'Mythic':    { const m = new Date(d); m.setHours(0); return m.getTime(); }
    }
  }
  function isCollectedStillValid(tierName, collectedAt) {
    return collectedAt >= lastSpawnTime(tierName);
  }

  // â”€â”€ Levelling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function xpForLevel(n) { return n === 0 ? 30 : 50 * n; }

  function totalXPForLevel(n) {
    let total = 0;
    for (let i = 0; i < n; i++) total += xpForLevel(i);
    return total;
  }

  function getLevelFromXP(xp) {
    let lvl = 0, rem = xp;
    while (true) {
      const needed = xpForLevel(lvl);
      if (rem < needed) break;
      rem -= needed; lvl++;
    }
    return { level: lvl, rem, needed: xpForLevel(lvl) };
  }

  function updateLevelUI(totalXP, prevLevel) {
    const { level, rem, needed } = getLevelFromXP(totalXP);
    const base = totalXPForLevel(level);
    document.getElementById('levelText').textContent =
      `Lv. ${level}  ${base + rem}/${base + needed} XP`;
    document.getElementById('levelBar').style.width = Math.round(rem / needed * 100) + '%';
    if (prevLevel !== undefined && level > prevLevel) showLevelUpToast(level);
    return level;
  }

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let toastTimer;
  function showToast(text, bg, fg = '#111') {
    const el = document.getElementById('toast');
    el.textContent = text;
    el.style.display = 'block';
    el.style.background = bg;
    el.style.color = fg;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.style.display = 'none', 2500);
  }
  function showLevelUpToast(level) { showToast(`ðŸŽ‰ Level up! You are now Lv. ${level}`, '#e6b84a'); }
  function showChestToast(tier, xp) { showToast(`âœ¨ ${tier.name} chest â€” +${xp} XP`, tier.color, tier.name === 'Common' ? '#eee' : '#111'); }

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const params = new URLSearchParams(window.location.search);
  const locParam = params.get('home');

  function setHomeParam(lat, lng) {
    const url = new URL(window.location.href);
    url.searchParams.set('home', encodeLocation(lat, lng));
    window.history.replaceState({}, '', url);
    return { lat, lng };
  }

  function boot(home) {
    document.getElementById('gpsOverlay').style.display = 'none';
    initMap(home);
  }

  if (locParam) {
    boot(decodeLocation(locParam) || setHomeParam(41.9028, 12.4964));
  } else {
    document.getElementById('gpsOverlay').style.display = 'flex';
    navigator.geolocation.getCurrentPosition(
      p => boot(setHomeParam(p.coords.latitude, p.coords.longitude)),
      ()  => boot(setHomeParam(41.9028, 12.4964)),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  // â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initMap(HOME) {
    const SEED = 42, CHEST_COUNT = 10000, RADIUS = 0.1, RENDER_LIMIT = 400, PICKUP_RADIUS = 30;

    const rng = seededRNG(SEED);
    const chests = [], tierCounts = {};
    TIERS.forEach(t => tierCounts[t.name] = 0);

    for (let i = 0; i < CHEST_COUNT; i++) {
      const tier = getTier(i);
      let dlat, dlng, r2;
      const min2 = tier.minR * tier.minR;
      do {
        dlat = (rng() * 2 - 1) * RADIUS;
        dlng = (rng() * 2 - 1) * RADIUS;
        r2 = dlat * dlat + dlng * dlng;
      } while (r2 > RADIUS * RADIUS || r2 < min2);
      tierCounts[tier.name]++;
      const xp = Math.round(tier.minXP + rng() * (tier.maxXP - tier.minXP));
      chests.push({ lat: HOME.lat + dlat, lng: HOME.lng + dlng, id: i, tier, xp, collected: false });
    }

    // Load save
    const savedData = JSON.parse(localStorage.getItem('treasurehunt') || '{}');
    const collectedMap = savedData.collected || {};
    let collected = 0, totalXP = savedData.totalXP || 0;

    function saveProgress() {
      localStorage.setItem('treasurehunt', JSON.stringify({ collected: collectedMap, totalXP }));
    }

    for (const c of chests) {
      const ts = collectedMap[c.id];
      if (ts && isCollectedStillValid(c.tier.name, ts)) { c.collected = true; collected++; }
    }

    document.getElementById('collectedCount').textContent = `${collected} collected`;
    let currentLevel = updateLevelUI(totalXP);

    // Map
    const map = L.map('map', { center: [HOME.lat, HOME.lng], zoom: 15 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    map.on('mousemove', e => {
      document.getElementById('coords').textContent =
        `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    });

    // Legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const d = L.DomUtil.create('div');
      d.style.cssText = 'background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:10px 14px;font-family:Georgia,serif;font-size:0.75rem;color:#ccc;line-height:1.8;min-width:140px';
      d.innerHTML = '<div style="color:#e6b84a;font-size:0.7rem;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Chest Tiers</div>' +
        TIERS.map(t =>
          `<div><span style="background:${t.color};display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;box-shadow:0 0 5px ${t.color};vertical-align:middle"></span>${t.name}<span style="color:#555;float:right;margin-left:16px">${tierCounts[t.name]}</span></div>`
        ).join('');
      return d;
    };
    legend.addTo(map);

    // Player
    let playerMarker = null;

    function checkPickups(lat, lng) {
      let changed = false;
      for (const c of chests) {
        if (c.collected) continue;
        if (haversine(lat, lng, c.lat, c.lng) <= PICKUP_RADIUS) {
          c.collected = true;
          collectedMap[c.id] = Date.now();
          collected++;
          totalXP += c.xp;
          changed = true;
          saveProgress();
          showChestToast(c.tier, c.xp);
          currentLevel = updateLevelUI(totalXP, currentLevel);
          document.getElementById('collectedCount').textContent = `${collected} collected`;
        }
      }
      if (changed) renderChests();
    }

    navigator.geolocation.watchPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;
      if (!playerMarker) playerMarker = L.marker([lat, lng]).addTo(map).bindPopup('<b>You are here</b>');
      else playerMarker.setLatLng([lat, lng]);
      checkPickups(lat, lng);
    }, null, { enableHighAccuracy: true, maximumAge: 5000 });

    // Chests
    const chestLayer = L.layerGroup().addTo(map);

    function renderChests() {
      chestLayer.clearLayers();
      const b = map.getBounds().pad(0.1);
      const visible = chests.filter(c => !c.collected && b.contains([c.lat, c.lng]));
      const toRender = visible.slice(0, RENDER_LIMIT);
      toRender.forEach(c => {
        const t = c.tier;
        const icon = L.divIcon({
          html: `<div class="chest-dot" style="width:${t.size}px;height:${t.size}px;background:${t.color};--glow:${t.glow}"></div>`,
          className: '', iconSize: [t.size, t.size], iconAnchor: [t.size/2, t.size/2]
        });
        L.marker([c.lat, c.lng], { icon })
          .bindPopup(`<div class="popup-tier" style="color:${t.color}">${t.name}</div><div class="popup-id">Chest #${c.id + 1} Â· ${c.xp} XP</div>`)
          .addTo(chestLayer);
      });
      document.getElementById('visibleCount') &&
        (document.getElementById('visibleCount').textContent =
          visible.length > RENDER_LIMIT ? `${toRender.length}/${visible.length} shown` : `${visible.length} in view`);
    }

    map.on('moveend', renderChests);
    map.on('zoomend', renderChests);
    renderChests();

    // URL generator
    const urlBox = document.getElementById('urlBox'), urlOut = document.getElementById('urlOut');
    map.on('contextmenu', e => {
      urlOut.value = `${location.origin}${location.pathname}?home=${encodeLocation(e.latlng.lat, e.latlng.lng)}`;
      urlBox.style.display = 'flex';
    });
    document.getElementById('copyBtn').onclick = () => {
      navigator.clipboard.writeText(urlOut.value);
      document.getElementById('copyBtn').textContent = 'Copied!';
      setTimeout(() => document.getElementById('copyBtn').textContent = 'Copy', 1500);
    };
    document.getElementById('closeUrl').onclick = () => urlBox.style.display = 'none';
  }
</script>
</body>
</html>
