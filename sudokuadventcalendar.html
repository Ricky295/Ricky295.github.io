<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sudoku Advent Calendar</title>
<style>
:root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #8bc34a;
    --danger: #ff5252;
    --gold: #ffd700;
    --silver: #c0c0c0;
    --bronze: #cd7f32;
    --card-bg: #ffffff;
    --text: #1a1a2e;
    --panel-bg: rgba(255, 255, 255, 0.9);
    --highlight-bg: #e2e8f0;
    --same-num-bg: #cbd5e1;
}

body.dark {
    --card-bg: #16213e;
    --text: #e8e8e8;
    --panel-bg: rgba(15, 52, 96, 0.95);
    --highlight-bg: #2d3748;
    --same-num-bg: #4a5568;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { 
    font-family: 'Segoe UI', system-ui, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    padding: 10px; 
    transition: all 0.3s;
    color: var(--text);
}
body.dark { background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%); }

.dashboard {
    display: flex;
    width: 100%;
    max-width: 1100px;
    height: 90vh;
    background: var(--panel-bg);
    border-radius: 30px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.hero-side {
    flex: 1;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border-right: 1px solid rgba(0,0,0,0.1);
}
body.dark .hero-side { border-right: 1px solid rgba(255,255,255,0.1); }

.date-display h1 { font-size: 3.5rem; margin-bottom: 10px; }
.countdown { font-size: 1.5rem; opacity: 0.8; font-weight: 300; }

.level-system { margin-top: auto; }
.level-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
.progress-container { height: 35px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; position: relative; border: 2px solid var(--text); }
.progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 1s ease-out; }

.grid-side {
    flex: 1.2;
    padding: 40px;
    overflow-y: auto;
    background: rgba(255,255,255,0.3);
    scroll-behavior: smooth;
}
body.dark .grid-side { background: rgba(0,0,0,0.1); }

/* Year Sections */
.year-section { margin-bottom: 50px; }
.year-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-end; 
    margin-bottom: 15px; 
    border-bottom: 2px solid var(--text); 
    padding-bottom: 10px; 
}
.year-title { font-size: 2rem; font-weight: 800; }
.year-points { font-weight: bold; opacity: 0.8; }
.bonus-math { color: var(--success); font-weight: 500; font-size: 0.9rem; }

.mini-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
.mini-day { 
    aspect-ratio: 1; 
    background: var(--card-bg); 
    border: 2px solid var(--text); 
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    font-weight: bold;
    font-size: 1rem;
    transition: transform 0.2s, background 0.2s;
    position: relative;
}
.mini-day:hover:not(.locked) { transform: scale(1.1); z-index: 2; background: var(--primary); color: white; }
.mini-day.locked { opacity: 0.3; cursor: not-allowed; }
.mini-day.done { background: var(--success); }
.mini-day.medal-ü•á { background: var(--gold); color: #000; border-color: #b8860b; }
.mini-day.medal-ü•à { background: var(--silver); color: #000; border-color: #808080; }
.mini-day.medal-ü•â { background: var(--bronze); color: #000; border-color: #8b4513; }
.pts-label { font-size: 0.6rem; margin-top: 2px; opacity: 0.8; }

/* Puzzle Overlay & Grid */
.puzzle-overlay {
    position: absolute;
    inset: 0;
    background: var(--card-bg);
    z-index: 50;
    display: none;
    padding: 20px;
    flex-direction: column;
    overflow-y: auto;
}
.puzzle-overlay.show { display: flex; }

.timer-box { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 5px 0; font-size: 1.1rem; }
#timer { font-weight: bold; min-width: 60px; text-align: center; }

.grid-container { position: relative; max-width: 600px; width: 100%; margin: 5px auto; }
.grid { display: grid; grid-template-columns: repeat(9, 1fr); width: 100%; border: 3px solid #333; }
.cell { aspect-ratio: 1; border: 0.5px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; background: var(--card-bg); position: relative; }
.cell.given { background: rgba(0,0,0,0.05); font-weight: bold; }
.cell.highlight { background: var(--highlight-bg); }
.cell.same-num { background: var(--same-num-bg); }
.cell.sel { background: var(--primary) !important; color: white !important; z-index: 2; }
.cell.err { color: var(--danger); font-weight: bold; }
.cell:nth-child(3n) { border-right: 3px solid #333; }
.cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 3px solid #333; }

.candidate-grid { display: grid; grid-template-columns: repeat(3, 1fr); width: 100%; height: 100%; padding: 2px; }
.candidate-num { font-size: 0.65rem; display: flex; align-items: center; justify-content: center; color: #666; }
body.dark .candidate-num { color: #aaa; }
.cell.sel .candidate-num { color: white; }

.paused-overlay { position: absolute; inset: 0; background: var(--card-bg); z-index: 10; display: none; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; }
.paused-overlay.show { display: flex; }

.utility-bar { display: flex; justify-content: center; gap: 10px; max-width: 600px; margin: 0 auto 5px auto; width: 100%; }
.btn-util { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--primary); background: transparent; color: var(--primary); font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
.btn-util:hover { background: var(--primary); color: white; }

.numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 600px; margin: 10px auto; width:100%; }
.numpad button { padding: 10px; border-radius: 12px; border: 1px solid #ccc; background: var(--card-bg); color: var(--text); cursor: pointer; font-weight: bold; font-size: 1.2rem; }

.top-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
.btn-round { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: var(--card-bg); padding: 40px; border-radius: 20px; text-align: center; max-width: 420px; width: 90%; position: relative; max-height: 90vh; overflow-y: auto; }

.breakdown { text-align: left; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 15px; }
.breakdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
.bonus-text { color: var(--success); }

.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.toast.show { opacity: 1; }

.mode-toggle-bar { display:flex; gap:10px; max-width:600px; margin: 0 auto; width:100%; }
.mode-btn { flex:1; padding:12px; border-radius:12px; border:2px solid var(--primary); font-weight:bold; cursor:pointer; transition: 0.2s; }

@media (max-width: 650px) {
    .dashboard { flex-direction: column; height: auto; }
    .hero-side { border-right: none; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .grid-container { max-width: 95vw; }
    .cell { font-size: 1.4rem; }
    .mini-grid { grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>
<body class="light">

<div class="top-controls">
    <button class="btn-round" title="Toggle Theme" onclick="toggleDark()">üåì</button>
    <button class="btn-round" title="Account Settings" onclick="openSettings()">‚öôÔ∏è</button>
</div>

<div class="dashboard" id="mainDashboard">
    <div class="hero-side">
        <div class="date-display">
            <h1 id="todayDate">...</h1>
            <div class="countdown" id="countdown">...</div>
        </div>
        <div class="level-system">
            <div class="level-info"><span id="levelText">Level 1</span><span id="pointsLabel">0 / 1,000 pts</span></div>
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        </div>
    </div>
    <div class="grid-side" id="yearGrids">
        <!-- Years will be injected here vertically -->
    </div>
</div>

<div class="puzzle-overlay" id="puzzleOverlay">
    <div onclick="closePuzzle()" style="cursor:pointer; font-weight:bold; color:var(--primary); margin-bottom:5px;">‚Üê Back</div>
    
    <div id="puzzleHeader" style="text-align:center;">
        <h3 id="puzzleTitle" style="font-size: 1.1rem;">Day X</h3>
        <div class="timer-box">
            <span id="timer">0:00</span>
            <button class="btn-util" id="pauseBtn" onclick="togglePause()">‚è∏ PAUSE</button>
        </div>
    </div>

    <div class="utility-bar">
        <button class="btn-util" onclick="manualCheck()">üîç CHECK</button>
        <button class="btn-util" id="helpBtn" onclick="openHelp()">‚ùì HELP</button>
        <button class="btn-util" onclick="sharePuzzle()">üîó SHARE</button>
        <div style="flex-grow:1; text-align:right; font-size:0.75rem; opacity:0.7; align-self:center;" id="targetDisplay">Staff: 0:00</div>
    </div>

    <div class="grid-container">
        <div class="paused-overlay" id="pausedOverlay">GAME PAUSED</div>
        <div class="grid" id="gameGrid"></div>
    </div>

    <div class="numpad" id="numpad"></div>
    
    <div class="mode-toggle-bar">
        <button onclick="setMode(0)" id="mode0" class="mode-btn" style="background:var(--primary); color:white;">NUMBER</button>
        <button onclick="setMode(1)" id="mode1" class="mode-btn" style="background:transparent; color:var(--primary);">PENCIL</button>
    </div>
</div>

<div class="modal" id="statsModal"></div>
<div class="modal" id="winModal"></div>
<div class="modal" id="settingsModal"></div>
<div class="toast" id="toast">Link copied!</div>

<script>
const KEY = "do7'eggs";
const NAMES = ["Hidden Single (Box) - Easy","Hidden Single (Box) - Hard","Hidden Single (Line) - Easy","Hidden Single (Line) - Hard","Locked Candidate - Easy","Locked Candidate - Hard","Naked Single - Easy","Naked Single - Hard","Naked Pair - Easy","Naked Pair - Hard","Hidden Pair - Easy","Hidden Pair - Hard","X-Wing - Easy","X-Wing - Hard","Skyscraper - Easy","Skyscraper - Hard","2-String Kite - Easy","2-String Kite - Hard","Y-Wing","XYZ-Wing","W-Wing","BUG+1","X-Chains","The Grand Finale"];

const HELP_LINKS = { "Hidden Single": "hidden-single", "Locked Candidate": "locked-candidates", "Naked Single": "naked-single", "Naked Pair": "naked-pair", "Hidden Pair": "hidden-pair", "X-Wing": "x-wing", "Skyscraper": "skyscraper", "2-String Kite": "two-string-kite", "Y-Wing": "y-wing", "XYZ-Wing": "xyz-wing", "W-Wing": "w-wing", "BUG+1": "bug-plus-one", "X-Chains": "x-chain" };

// Multi-year data structure
let DATA = {
    "2026": Array(24).fill(["530070000600195000098000060800060003400803001700020006060000280000419005000080079", "534678912672195348198342567859761423426853791713924856961537284287419635345286179", "100"]),
    "2025": Array(24).fill(["530070000600195000098000060800060003400803001700020006060000280000419005000080079", "534678912672195348198342567859761423426853791713924856961537284287419635345286179", "120"])
};

let activePuzzle, grid, init, cand, sel, pencil=0, timer, start, totalElapsed = 0, isPaused = false, errs = new Set(), mistakeCount = 0;

async function initApp() {
    try {
        const res = await fetch('https://ricky295.github.io/puzzles.json');
        if (res.ok) DATA = await res.json();
    } catch(e) { console.warn("Using local data"); }
    
    updateDashboard();
    loadSettings();
    setupKeyListeners();
}

function setupKeyListeners() {
    window.addEventListener('keydown', (e) => {
        if (!document.getElementById('puzzleOverlay').classList.contains('show') || isPaused) return;
        if (e.key >= '1' && e.key <= '9') input(parseInt(e.key));
        else if (e.key === '0' || e.key === 'Backspace') input(0);
        if (e.key.toLowerCase() === 'p') setMode(pencil === 0 ? 1 : 0);
    });
}

function fmtTime(s) { return Math.floor(s/60) + ":" + (s%60).toString().padStart(2,'0'); }

function getLevelStats(totalPoints) {
    const n = (500 + Math.sqrt(250000 + 2000 * totalPoints)) / 1000;
    const currentLevel = Math.floor(n);
    const startOfLevelPts = 500 * (currentLevel - 1) * currentLevel;
    const endOfLevelPts = 500 * currentLevel * (currentLevel + 1);
    return { level: currentLevel, current: totalPoints - startOfLevelPts, totalRequired: endOfLevelPts - startOfLevelPts };
}

function updateDashboard() {
    const now = new Date();
    document.getElementById('todayDate').textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    
    // Countdown to next December
    let nextDec = new Date(now.getFullYear(), 11, 1);
    if (now > nextDec) nextDec.setFullYear(now.getFullYear() + 1);
    const diff = Math.ceil((nextDec - now) / (1000 * 60 * 60 * 24));
    document.getElementById('countdown').textContent = diff > 0 && diff < 30 ? `Begins in ${diff} days!` : `Enjoy the puzzles!`;

    const progress = JSON.parse(localStorage.getItem('sudokuProgress') || '{}');
    const container = document.getElementById('yearGrids');
    container.innerHTML = '';
    
    const years = Object.keys(DATA).sort((a,b) => b-a);
    let grandTotal = 0;

    years.forEach(yr => {
        let yrPts = 0, completedCount = 0;
        const yearData = progress[yr] || {};
        Object.keys(yearData).forEach(d => { yrPts += yearData[d].points || 0; completedCount++; });
        
        const bonus = (completedCount >= 24) ? 2000 : 0;
        grandTotal += (yrPts + bonus);

        const section = document.createElement('div');
        section.className = 'year-section';
        section.innerHTML = `
            <div class="year-header">
                <div class="year-title">${yr}</div>
                <div class="year-points">${bonus > 0 ? `<span class="bonus-math">${yrPts.toLocaleString()} + 2k = </span>` : ''}${(yrPts+bonus).toLocaleString()} pts</div>
            </div>
            <div class="mini-grid"></div>
        `;

        const miniGrid = section.querySelector('.mini-grid');
        for(let d=1; d<=24; d++) {
            const dayProg = yearData[d];
            const isLocked = (yr == now.getFullYear() && (now.getMonth() < 11 || d > now.getDate())) && localStorage.getItem('sudokuUnlock') !== KEY;
            const div = document.createElement('div');
            div.className = `mini-day ${isLocked ? 'locked' : ''} ${dayProg ? 'done medal-'+dayProg.medal : ''}`;
            div.innerHTML = `<span>${d}</span>${dayProg ? `<span class="pts-label">${dayProg.points}</span>` : ''}`;
            div.onclick = () => { if(!isLocked) dayProg ? showStats(yr, d) : startPuzzle(yr, d); };
            miniGrid.appendChild(div);
        }
        container.appendChild(section);
    });

    const stats = getLevelStats(grandTotal);
    document.getElementById('levelText').textContent = `Level ${stats.level}`;
    document.getElementById('pointsLabel').textContent = `${stats.current.toLocaleString()} / ${stats.totalRequired.toLocaleString()} pts`;
    document.getElementById('progressBar').style.width = `${Math.min(100, (stats.current / stats.totalRequired) * 100)}%`;
}

function showStats(yr, d) {
    const dayProg = JSON.parse(localStorage.getItem('sudokuProgress'))[yr][d];
    const m = document.getElementById('statsModal');
    m.innerHTML = `
        <div class="modal-content">
            <h1 style="font-size:3rem">${dayProg.medal}</h1>
            <h2>Day ${d} Summary (${yr})</h2>
            <div class="breakdown">
                <div class="breakdown-row"><span>Base Score:</span> <span>${dayProg.breakdown?.base}</span></div>
                <div class="breakdown-row"><span>Time Bonus:</span> <span class="bonus-text">+${dayProg.breakdown?.timeBonus}</span></div>
                <div class="breakdown-row"><span>Medal Bonus:</span> <span class="bonus-text">+${dayProg.breakdown?.medalBonus}</span></div>
                <div class="breakdown-row" style="border-top:2px solid var(--text); margin-top:10px; padding-top:5px; font-weight:bold;">
                    <span>Total Score:</span> <span>${dayProg.points} pts</span>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="startPuzzle('${yr}', ${d})" style="flex:1; padding:15px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">REPLAY</button>
                <button onclick="closeModals()" style="flex:1; padding:15px; border-radius:10px; border:1px solid #ccc; background:var(--card-bg); color:var(--text); font-weight:bold; cursor:pointer;">CLOSE</button>
            </div>
        </div>
    `;
    m.classList.add('show');
}

function startPuzzle(yr, d) {
    closeModals();
    const [pStr, sStr, staff] = DATA[yr][d-1];
    activePuzzle = { yr, d, sol: sStr.split('').map(Number), staff: parseInt(staff), name: NAMES[d-1] };
    init = pStr.split('').map(c => c==='0' ? 0 : Number(c));
    grid = [...init];
    cand = Array(81).fill(0).map(()=>[]);
    errs.clear();
    mistakeCount = 0; sel = 0; totalElapsed = 0; isPaused = false; start = Date.now();
    
    document.getElementById('puzzleTitle').textContent = `${yr} Dec ${d}: ${activePuzzle.name}`;
    document.getElementById('targetDisplay').textContent = `Staff: ${fmtTime(activePuzzle.staff)}`;
    document.getElementById('puzzleOverlay').classList.add('show');
    drawGame();
    drawNumpad();
    startTimer();
}

function startTimer() {
    if(timer) clearInterval(timer);
    timer = setInterval(() => {
        if(!isPaused) document.getElementById('timer').textContent = fmtTime(Math.floor((Date.now() - start)/1000) + totalElapsed);
    }, 1000);
}

function togglePause() {
    if(isPaused) { start = Date.now(); isPaused = false; document.getElementById('pausedOverlay').classList.remove('show'); document.getElementById('pauseBtn').textContent = "‚è∏ PAUSE"; }
    else { totalElapsed += Math.floor((Date.now() - start)/1000); isPaused = true; document.getElementById('pausedOverlay').classList.add('show'); document.getElementById('pauseBtn').textContent = "‚ñ∂ RESUME"; }
}

function drawGame() {
    const g = document.getElementById('gameGrid');
    g.innerHTML = '';
    const selVal = sel !== null ? grid[sel] : null;
    const selRow = sel !== null ? Math.floor(sel/9) : null, selCol = sel !== null ? sel % 9 : null;

    for(let i=0; i<81; i++) {
        const r = Math.floor(i/9), c = i % 9, val = grid[i];
        const cellEl = document.createElement('div');
        let classes = ['cell'];
        if(init[i]) classes.push('given');
        if(sel === i) classes.push('sel');
        if(errs.has(i)) classes.push('err');
        if(sel !== null && sel !== i) {
            if(r === selRow || c === selCol) classes.push('highlight');
            if(val !== 0 && val === selVal) classes.push('same-num');
        }
        cellEl.className = classes.join(' ');

        if(init[i] || val) {
            cellEl.textContent = val;
        } else {
            const candDiv = document.createElement('div');
            candDiv.className = 'candidate-grid';
            for(let n=1; n<=9; n++) {
                const s = document.createElement('div');
                s.className = 'candidate-num';
                s.textContent = cand[i].includes(n) ? n : '';
                candDiv.appendChild(s);
            }
            cellEl.appendChild(candDiv);
        }
        cellEl.onclick = () => { if(!isPaused) { sel = i; drawGame(); } };
        g.appendChild(cellEl);
    }
}

function input(n) {
    if(sel === null || init[sel] || isPaused) return;
    if(pencil && n !== 0) {
        const idx = cand[sel].indexOf(n);
        if(idx > -1) cand[sel].splice(idx, 1);
        else cand[sel].push(n);
    } else {
        grid[sel] = n; cand[sel] = []; errs.delete(sel);
    }
    drawGame();
    if(!grid.includes(0)) autoCheck();
}

function autoCheck() {
    let wrong = 0;
    for(let i=0; i<81; i++) if(grid[i] !== 0 && grid[i] !== activePuzzle.sol[i]) { errs.add(i); wrong++; }
    if(wrong === 0) win();
    else { mistakeCount += wrong; showToast(`${wrong} mistakes!`); drawGame(); }
}

function win() {
    clearInterval(timer);
    const rawTime = Math.floor((Date.now() - start)/1000) + totalElapsed;
    const finalTime = rawTime + (mistakeCount * 10 * activePuzzle.d);
    const ratio = finalTime / activePuzzle.staff;
    const base = (activePuzzle.d === 24) ? 500 : (activePuzzle.d * 10);
    const timeBonus = Math.max(0, Math.floor((activePuzzle.staff / finalTime) * 1000));
    let medal = '‚úÖ', medalBonus = 0;
    if(ratio <= 1.0) { medal = 'ü•á'; medalBonus = 300; }
    else if(ratio <= 1.5) { medal = 'ü•à'; medalBonus = 200; }
    else if(ratio <= 2.0) { medal = 'ü•â'; medalBonus = 100; }
    let totalPts = base + timeBonus + medalBonus;

    const prog = JSON.parse(localStorage.getItem('sudokuProgress') || '{}');
    if(!prog[activePuzzle.yr]) prog[activePuzzle.yr] = {};
    if(!prog[activePuzzle.yr][activePuzzle.d] || totalPts > prog[activePuzzle.yr][activePuzzle.d].points) {
        prog[activePuzzle.yr][activePuzzle.d] = { points: totalPts, medal, breakdown: { base, timeBonus, medalBonus } };
        localStorage.setItem('sudokuProgress', JSON.stringify(prog));
    }

    const m = document.getElementById('winModal');
    m.innerHTML = `
        <div class="modal-content">
            <h1 style="font-size:4rem">${medal}</h1>
            <h2>Solved!</h2>
            <p>Score: ${totalPts} pts</p>
            <button onclick="closePuzzle()" style="width:100%; padding:15px; margin-top:20px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Return to Calendar</button>
        </div>
    `;
    m.classList.add('show');
}

function drawNumpad() {
    const n = document.getElementById('numpad');
    n.innerHTML = '';
    for(let i=1; i<=9; i++) {
        const b = document.createElement('button');
        b.textContent = i;
        b.onclick = () => input(i);
        n.appendChild(b);
    }
    const del = document.createElement('button');
    del.textContent = '‚å´';
    del.onclick = () => input(0);
    n.appendChild(del);
}

function setMode(m) {
    pencil = m;
    document.getElementById('mode0').style.background = m ? 'transparent' : 'var(--primary)';
    document.getElementById('mode0').style.color = m ? 'var(--primary)' : 'white';
    document.getElementById('mode1').style.background = m ? 'var(--primary)' : 'transparent';
    document.getElementById('mode1').style.color = m ? 'white' : 'var(--primary)';
}

function manualCheck() {
    let wrong = 0;
    for(let i=0; i<81; i++) if(grid[i] !== 0 && grid[i] !== activePuzzle.sol[i]) { errs.add(i); wrong++; }
    if(wrong > 0) { mistakeCount += wrong; showToast(`Found ${wrong} errors!`); }
    else showToast("No errors!");
    drawGame();
}

function openSettings() {
    const m = document.getElementById('settingsModal');
    m.innerHTML = `
        <div class="modal-content">
            <h2>Settings</h2>
            <button onclick="localStorage.removeItem('sudokuProgress'); location.reload();" class="btn-util" style="width:100%; margin-top:20px; background:var(--danger); color:white; border:none;">Reset All Data</button>
            <button onclick="closeModals()" class="btn-util" style="width:100%; margin-top:10px;">Close</button>
        </div>
    `;
    m.classList.add('show');
}

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }
function closePuzzle() { document.getElementById('puzzleOverlay').classList.remove('show'); updateDashboard(); }
function toggleDark() { document.body.classList.toggle('dark'); localStorage.setItem('sudokuDark', document.body.classList.contains('dark')); }
function loadSettings() { if(localStorage.getItem('sudokuDark') === 'true') document.body.classList.add('dark'); }
function showToast(msg) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); }
function sharePuzzle() { showToast("Link copied!"); }
function openHelp() { window.open(`https://sudoku.coach/en/learn`, '_blank'); }

initApp();
</script>
</body>
</html>
